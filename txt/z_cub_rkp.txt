z_cub_rkp11:--z_cub_rkp11	營業成本表
	SET QUOTED_IDENTIFIER OFF 
	declare @cmd nvarchar(max)
	declare @t_path nvarchar(max) = '[1]'
	declare @t_db nvarchar(max) = '[2]'
	
	declare @t_bdate nvarchar(max) = case when '#non' = [4] then '' else [4] end
	declare @t_edate nvarchar(max) = case when '#non' = [5] then char(255) else [5] end
	----------------------------------------------------------------------------------------------------------
	declare @tmpKind table(
		kind nvarchar(20)
		,product nvarchar(50)
	)
	insert into @tmpKind(kind,product)
	select 'A1','金屬底材'
	union
	select 'A4','皮膜'
	union
	select 'A5','保護膜'
	union
	select 'A6','物料'
	union
	select 'A7','成品'
	union
	select 'A8','溶劑'
	--------------------------------------------------------------------------------------------------
--============================================================================================	
	-- 原物料
--============================================================================================
	IF OBJECT_ID('tempdb..#z_cub_rkp08a')is not null
	BEGIN
		drop table #z_cub_rkp08a
	END
	select * into #z_cub_rkp08a from [dbo].[material_rk](@t_bdate,@t_edate,'','','z')
	declare @tmp table(
		sel int identity(1,1)
		,gno nvarchar(10)
		,attr nvarchar(10)
		,typea nvarchar(20)
		,kind nvarchar(20)
		,product nvarchar(20)
		,itemno nvarchar(20)
		,item nvarchar(50)
		,[mount] float
		,[weight] float
		,[price] float
		,[money] float
	)
	--期初存貨 1
	insert into @tmp(gno,attr,typea,kind,product,itemno,item,mount,[weight],[money])
	select  '1','1'
		,case when (ISNULL(a.weight01,0)>0 and ISNULL(a.price01,0)=0) or (ISNULL(a.weight12,0)>0 and ISNULL(a.price12,0)=0) then '客供' else '' end
		,ISNULL(b.kind,''),ISNULL(c.product,'')
		,'A01' 
		,'期初' 
		,sum(isnull(a.mount01,0)),sum(isnull(a.weight01,0)),sum(isnull(a.total01,0))
	from #z_cub_rkp08a a
	left join view_uccb b on a.uno=b.uno
	left join @tmpKind c on b.kind=c.kind
	group by case when (ISNULL(a.weight01,0)>0 and ISNULL(a.price01,0)=0) or (ISNULL(a.weight12,0)>0 and ISNULL(a.price12,0)=0) then '客供' else '' end
		,ISNULL(b.kind,''),ISNULL(c.product,'')
	--盤點調整 2
	insert into @tmp(gno,attr,typea,kind,product,itemno,item,mount,[weight],[money])
	select  '1','1'
		,case when (ISNULL(a.weight01,0)>0 and ISNULL(a.price01,0)=0) or (ISNULL(a.weight12,0)>0 and ISNULL(a.price12,0)=0) then '客供' else '' end
		,ISNULL(b.kind,''),ISNULL(c.product,''),'A02','盤點'
		,sum(isnull(a.mount02,0)),sum(isnull(a.weight02,0)),sum(isnull(a.total02,0))
	from #z_cub_rkp08a a
	left join view_uccb b on a.uno=b.uno
	left join @tmpKind c on b.kind=c.kind
	group by case when (ISNULL(a.weight01,0)>0 and ISNULL(a.price01,0)=0) or (ISNULL(a.weight12,0)>0 and ISNULL(a.price12,0)=0) then '客供' else '' end
		,ISNULL(b.kind,''),ISNULL(c.product,'')
	--本期購入3
	insert into @tmp(gno,attr,typea,kind,product,itemno,item,mount,[weight],[money])
	select  '1','1'
		,case when (ISNULL(a.weight01,0)>0 and ISNULL(a.price01,0)=0) or (ISNULL(a.weight12,0)>0 and ISNULL(a.price12,0)=0) then '客供' else '' end
		,ISNULL(b.kind,''),ISNULL(c.product,''),'A03','購入'
		,sum(isnull(a.mount03,0)),sum(isnull(a.weight03,0)),sum(isnull(a.total03,0))
	from #z_cub_rkp08a a
	left join view_uccb b on a.uno=b.uno
	left join @tmpKind c on b.kind=c.kind
	group by case when (ISNULL(a.weight01,0)>0 and ISNULL(a.price01,0)=0) or (ISNULL(a.weight12,0)>0 and ISNULL(a.price12,0)=0) then '客供' else '' end
		,ISNULL(b.kind,''),ISNULL(c.product,'')
	
	--本期領料 5
	insert into @tmp(gno,attr,typea,kind,product,itemno,item,mount,[weight],[money])
	select  '1','1'
		,case when (ISNULL(a.weight01,0)>0 and ISNULL(a.price01,0)=0) or (ISNULL(a.weight12,0)>0 and ISNULL(a.price12,0)=0) then '客供' else '' end
		,ISNULL(b.kind,''),ISNULL(c.product,''),'B05','領料'
		,sum(isnull(a.mount05,0)),sum(isnull(a.weight05,0)),sum(isnull(a.total05,0))
	from #z_cub_rkp08a a
	left join view_uccb b on a.uno=b.uno
	left join @tmpKind c on b.kind=c.kind
	group by case when (ISNULL(a.weight01,0)>0 and ISNULL(a.price01,0)=0) or (ISNULL(a.weight12,0)>0 and ISNULL(a.price12,0)=0) then '客供' else '' end
		,ISNULL(b.kind,''),ISNULL(c.product,'')
	--本期自調入 6
	insert into @tmp(gno,attr,typea,kind,product,itemno,item,mount,[weight],[money])
	select  '1','1'
		,case when (ISNULL(a.weight01,0)>0 and ISNULL(a.price01,0)=0) or (ISNULL(a.weight12,0)>0 and ISNULL(a.price12,0)=0) then '客供' else '' end
		,ISNULL(b.kind,''),ISNULL(c.product,''),'A06','自調入'
		,sum(isnull(a.mount06,0)),sum(isnull(a.weight06,0)),sum(isnull(a.total06,0))
	from #z_cub_rkp08a a
	left join view_uccb b on a.uno=b.uno
	left join @tmpKind c on b.kind=c.kind
	group by case when (ISNULL(a.weight01,0)>0 and ISNULL(a.price01,0)=0) or (ISNULL(a.weight12,0)>0 and ISNULL(a.price12,0)=0) then '客供' else '' end
		,ISNULL(b.kind,''),ISNULL(c.product,'')
	--本期自調用料 7
	insert into @tmp(gno,attr,typea,kind,product,itemno,item,mount,[weight],[money])
	select  '1','1'
		,case when (ISNULL(a.weight01,0)>0 and ISNULL(a.price01,0)=0) or (ISNULL(a.weight12,0)>0 and ISNULL(a.price12,0)=0) then '客供' else '' end
		,ISNULL(b.kind,''),ISNULL(c.product,''),'B07','自調用料'
		,sum(isnull(a.mount07,0)),sum(isnull(a.weight07,0)),sum(isnull(a.total07,0))
	from #z_cub_rkp08a a
	left join view_uccb b on a.uno=b.uno
	left join @tmpKind c on b.kind=c.kind
	group by case when (ISNULL(a.weight01,0)>0 and ISNULL(a.price01,0)=0) or (ISNULL(a.weight12,0)>0 and ISNULL(a.price12,0)=0) then '客供' else '' end
		,ISNULL(b.kind,''),ISNULL(c.product,'')
	--本期銷貨 8
	insert into @tmp(gno,attr,typea,kind,product,itemno,item,mount,[weight],[money])
	select  '1','1'
		,case when (ISNULL(a.weight01,0)>0 and ISNULL(a.price01,0)=0) or (ISNULL(a.weight12,0)>0 and ISNULL(a.price12,0)=0) then '客供' else '' end
		,ISNULL(b.kind,''),ISNULL(c.product,''),'B08','銷貨'
		,sum(isnull(a.mount08,0)),sum(isnull(a.weight08,0)),sum(isnull(a.total08,0))
	from #z_cub_rkp08a a
	left join view_uccb b on a.uno=b.uno
	left join @tmpKind c on b.kind=c.kind
	group by case when (ISNULL(a.weight01,0)>0 and ISNULL(a.price01,0)=0) or (ISNULL(a.weight12,0)>0 and ISNULL(a.price12,0)=0) then '客供' else '' end
		,ISNULL(b.kind,''),ISNULL(c.product,'')
	--本期銷貨退回	9
	insert into @tmp(gno,attr,typea,kind,product,itemno,item,mount,[weight],[money])
	select  '1','1'
		,case when (ISNULL(a.weight01,0)>0 and ISNULL(a.price01,0)=0) or (ISNULL(a.weight12,0)>0 and ISNULL(a.price12,0)=0) then '客供' else '' end
		,ISNULL(b.kind,''),ISNULL(c.product,''),'A09','銷貨退回'
		,sum(isnull(a.mount09,0)),sum(isnull(a.weight09,0)),sum(isnull(a.total09,0))
	from #z_cub_rkp08a a
	left join view_uccb b on a.uno=b.uno
	left join @tmpKind c on b.kind=c.kind
	group by case when (ISNULL(a.weight01,0)>0 and ISNULL(a.price01,0)=0) or (ISNULL(a.weight12,0)>0 and ISNULL(a.price12,0)=0) then '客供' else '' end
		,ISNULL(b.kind,''),ISNULL(c.product,'')
	--本期報廢 10
	insert into @tmp(gno,attr,typea,kind,product,itemno,item,mount,[weight],[money])
	select  '1','1'
		,case when (ISNULL(a.weight01,0)>0 and ISNULL(a.price01,0)=0) or (ISNULL(a.weight12,0)>0 and ISNULL(a.price12,0)=0) then '客供' else '' end
		,ISNULL(b.kind,''),ISNULL(c.product,''),'B10','報廢'
		,sum(isnull(a.mount10,0)),sum(isnull(a.weight10,0)),sum(isnull(a.total10,0))
	from #z_cub_rkp08a a
	left join view_uccb b on a.uno=b.uno
	left join @tmpKind c on b.kind=c.kind
	group by case when (ISNULL(a.weight01,0)>0 and ISNULL(a.price01,0)=0) or (ISNULL(a.weight12,0)>0 and ISNULL(a.price12,0)=0) then '客供' else '' end
		,ISNULL(b.kind,''),ISNULL(c.product,'')
	--本期退料 11
	insert into @tmp(gno,attr,typea,kind,product,itemno,item,mount,[weight],[money])
	select  '1','1'
		,case when (ISNULL(a.weight01,0)>0 and ISNULL(a.price01,0)=0) or (ISNULL(a.weight12,0)>0 and ISNULL(a.price12,0)=0) then '客供' else '' end
		,ISNULL(b.kind,''),ISNULL(c.product,''),'B11','退料'
		,sum(isnull(a.mount11,0)),sum(isnull(a.weight11,0)),sum(isnull(a.total11,0))
	from #z_cub_rkp08a a
	left join view_uccb b on a.uno=b.uno
	left join @tmpKind c on b.kind=c.kind
	group by case when (ISNULL(a.weight01,0)>0 and ISNULL(a.price01,0)=0) or (ISNULL(a.weight12,0)>0 and ISNULL(a.price12,0)=0) then '客供' else '' end
		,ISNULL(b.kind,''),ISNULL(c.product,'')
	--期末存貨 12
	insert into @tmp(gno,attr,typea,kind,product,itemno,item,mount,[weight],[money])
	select  '1','1'
		,case when (ISNULL(a.weight01,0)>0 and ISNULL(a.price01,0)=0) or (ISNULL(a.weight12,0)>0 and ISNULL(a.price12,0)=0) then '客供' else '' end
		,ISNULL(b.kind,''),ISNULL(c.product,''),'C12','期末存貨'
		,sum(isnull(a.mount12,0)),sum(isnull(a.weight12,0)),sum(isnull(a.total12,0))
	from #z_cub_rkp08a a
	left join view_uccb b on a.uno=b.uno
	left join @tmpKind c on b.kind=c.kind
	group by case when (ISNULL(a.weight01,0)>0 and ISNULL(a.price01,0)=0) or (ISNULL(a.weight12,0)>0 and ISNULL(a.price12,0)=0) then '客供' else '' end
		,ISNULL(b.kind,''),ISNULL(c.product,'')
	--本期耗料 4
	insert into @tmp(gno,attr,typea,kind,product,itemno,item,mount,[weight],[money])
	select  '2','1'
		,case when (ISNULL(a.weight01,0)>0 and ISNULL(a.price01,0)=0) or (ISNULL(a.weight12,0)>0 and ISNULL(a.price12,0)=0) then '客供' else '' end
		,ISNULL(b.kind,''),ISNULL(c.product,''),'D01','耗料'
		,sum(isnull(a.mount04,0)),sum(isnull(a.weight04,0)),sum(isnull(a.total04,0))
	from #z_cub_rkp08a a
	left join view_uccb b on a.uno=b.uno
	left join @tmpKind c on b.kind=c.kind
	group by case when (ISNULL(a.weight01,0)>0 and ISNULL(a.price01,0)=0) or (ISNULL(a.weight12,0)>0 and ISNULL(a.price12,0)=0) then '客供' else '' end
		,ISNULL(b.kind,''),ISNULL(c.product,'')
	--------------------------------------------------------------------------------------------------
	delete @tmp where mount=0 and [weight]=0 and [money]=0 and itemno!='D01'  --耗料還是要顯示
	--------------------------------------------------------------------------------------------------
--============================================================================================
	-- 在製品
--============================================================================================
	IF OBJECT_ID('tempdb..#z_cub_rkp08b')is not null
	BEGIN
		drop table #z_cub_rkp08b
	END
	select * into #z_cub_rkp08b from [dbo].[unfinished_rk](@t_bdate,@t_edate)

	--期初
	insert into @tmp(gno,attr,typea,kind,product,itemno,item,[weight],[money])
	select '1','2' attr,'' typea,'' kind,'在製品' product,'A01' itemno,'期初' item
		,sum(isnull(a.[weight01],0)),sum(isnull(a.[total01],0))
	from #z_cub_rkp08b a
	--完工投入 
	insert into @tmp(gno,attr,typea,kind,product,itemno,item,[weight],[money])
	select '1','2' attr,'' typea,'' kind,'在製品' product,'A01' itemno,'完工投入' item
		,sum(isnull(a.[weight03],0)),sum(isnull(a.[total03],0))
	from #z_cub_rkp08b a
	--期末
	insert into @tmp(gno,attr,typea,kind,product,itemno,item,[weight],[money])
	select '1','2' attr,'' typea,'' kind,'在製品' product,'C01' itemno,'期末' item
		,sum(isnull(a.[weight07],0)),sum(isnull(a.[total07],0))
	from #z_cub_rkp08b a
	--耗料
	insert into @tmp(gno,attr,typea,kind,product,itemno,item,[weight],[money])
	select '2','2' attr,'' typea,'' kind,'在製品' product,'A01' itemno,'耗料' item
		,sum(isnull(a.[weight04],0)),sum(isnull(a.[total04],0))
	from #z_cub_rkp08b a
	---------------------------------------------------------------------------
--============================================================================================
	--製成品
--============================================================================================	
	IF OBJECT_ID('tempdb..#z_cub_rkp08c')is not null
	BEGIN
		drop table #z_cub_rkp08c
	END
	select * into #z_cub_rkp08c from [dbo].[finished_rk](@t_bdate,@t_edate)
	
	--select * from #z_cub_rkp08c
	--select * from @tmp
	
	--期初
	insert into @tmp(gno,attr,typea,kind,product,itemno,item,[weight],[money])
	select '1','3' attr,'' typea,'' kind,'製成品' product,'A01' itemno,'期初' item
		,sum(isnull(a.[w01],0)),sum(isnull(a.[m01],0))
	from #z_cub_rkp08c a
	
	--本月生產	
	insert into @tmp(gno,attr,typea,kind,product,itemno,item,[weight],[money])
	select '1','3' attr,'' typea,'' kind,'製成品' product,'A01' itemno,'本月生產' item
		,sum(isnull(a.[w02],0)),sum(isnull(a.[m02],0))
	from #z_cub_rkp08c a		
	--盤點調整			
	insert into @tmp(gno,attr,typea,kind,product,itemno,item,[weight],[money])
	select '1','3' attr,'' typea,'' kind,'製成品' product,'A01' itemno,'盤點調整' item
		,sum(isnull(a.[w03],0)),sum(isnull(a.[m03],0))
	from #z_cub_rkp08c a
	--本期領料			
	insert into @tmp(gno,attr,typea,kind,product,itemno,item,[weight],[money])
	select '1','3' attr,'' typea,'' kind,'製成品' product,'A01' itemno,'本期領料' item
		,sum(isnull(a.[w04],0)),sum(isnull(a.[m04],0))
	from #z_cub_rkp08c a
	--本期報廢			
	insert into @tmp(gno,attr,typea,kind,product,itemno,item,[weight],[money])
	select '1','3' attr,'' typea,'' kind,'製成品' product,'A01' itemno,'本期報廢' item
		,sum(isnull(a.[w05],0)),sum(isnull(a.[m05],0))
	from #z_cub_rkp08c a
	--銷貨退回			
	insert into @tmp(gno,attr,typea,kind,product,itemno,item,[weight],[money])
	select '1','3' attr,'' typea,'' kind,'製成品' product,'A01' itemno,'銷貨退回' item
		,sum(isnull(a.[w06],0)),sum(isnull(a.[m06],0))
	from #z_cub_rkp08c a
	--委外加工			
	insert into @tmp(gno,attr,typea,kind,product,itemno,item,[weight],[money])
	select '1','3' attr,'' typea,'' kind,'製成品' product,'A01' itemno,'委外加工' item
		,sum(isnull(a.[w07],0)),sum(isnull(a.[m07],0))
	from #z_cub_rkp08c a
	----本月銷售收入  			
	--insert into @tmp(gno,attr,typea,kind,product,itemno,item,[weight],[money])
	--select 1,'3' attr,'' typea,'' kind,'製成品' product,'A01' itemno,'委外加工' item
	--	,sum(isnull(a.[w08],0)),sum(isnull(a.[m08],0))
	--from #z_cub_rkp08c a
	--本月銷售成本		
	insert into @tmp(gno,attr,typea,kind,product,itemno,item,[weight],[money])
	select '1','3' attr,'' typea,'' kind,'製成品' product,'A01' itemno,'銷售' item
		,sum(isnull(a.[w09],0)),sum(isnull(a.[m09],0))
	from #z_cub_rkp08c a	
	----銷售毛利
	--insert into @tmp(gno,attr,typea,kind,product,itemno,item,[weight],[money])
	--select 1,'3' attr,'' typea,'' kind,'製成品' product,'A01' itemno,'期初' item
	--	,sum(isnull(a.[w01],0)),sum(isnull(a.[m01],0))
	--from #z_cub_rkp08c a
	
	
	--期末 W11 P11 M11
	insert into @tmp(gno,attr,typea,kind,product,itemno,item,[weight],[money])
	select '1','3' attr,'' typea,'' kind,'製成品' product,'A01' itemno,'期末' item
		,sum(isnull(a.[w11],0)),sum(isnull(a.[m11],0))
	from #z_cub_rkp08c a

	update @tmp set price = case when [money]=0 or [weight]=0 then null else ROUND([money]/[weight],2) end
	--insert into @tmp(item,mount,[weight],[money])
	--select *
	--from #z_cub_rkp08b a
	--group by
	
	--select * from #z_cub_rkp08a
--	select * from #z_cub_rkp08b
	
	select gno
		, product a01
		, item + case when len(isnull(typea,''))>0 then '-' else '' end + typea a02
		, dbo.getComma(mount,-1) b01
		, dbo.getComma(weight,-1) b02
		, dbo.getComma(price,-1) b03
		, dbo.getComma([money],-1) b04 
	from @tmp 
	order by attr,typea,kind,sel
	drop table #z_cub_rkp08a
	drop table #z_cub_rkp08b
	drop table #z_cub_rkp08c;
	
z_cub_rkp08:--z_cub_rkp08	製成品彙總表
	SET QUOTED_IDENTIFIER OFF 
	declare @cmd nvarchar(max)
	declare @t_path nvarchar(max) = '[1]'
	declare @t_db nvarchar(max) = '[2]'
	
	declare @t_bdate nvarchar(max) = case when '#non' = [4] then '' else [4] end
	declare @t_edate nvarchar(max) = case when '#non' = [5] then char(255) else [5] end
	declare @t_makeno nvarchar(max) = case when '#non' = [8] then '' else [8] end
	declare @t_uno nvarchar(max) = case when '#non' = [9] then '' else [9] end
	declare @t_ordeno nvarchar(max) = case when '#non' = [12] then '' else [12] end
	-------------------------------------------------------------------------------------
	declare @tmp table(
		sel int identity(1,1)
		,recno int
		,gno nvarchar(20)
		,pno int
		,datea nvarchar(20)
		,typea nvarchar(20) -- 業種
		,dime float
		,radius float
		,width float
		,lengthb float
		,pvcno nvarchar(20)
		,makeno nvarchar(20)
		,uno nvarchar(30)
		,accy nvarchar(10)
		,noa nvarchar(20)
		,noq nvarchar(10)
		,ordeaccy nvarchar(10)
		,ordeno nvarchar(20)
		,no2 nvarchar(10)
		,cust nvarchar(max)
		,[weight] float
		,[money] float
		,[price] float
		
		--期初存貨
		,w01 float
		,p01 float
		,m01 float
		--進貨(RC2S)
		,w02 float
		,p02 float
		,m02 float
		--進貨退回(RC2S)
		,w03 float
		,p03 float
		,m03 float
		--入庫(INAS)
		,w04 float
		,p04 float
		,m04 float
		--成品進倉(CUTS)
		,w05 float
		,p05 float
		,m05 float
		--出貨(VCCS)
		,w06 float
		,p06 float
		,m06 float
		,vccprice float -- 銷售單價
		,vccmoney float -- 銷售金額
		,profit float -- 毛利
		--出貨退回(VCCS)
		,w07 float
		,p07 float
		,m07 float
		,bkmoney float -- 退貨金額
		--領料(GETS)
		,w08 float
		,p08 float
		,m08 float
		----領料
		,w08a float
		,p08a float
		,m08a float
		----盤點	
		,w08b float
		,p08b float
		,m08b float
		----報廢
		,w08c float
		,p08c float
		,m08c float
		----樣品
		,w08d float
		,p08d float
		,m08d float
		--領料(CUBT)
		,w09 float
		,p09 float
		,m09 float	
		--期末存貨		
		,w10 float
		,p10 float
		,m10 float
	)
	insert into @tmp(gno,pno,datea,typea,dime,radius,width,lengthb,pvcno,makeno,uno,accy,noa,noq
		,ordeaccy,ordeno,no2,[weight],[money],cust)
	select '1',1,a.datea,case when len(isnull(c.product,''))=0 then isnull(b.custpro,'') else isnull(c.product,'') end
		,a.dime,a.radius,a.width,a.lengthb,a.spec,a.cname,a.bno,a.accy,a.noa,a.noq
		,b.accy,a.ordeno,a.no2,a.[weight],a.[total],a.comp
	from view_cuts a
	left join view_ordes b on a.ordeno=b.noa and a.no2=b.no2
	left join adpro c on b.custpro=c.noa
	where a.datea<=@t_edate
	and len(ISNULL(a.bno,''))>0
	and (len(@t_makeno)=0 or a.cname=@t_makeno)
	and (len(@t_uno)=0 or a.bno=@t_uno)
	and (len(@t_ordeno)=0 or a.ordeno=@t_ordeno)
	
	update @tmp set price = case when ISNULL([weight],0)=0 then 0 else ROUND([money]/[weight],2) end
	---------------------------------------------------------------------------------------------------------
	--期初
	declare @x_stktype nvarchar(max)='A1@金屬底材,A4@皮膜,A5@保護膜,A6@物料,A7@成品,A8@溶劑' 
	declare @x_edate nvarchar(10) = dbo.AD2ChineseEraName(Dateadd(DD,-1, dbo.ChineseEraName2AD(@t_bdate)))     
	--只抓成品、成品倉
	declare @x_kind nvarchar(max)= 'A7' 
	declare @x_storeno nvarchar(max) = '06' 

	declare @tmp01 table(
		sel int identity(1,1)
		,kind nvarchar(20)
		,datea nvarchar(20) 
		,uno nvarchar(30)
		,makeno nvarchar(30)
		,size nvarchar(max)
		,weight float
		,price float
		,total float
		,storeno nvarchar(20)
		,store nvarchar(50)
		,place nvarchar(20)
	)
	insert into @tmp01(kind,datea,uno,makeno,size,weight,price,total,storeno,store,place)
	execute [dbo].[z_ucc_rk02] @x_stktype,@x_kind,@x_edate,@x_storeno
	
	delete @tmp where not((len(@t_makeno)=0 or isnull(makeno,'')=@t_makeno) and (len(@t_uno)=0 or isnull(uno,'')=@t_uno))
	-----------------------------------------------------------------------------------------------------
	--期初
	update @tmp set w01=b.weight,p01=b.price,m01=b.total
	from @tmp a
	left join @tmp01 b on a.uno=b.uno 
	where b.uno is not null 
	
	insert into @tmp(gno,pno,uno,w01,m01)
	select '1',1,a.uno,a.weight,a.total
	from @tmp01 a
	left join @tmp b on a.uno=b.uno
	where b.uno is null
	
	--進貨
	declare @tmp02 table(
		uno nvarchar(20)
		,weight float
		,total float
	)
	insert into @tmp02(uno,weight,total)
	select a.uno
		,SUM(a.weight) weight
		,SUM(a.total) total
	from view_rc2s a
	left join view_rc2 b on a.accy=b.accy and a.noa=b.noa
	where b.kind=@x_kind 
	and a.storeno=@x_storeno
	and b.datea between @t_bdate and @t_edate
	and len(ISNULL(a.uno,''))>0
	and b.typea='1'
	group by a.uno
	
	update @tmp set w02=b.weight
		,p02=case when b.weight!=0 then round(b.total/b.weight,2) else 0 end
		,m02=b.total
	from @tmp a
	left join @tmp02 b on a.uno=b.uno 
	where b.uno is not null 
	
	insert into @tmp(gno,pno,uno,w02,m02)
	select '1',1,a.uno,a.weight,a.total
	from @tmp02 a
	left join @tmp b on a.uno=b.uno
	where b.uno is null
	
	--進貨退回
	declare @tmp03 table(
		uno nvarchar(20)
		,weight float
		,total float
	)
	insert into @tmp03(uno,weight,total)
	select a.uno
		,SUM(a.weight) weight
		,SUM(a.total) total
	from view_rc2s a
	left join view_rc2 b on a.accy=b.accy and a.noa=b.noa
	left join view_uccb c on a.uno=c.uno
	where c.kind=@x_kind 
	and c.storeno=@x_storeno
	and b.datea between @t_bdate and @t_edate
	and len(ISNULL(a.uno,''))>0
	and b.typea='2'
	group by a.uno
	
	update @tmp set w03=b.weight
		,p03=case when b.weight!=0 then round(b.total/b.weight,2) else 0 end
		,m03=b.total
	from @tmp a
	left join @tmp03 b on a.uno=b.uno 
	where b.uno is not null 
	
	insert into @tmp(gno,pno,uno,w03,m03)
	select '1',1,a.uno,a.weight,a.total
	from @tmp03 a
	left join @tmp b on a.uno=b.uno
	where b.uno is null
	
	--入庫
	declare @tmp04 table(
		uno nvarchar(20)
		,weight float
		,total float
	)
	insert into @tmp04(uno,weight,total)
	select a.uno
		,SUM(a.weight) weight
		,SUM(a.total) total
	from view_inas a
	left join view_ina b on a.accy=b.accy and a.noa=b.noa
	where b.kind=@x_kind 
	and a.storeno=@x_storeno
	and b.datea between @t_bdate and @t_edate
	and len(ISNULL(a.uno,''))>0
	group by a.uno
	
	update @tmp set w04=b.weight
		,p04=case when b.weight!=0 then round(b.total/b.weight,2) else 0 end
		,m04=b.total
	from @tmp a
	left join @tmp04 b on a.uno=b.uno 
	where b.uno is not null 
	
	insert into @tmp(gno,pno,uno,w04,m04)
	select '1',1,a.uno,a.weight,a.total
	from @tmp04 a
	left join @tmp b on a.uno=b.uno
	where b.uno is null
	
	--成品進倉CUTS  
	declare @tmp05 table(
		uno nvarchar(20)
		,weight float
		,total float
	)
	insert into @tmp05(uno,weight,total)
	select a.bno
		,SUM(a.weight) weight
		,SUM(a.total) total
	from view_cuts a
	left join view_cut b on a.accy=b.accy and a.noa=b.noa
	where b.kind=@x_kind 
	and a.storeno=@x_storeno
	and a.datea between @t_bdate and @t_edate
	and len(ISNULL(a.bno,''))>0
	group by a.bno


	update @tmp set w05=b.weight
		,p05=case when b.weight!=0 then round(b.total/b.weight,2) else 0 end
		,m05=b.total
	from @tmp a
	left join @tmp05 b on a.uno=b.uno 
	where b.uno is not null 
	
	insert into @tmp(gno,pno,uno,w05,m05)
	select '1',1,a.uno,a.weight,a.total
	from @tmp05 a
	left join @tmp b on a.uno=b.uno
	where b.uno is null
	-----=============================================================================================
	-----=============================================================================================
	--出貨
	declare @tmp06 table(
		uno nvarchar(20)
		,weight float
		,total float
		,vccmoney float
	)
	insert into @tmp06(uno,weight,total,vccmoney)
	select a.uno
		,SUM(case when isnull(a.gweight,0)!=0 then a.gweight else a.weight end) weight
		,SUM(a.scost) total
		,SUM(isnull(a.total,0)) vccmoney
	from view_vccs a
	left join view_vcc b on a.accy=b.accy and a.noa=b.noa
	left join view_uccb c on a.uno=c.uno
	where c.kind=@x_kind 
	and c.storeno=@x_storeno
	and b.datea between @t_bdate and @t_edate
	and len(ISNULL(a.uno,''))>0
	and b.typea='1'
	group by a.uno
	
	update @tmp set w06=b.weight
		,p06=case when b.weight!=0 then round(b.total/b.weight,2) else 0 end
		,m06=b.total
		,vccmoney=b.vccmoney
	from @tmp a
	left join @tmp06 b on a.uno=b.uno 
	where b.uno is not null 
	
	insert into @tmp(gno,pno,uno,w06,m06,vccmoney)
	select '1',1,a.uno,a.weight,a.total,a.vccmoney
	from @tmp06 a
	left join @tmp b on a.uno=b.uno
	where b.uno is null
	
	--出貨退回
	declare @tmp07 table(
		uno nvarchar(20)
		,weight float
		,total float
		,bkmoney float
	)
	insert into @tmp07(uno,weight,total,bkmoney)
	select a.uno
		,SUM(case when isnull(a.gweight,0)!=0 then a.gweight else a.weight end) weight
		,SUM(a.scost) total
		,SUM(isnull(a.total,0)) bkmoney
	from view_vccs a
	left join view_vcc b on a.accy=b.accy and a.noa=b.noa
	left join view_uccb c on a.uno=c.uno
	where c.kind=@x_kind 
	and c.storeno=@x_storeno
	and b.datea between @t_bdate and @t_edate
	and len(ISNULL(a.uno,''))>0
	and b.typea='2'
	group by a.uno
	
	update @tmp set w07=b.weight
		,p07=case when b.weight!=0 then round(b.total/b.weight,2) else 0 end
		,m07=b.total
		,bkmoney=b.bkmoney
	from @tmp a
	left join @tmp07 b on a.uno=b.uno 
	where b.uno is not null 
	
	insert into @tmp(gno,pno,uno,w07,m07,bkmoney)
	select '1',1,a.uno,a.weight,a.total,a.bkmoney
	from @tmp07 a
	left join @tmp b on a.uno=b.uno
	where b.uno is null

	--領料(GET)
	declare @tmp08 table(
		uno nvarchar(20)
		,weight float
		,total float
		
		,wa float
		,ma float
		----盤點
		,wb float
		,mb float
		----報廢
		,wc float
		,mc float
		----樣品
		,wd float
		,md float
	)
	insert into @tmp08(uno,weight,total
		,wa,ma,wb,mb,wc,mc,wd,md)
	select a.uno
		,SUM(case when isnull(a.gweight,0)!=0 then a.gweight else a.weight end) weight
		,SUM(a.scost) total
		,SUM(case when not (b.typea='盤點' or b.typea='報廢' or b.typea='樣品') then 
			case when isnull(a.gweight,0)!=0 then a.gweight else a.weight end
			else 0 end) wa
		,SUM(case when not (b.typea='盤點' or b.typea='報廢') then a.scost else 0 end) ma
		,SUM(case when b.typea='盤點' then 
			case when isnull(a.gweight,0)!=0 then a.gweight else a.weight end
			else 0 end) wb
		,SUM(case when b.typea='盤點' then a.scost else 0 end) mb
		,SUM(case when b.typea='報廢' then 
			case when isnull(a.gweight,0)!=0 then a.gweight else a.weight end
			else 0 end) wc
		,SUM(case when b.typea='報廢' then a.scost else 0 end) mc
		,SUM(case when b.typea='樣品' then 
			case when isnull(a.gweight,0)!=0 then a.gweight else a.weight end
			else 0 end) wc
		,SUM(case when b.typea='樣品' then a.scost else 0 end) mc
	from view_gets a
	left join view_get b on a.accy=b.accy and a.noa=b.noa
	left join view_uccb c on a.uno=c.uno
	where c.kind=@x_kind 
	and c.storeno=@x_storeno
	and b.datea between @t_bdate and @t_edate
	and len(ISNULL(a.uno,''))>0
	group by a.uno
	
	update @tmp set w08=b.weight
		,p08=case when b.weight!=0 then round(b.total/b.weight,2) else 0 end
		,m08=b.total
		,w08a=b.wa
		,p08a=case when b.wa!=0 then round(b.ma/b.wa,2) else 0 end
		,m08a=b.ma
		,w08b=b.wb
		,p08b=case when b.wb!=0 then round(b.mb/b.wb,2) else 0 end
		,m08b=b.mb
		,w08c=b.wc
		,p08c=case when b.wc!=0 then round(b.mc/b.wc,2) else 0 end
		,m08c=b.mc
		,w08d=b.wd
		,p08d=case when b.wd!=0 then round(b.md/b.wd,2) else 0 end
		,m08d=b.md
	from @tmp a
	left join @tmp08 b on a.uno=b.uno 
	where b.uno is not null 
	
	insert into @tmp(gno,pno,uno,w08,m08
		,w08a,m08a,w08b,m08b,w08c,m08c,w08d,m08d)
	select '1',1,a.uno,a.weight,a.total
		,a.wa,a.ma,a.wb,a.mb,a.wc,a.mc,a.wd,a.md
	from @tmp08 a
	left join @tmp b on a.uno=b.uno
	where b.uno is null
	--
	
		
	--領料(CUBT)
	declare @tmp09 table(
		uno nvarchar(20)
		,weight float
		,total float
	)
	insert into @tmp09(uno,weight,total)
	select a.uno
		,SUM(case when isnull(a.gweight,0)!=0 then a.gweight else a.weight end) weight
		,SUM(a.scost) total
	from view_cubt a
	left join view_cub b on a.accy=b.accy and a.noa=b.noa
	left join view_uccb c on a.uno=c.uno
	where c.kind=@x_kind 
	and c.storeno=@x_storeno
	and b.datea between @t_bdate and @t_edate
	and len(ISNULL(a.uno,''))>0
	group by a.uno
	
	update @tmp set w09=b.weight
		,p09=case when b.weight!=0 then round(b.total/b.weight,2) else 0 end
		,m09=b.total
	from @tmp a
	left join @tmp09 b on a.uno=b.uno 
	where b.uno is not null 
	
	insert into @tmp(gno,pno,uno,w09,m09)
	select '1',1,a.uno,a.weight,a.total
	from @tmp09 a
	left join @tmp b on a.uno=b.uno
	where b.uno is null
	----------------------------------------------------------------------------------
	--期末
	declare @tmp10 table(
		sel int identity(1,1)
		,kind nvarchar(20)
		,datea nvarchar(20) 
		,uno nvarchar(30)
		,makeno nvarchar(30)
		,size nvarchar(max)
		,weight float
		,price float
		,total float
		,storeno nvarchar(20)
		,store nvarchar(50)
		,place nvarchar(20)
	)
	insert into @tmp10(kind,datea,uno,makeno,size,weight,price,total,storeno,store,place)
	execute [dbo].[z_ucc_rk02] @x_stktype,@x_kind,@t_edate,@x_storeno
	
	update @tmp set w10=b.weight,p10=b.price,m10=b.total
	from @tmp a
	left join @tmp10 b on a.uno=b.uno 
	where b.uno is not null 
	
	insert into @tmp(gno,pno,uno,w10,m10)
	select '1',1,a.uno,a.weight,a.total
	from @tmp10 a
	left join @tmp b on a.uno=b.uno
	where b.uno is null 
	-----------------------------------------------------------------------------------------------------
	delete @tmp where not((len(@t_makeno)=0 or isnull(makeno,'')=@t_makeno) and (len(@t_uno)=0 or isnull(uno,'')=@t_uno) and (len(@t_ordeno)=0 or isnull(ordeno,'')=@t_ordeno))
	
	update @tmp set w01=ISNULL(w01,0)
		,w02=ISNULL(w02,0)
		,w03=ISNULL(w03,0)
		,w04=ISNULL(w04,0)
		,w05=ISNULL(w05,0)
		,w06=ISNULL(w06,0)
		,w07=ISNULL(w07,0)
		,w08=ISNULL(w08,0)
		,w09=ISNULL(w09,0)
		,w10=ISNULL(w10,0)
		,m01=ISNULL(m01,0)
		,m02=ISNULL(m02,0)
		,m03=ISNULL(m03,0)
		,m04=ISNULL(m04,0)
		,m05=ISNULL(m05,0)
		,m06=ISNULL(m06,0)
		,m07=ISNULL(m07,0)
		,m08=ISNULL(m08,0)
		,m09=ISNULL(m09,0)
		,m10=ISNULL(m10,0)
	delete @tmp where w01=0 and w02=0 and w03=0 and w04=0 and w05=0 and w06=0 and w07=0 and w08=0 and w09=0 and w10=0 
		and m01=0 and m02=0 and m03=0 and m04=0 and m05=0 and m06=0 and m07=0 and m08=0 and m09=0 and m10=0 
	---------------------
	delete  @tmp 
	where (len(@t_makeno)>0 and makeno!=@t_makeno)
		and  (len(@t_uno)>0 and uno!=@t_uno)
		and  (len(@t_ordeno)>0 and ordeno!=@t_ordeno)
	---------------------	
	insert into @tmp(gno,w01,m01,w02,m02,w03,m03,w04,m04,w05,m05,w06,m06,w07,m07,w08,m08,w09,m09,w10,m10
		,w08a,m08a,w08b,m08b,w08c,m08c,w08d,m08d
		,vccmoney,bkmoney)
	select '2',SUM(ISNULL(w01,0)),SUM(ISNULL(m01,0))
		,SUM(ISNULL(w02,0)),SUM(ISNULL(m02,0))
		,SUM(ISNULL(w03,0)),SUM(ISNULL(m03,0))
		,SUM(ISNULL(w04,0)),SUM(ISNULL(m04,0))
		,SUM(ISNULL(w05,0)),SUM(ISNULL(m05,0))
		,SUM(ISNULL(w06,0)),SUM(ISNULL(m06,0))
		,SUM(ISNULL(w07,0)),SUM(ISNULL(m07,0))
		,SUM(ISNULL(w08,0)),SUM(ISNULL(m08,0))
		,SUM(ISNULL(w09,0)),SUM(ISNULL(m09,0))
		,SUM(ISNULL(w10,0)),SUM(ISNULL(m10,0))
		,SUM(ISNULL(w08a,0)),SUM(ISNULL(m08a,0))
		,SUM(ISNULL(w08b,0)),SUM(ISNULL(m08b,0))
		,SUM(ISNULL(w08c,0)),SUM(ISNULL(m08c,0))
		,SUM(ISNULL(w08d,0)),SUM(ISNULL(m08d,0))
		,SUM(ISNULL(vccmoney,0)),SUM(ISNULL(bkmoney,0))
	from @tmp
	where gno='1'
	
	update @tmp set profit = ISNULL(vccmoney,0)-ISNULL(w06,0)
	
	update @tmp set p01 = case when ISNULL(w01,0)=0 then 0 else round(ISNULL(m01,0)/ISNULL(w01,0),4)end
		,p02 = case when ISNULL(w02,0)=0 then 0 else round(ISNULL(m02,0)/ISNULL(w02,0),4)end
		,p03 = case when ISNULL(w03,0)=0 then 0 else round(ISNULL(m03,0)/ISNULL(w03,0),4)end
		,p04 = case when ISNULL(w04,0)=0 then 0 else round(ISNULL(m04,0)/ISNULL(w04,0),4)end
		,p05 = case when ISNULL(w05,0)=0 then 0 else round(ISNULL(m05,0)/ISNULL(w05,0),4)end
		,p06 = case when ISNULL(w06,0)=0 then 0 else round(ISNULL(m06,0)/ISNULL(w06,0),4)end
		,p07 = case when ISNULL(w07,0)=0 then 0 else round(ISNULL(m07,0)/ISNULL(w07,0),4)end
		,p08 = case when ISNULL(w08,0)=0 then 0 else round(ISNULL(m08,0)/ISNULL(w08,0),4)end
		,p09 = case when ISNULL(w09,0)=0 then 0 else round(ISNULL(m09,0)/ISNULL(w09,0),4)end
		,p10 = case when ISNULL(w10,0)=0 then 0 else round(ISNULL(m10,0)/ISNULL(w10,0),4)end
		,p08a = case when ISNULL(w08a,0)=0 then 0 else round(ISNULL(m08a,0)/ISNULL(w08a,0),4)end
		,p08b = case when ISNULL(w08b,0)=0 then 0 else round(ISNULL(m08b,0)/ISNULL(w08b,0),4)end
		,p08c = case when ISNULL(w08c,0)=0 then 0 else round(ISNULL(m08c,0)/ISNULL(w08c,0),4)end
		,p08d = case when ISNULL(w08d,0)=0 then 0 else round(ISNULL(m08d,0)/ISNULL(w08d,0),4)end
		,vccprice = case when ISNULL(w06,0)=0 then 0 else round(ISNULL(vccmoney,0)/ISNULL(w06,0),4)end
	update @tmp set recno=b.recno+1000
	from @tmp a
	left join (select sel,ROW_NUMBER()over(order by makeno) recno from @tmp) b on a.sel=b.sel
	where ISNULL(a.recno,0)=0
	
	update @tmp set recno=b.recno,typea=b.typea
	from @tmp a
	left join itemb b on a.uno=b.uno
	where b.uno is not null
	
	update @tmp set recno=b.recno
	from @tmp a
	left join (select sel,ROW_NUMBER()over(order by recno) recno from @tmp) b on a.sel=b.sel

	select gno
		,'日期：'+case when @t_bdate=@t_edate then @t_bdate else @t_bdate+' ~ '+@t_edate end aa
		,recno rr
		,typea a01
		,dime a02
		,radius a03
		,width a04
		,lengthb a05
		,pvcno a06
		,makeno a07
		,uno a08
		,ordeno a09
		,cust a10
		,dbo.getComma(w01,-1) b01
		,dbo.getComma(p01,-1) b02
		,dbo.getComma(m01,-1) b03
		,dbo.getComma(w02,-1) b04
		,dbo.getComma(p02,-1) b05
		,dbo.getComma(m02,-1) b06
		,dbo.getComma(w03,-1) b07
		,dbo.getComma(p03,-1) b08
		,dbo.getComma(m03,-1) b09
		,dbo.getComma(w04,-1) b10
		,dbo.getComma(p04,-1) b11
		,dbo.getComma(m04,-1) b12
		,dbo.getComma(w05,-1) b13
		,dbo.getComma(p05,-1) b14
		,dbo.getComma(m05,-1) b15
		,dbo.getComma(isnull(w08a,0)+isnull(w09,0),-1) b16
		,dbo.getComma(case when isnull(w08a,0)+isnull(w09,0)=0 then 0 else round((isnull(m08a,0)+isnull(m09,0))/(isnull(w08a,0)+isnull(w09,0)),2) end,-1) b17
		,dbo.getComma(isnull(m08a,0)+isnull(m09,0),-1) b18
		,dbo.getComma(isnull(w08b,0),-1) b19
		,dbo.getComma(case when isnull(w08b,0)=0 then 0 else round(isnull(m08b,0)/isnull(w08b,0),2) end,-1) b20
		,dbo.getComma(isnull(m08b,0),-1) b21
		,dbo.getComma(isnull(w08c,0),-1) b22
		,dbo.getComma(case when isnull(w08c,0)=0 then 0 else round(isnull(m08c,0)/isnull(w08c,0),2) end,-1) b23
		,dbo.getComma(isnull(m08c,0),-1) b24
		,dbo.getComma(isnull(w08d,0),-1) b25
		,dbo.getComma(case when isnull(w08d,0)=0 then 0 else round(isnull(m08d,0)/isnull(w08d,0),2) end,-1) b26
		,dbo.getComma(isnull(m08d,0),-1) b27
		,dbo.getComma(w06,-1) b28
		,dbo.getComma(p06,-1) b29
		,dbo.getComma(m06,-1) b30
		,dbo.getComma(vccprice,-1) b31
		,dbo.getComma(vccmoney,-1) b32
		,dbo.getComma(profit,-1) b33
		,dbo.getComma(w07,-1) b34
		,dbo.getComma(p07,-1) b35
		,dbo.getComma(m07,-1) b36
		,dbo.getComma(bkmoney,-1) b37
		,dbo.getComma(w10,-1) b38
		,dbo.getComma(p10,-1) b39
		,dbo.getComma(m10,-1) b40
	from @tmp	
	order by gno,recno;
	
z_cub_rkp06:--z_cub_rkp06	製成品單位成本表
	SET QUOTED_IDENTIFIER OFF 
	declare @cmd nvarchar(max)
	declare @t_path nvarchar(max) = '[1]'
	declare @t_db nvarchar(max) = '[2]'
	
	declare @t_bdate nvarchar(max) = case when '#non' = [4] then '' else [4] end
	declare @t_edate nvarchar(max) = case when '#non' = [5] then char(255) else [5] end
	declare @t_makeno nvarchar(max) = case when '#non' = [8] then '' else [8] end
	--------------------------------------------------------------------------------
	IF OBJECT_ID('tempdb..#z_cub_rkp04')is not null
	BEGIN
		drop table #z_cub_rkp04
	END
	select * into #z_cub_rkp04 from [dbo].[z_cub_rkp04](@t_bdate,@t_edate,@t_makeno)
	
	declare @tmpa table(
		sel int identity(1,1)
		,accy nvarchar(10)
		,noa nvarchar(20)
		,noq nvarchar(10)
		,datea nvarchar(20)
		,makeno nvarchar(30)
		,dime float
		,radius float
		,width float
		,lengthb float
		,pvcno nvarchar(30)
		,pvc nvarchar(50)
		,cust nvarchar(max)
		,cost float -- 在製品成本
		,[weight] float -- 進倉重量
		,total float -- 製成品金額
		
		,w01 decimal(25,2) -- 不良損耗
		,w02 decimal(25,2) -- 尺寸損耗
		,w03 decimal(25,2) -- 頭尾損耗
		,isx01 bit-- 分條	
		,isx02 bit-- 二呎	
		,isx03 bit-- 三呎	
		,isx04 bit-- 四呎	
		,isx05 bit-- 十呎
		,isx06 bit-- 重工
		,isx07 bit-- 挑板
		,mins float-- 加工工時
		,x01 float-- 加工成本-分條	
		,x02 float-- 加工成本-二呎
		,x03 float-- 加工成本-三呎
		,x04 float-- 加工成本-四呎
		,x05 float-- 加工成本-十呎
		,x06 float-- 加工成本-重工
		,x07 float-- 加工成本-挑板
		,xmoney float-- 加工成本
		
		,tweight float-- 在製品完工重
	) 
	insert into @tmpa(accy,noa,noq,datea
		,makeno,dime,radius,width,lengthb,cust,cost,[weight],total)
	select a.accy,a.noa,a.noq,a.datea 
		,isnull(a.cname,''),isnull(a.dime,0),isnull(a.radius,0),isnull(a.width,0),isnull(a.lengthb,0)
		,isnull(a.comp,'')
		,isnull(a.scost,0),isnull(a.[weight],0),isnull(a.total,0)
	from view_cuts a
	left join view_cut b on a.accy=b.accy and a.noa=b.noa
	where a.datea between @t_bdate and @t_edate
	and (len(@t_makeno)=0 or a.cname=@t_makeno)
	and len(ISNULL(a.cname,''))>0
	--group by a.cname,a.dime,a.radius,a.width,a.lengthb,a.comp
	------------------------------------------------------------------------------------------------------------
	declare @makeno nvarchar(30)
	declare @totweight float
	declare @w01 decimal(25,2) -- 不良損耗
	declare @w02 decimal(25,2) -- 尺寸損耗
	declare @w03 decimal(25,2) -- 頭尾損耗
	declare @mins float -- 工時
	declare @totw01 decimal(25,2)
	declare @totw02 decimal(25,2)
	declare @totw03 decimal(25,2)
	declare @totmins float
	declare @x01 float,@x02 float,@x03 float,@x04 float,@x05 float,@x06 float,@x07 float
	declare @totx01 float,@totx02 float,@totx03 float,@totx04 float,@totx05 float,@totx06 float,@totx07 float
	declare @tweight decimal(25,2)
	declare @totTweight decimal(25,2)
	
	declare cursor_table cursor for
	select makeno from @tmpa group by makeno
	open cursor_table
	fetch next from cursor_table
	into @makeno
	while(@@FETCH_STATUS <> -1)
	begin
		select @totweight = 0
		select @totweight = SUM([weight]) from @tmpa where makeno=@makeno
		select @tweight = 0
		select @tweight = SUM(isnull(weight04,0)+isnull(weight07,0)) from #z_cub_rkp04 where makeno=@makeno
		
		select @w01=0,@w02=0,@w03=0,@mins=0
			,@x01=0,@x02=0,@x03=0,@x04=0,@x05=0,@x06=0,@x07=0
		select @w01=SUM(ISNULL(a.weight8,0))
			,@w02=SUM(ISNULL(a.weight9,0))
			,@w03=SUM(ISNULL(a.weight10,0))
			,@mins=SUM(ISNULL(a.mins,0))
			,@x01=sum(case when b.typea='分條作業' then ISNULL(a.w01,0)+ISNULL(a.w02,0)+ISNULL(a.w04,0)+ISNULL(a.w05,0) else 0 end)
			,@x02=sum(case when b.typea='二呎裁切' then ISNULL(a.w01,0)+ISNULL(a.w02,0)+ISNULL(a.w04,0)+ISNULL(a.w05,0) else 0 end)
			,@x03=sum(case when b.typea='三呎裁切' then ISNULL(a.w01,0)+ISNULL(a.w02,0)+ISNULL(a.w04,0)+ISNULL(a.w05,0) else 0 end)
			,@x04=sum(case when b.typea='四呎裁切' then ISNULL(a.w01,0)+ISNULL(a.w02,0)+ISNULL(a.w04,0)+ISNULL(a.w05,0) else 0 end)
			,@x05=sum(case when b.typea='十呎裁切' then ISNULL(a.w01,0)+ISNULL(a.w02,0)+ISNULL(a.w04,0)+ISNULL(a.w05,0) else 0 end)
			,@x06=sum(case when b.typea='重工' then ISNULL(a.w01,0)+ISNULL(a.w02,0)+ISNULL(a.w04,0)+ISNULL(a.w05,0) else 0 end)
			,@x07=sum(case when b.typea='挑板' then ISNULL(a.w01,0)+ISNULL(a.w02,0)+ISNULL(a.w04,0)+ISNULL(a.w05,0) else 0 end)
		from view_cucs a
		left join view_cuc b on a.accy=b.accy and a.noa=b.noa
		where b.datea between @t_bdate and @t_edate
		and a.cubno=@makeno

		if @totweight!=0
		begin
			update @tmpa set w01 = round(@w01*[weight]/@totweight,2)
				,w02 = round(@w02*[weight]/@totweight,2)
				,w03 = round(@w03*[weight]/@totweight,2)
				,mins = round(@mins*[weight]/@totweight,0)
				,x01 = round(@x01*[weight]/@totweight,0)
				,x02 = round(@x02*[weight]/@totweight,0)
				,x03 = round(@x03*[weight]/@totweight,0)
				,x04 = round(@x04*[weight]/@totweight,0)
				,x05 = round(@x05*[weight]/@totweight,0)
				,x06 = round(@x06*[weight]/@totweight,0)
				,x07 = round(@x07*[weight]/@totweight,0)
				,tweight = round(@tweight*[weight]/@totweight,0)
			where makeno=@makeno
		end
	
		--尾差修正(找最後一筆來修正)
		select @totw01=0,@totw02=0,@totw03=0,@totmins=0
			,@totx01=0,@totx02=0,@totx03=0,@totx04=0,@totx05=0,@totx06=0,@totx07=0
			,@totTweight=0
		select @totw01=SUM(ISNULL(w01,0)),@totw02=SUM(ISNULL(w02,0)),@totw03=SUM(ISNULL(w03,0)),@totmins=SUM(ISNULL(mins,0))
			,@totx01=SUM(ISNULL(x01,0)),@totx02=SUM(ISNULL(x02,0)),@totx03=SUM(ISNULL(x03,0)),@totx04=SUM(ISNULL(x04,0))
			,@totx05=SUM(ISNULL(x05,0)),@totx06=SUM(ISNULL(x06,0)),@totx07=SUM(ISNULL(x07,0))
			,@totTweight=SUM(ISNULL(tweight,0))
		from @tmpa 
		where makeno=@makeno
		
		update @tmpa set w01=isnull(a.w01,0) + (@w01-@totw01)
			,w02=isnull(a.w02,0) + (@w02-@totw02)
			,w03=isnull(a.w03,0) + (@w03-@totw03)
			,mins=isnull(a.mins,0) + (@mins-@totmins)
			,x01=isnull(a.x01,0) + (@x01-@totx01)
			,x02=isnull(a.x02,0) + (@x02-@totx02)
			,x03=isnull(a.x03,0) + (@x03-@totx03)
			,x04=isnull(a.x04,0) + (@x04-@totx04)
			,x05=isnull(a.x05,0) + (@x05-@totx05)
			,x06=isnull(a.x06,0) + (@x06-@totx06)
			,x07=isnull(a.x07,0) + (@x07-@totx07)
			,tweight=isnull(a.tweight,0) + (@tweight-@tottweight)
		from @tmpa a
		outer apply(select top 1 sel from @tmpa where makeno=a.makeno order by datea desc,accy desc,noa desc,noq desc) b
		where a.makeno=@makeno and a.sel=b.sel

		fetch next from cursor_table
		into @makeno
	end
	close cursor_table
	deallocate cursor_table		
	
	update @tmpa set cost=0 where ISNULL(tweight,0)=0
	update @tmpa set xmoney = ISNULL(x01,0)+ISNULL(x02,0)+ISNULL(x03,0)+ISNULL(x04,0)+ISNULL(x05,0)+ISNULL(x06,0)+ISNULL(x07,0)
	-----------------------------------------------------------------------------------------------------------
	declare @tmpb table(
		sel int identity(1,1)
		,gno nvarchar(10)
		,pno int
		,recno int
		,makeno nvarchar(30)
		,dime float
		,radius float
		,width float
		,lengthb float
		,pvcno nvarchar(30)
		,pvc nvarchar(50)
		,cust nvarchar(max)
		,cost float -- 在製品成本
		,[weight] float -- 進倉重量
		,total float -- 製成品金額
		
		,w01 decimal(25,2) -- 不良損耗
		,w02 decimal(25,2) -- 尺寸損耗
		,w03 decimal(25,2) -- 頭尾損耗
		,isx01 bit-- 分條	
		,isx02 bit-- 二呎	
		,isx03 bit-- 三呎	
		,isx04 bit-- 四呎	
		,isx05 bit-- 十呎
		,isx06 bit-- 重工
		,isx07 bit-- 挑板
		,mins float-- 加工工時
		,x01 float-- 加工成本-分條	
		,x02 float-- 加工成本-二呎
		,x03 float-- 加工成本-三呎
		,x04 float-- 加工成本-四呎
		,x05 float-- 加工成本-十呎
		,x06 float-- 加工成本-重工
		,x07 float-- 加工成本-挑板
		,xmoney float-- 加工成本
		
		,tweight float-- 在製品完工重
	) 
	insert into @tmpb(gno,pno,makeno,dime,radius,width,lengthb,pvcno,pvc,cust
		,cost,[weight],total,w01,w02,w03,mins
		,x01,x02,x03,x04,x05,x06,x07,xmoney
		,tweight)
	select '1',1,isnull(makeno,''),isnull(dime,0),isnull(radius,0),isnull(width,0),isnull(lengthb,0),isnull(pvcno,''),isnull(pvc,''),isnull(cust,'') 	
		,SUM(isnull(cost,0)),SUM(isnull([weight],0)),SUM(isnull(total,0))
		,SUM(isnull(w01,0)),SUM(isnull(w02,0)),SUM(isnull(w03,0)),SUM(isnull(mins,0))
		,SUM(isnull(x01,0)),SUM(isnull(x02,0)),SUM(isnull(x03,0)),SUM(isnull(x04,0))
		,SUM(isnull(x05,0)),SUM(isnull(x06,0)),SUM(isnull(x07,0)),SUM(isnull(xmoney,0))
		,SUM(isnull(tweight,0))
	from @tmpa
	group by isnull(makeno,''),isnull(dime,0),isnull(radius,0),isnull(width,0),isnull(lengthb,0),isnull(pvcno,''),isnull(pvc,''),isnull(cust,'') 	
	
	update @tmpb set isx01 = case when ISNULL(x01,0)=0 then 0 else 1 end
		,isx02 = case when ISNULL(x02,0)=0 then 0 else 1 end
		,isx03 = case when ISNULL(x03,0)=0 then 0 else 1 end
		,isx04 = case when ISNULL(x04,0)=0 then 0 else 1 end
		,isx05 = case when ISNULL(x05,0)=0 then 0 else 1 end
		,isx06 = case when ISNULL(x06,0)=0 then 0 else 1 end
		,isx07 = case when ISNULL(x07,0)=0 then 0 else 1 end

	update @tmpb set pvcno=ISNULL(b.pvcno,''),pvc=ISNULL(b.pvc,'')
	from @tmpb a
	left join #z_cub_rkp04 b on a.makeno=b.makeno
	----------------------------------------------------------------------------------------------------
	
	update @tmpb set recno=b.recno
	from @tmpb a
	left join (select sel,ROW_NUMBER()over(order by makeno) recno from @tmpb) b on a.sel=b.sel
	
	insert into @tmpb(gno,pno,makeno,[weight],w01,w02,w03
		,tweight,cost,mins
		,x01,x02,x03,x04,x05,x06,x07
		,xmoney,total)
	select '2',2,LEFT(makeno,1),SUM(ISNULL([weight],0)),SUM(ISNULL([w01],0)),SUM(ISNULL([w02],0)),SUM(ISNULL([w03],0))
		,SUM(ISNULL([tweight],0)),SUM(ISNULL([cost],0)),SUM(ISNULL([mins],0))
		,SUM(ISNULL([x01],0)),SUM(ISNULL([x02],0)),SUM(ISNULL([x03],0)),SUM(ISNULL([x04],0)),SUM(ISNULL([x05],0)),SUM(ISNULL([x06],0)),SUM(ISNULL([x07],0))
		,SUM(ISNULL([xmoney],0)),SUM(ISNULL([total],0))
	from @tmpb
	where pno=1
	group by LEFT(makeno,1) 
	
	insert into @tmpb(gno,pno,[weight],w01,w02,w03
		,tweight,cost,mins
		,x01,x02,x03,x04,x05,x06,x07
		,xmoney,total)
	select '3',3,SUM(ISNULL([weight],0)),SUM(ISNULL([w01],0)),SUM(ISNULL([w02],0)),SUM(ISNULL([w03],0))
		,SUM(ISNULL([tweight],0)),SUM(ISNULL([cost],0)),SUM(ISNULL([mins],0))
		,SUM(ISNULL([x01],0)),SUM(ISNULL([x02],0)),SUM(ISNULL([x03],0)),SUM(ISNULL([x04],0)),SUM(ISNULL([x05],0)),SUM(ISNULL([x06],0)),SUM(ISNULL([x07],0))
		,SUM(ISNULL([xmoney],0)),SUM(ISNULL([total],0))
	from @tmpb
	where pno=1
	
	
	select gno
		,'日期：'+case when @t_bdate=@t_edate then @t_bdate else @t_bdate+' ~ '+@t_edate end aa
		,recno rr
		,dime a01
		,radius a02
		,width a03
		,lengthb a04
		,pvcno a05
		,makeno a06
		,cust a07
		,dbo.getComma([weight],2) a08
		,dbo.getComma([w01],2) a09
		,dbo.getComma([w02],2) a10
		,dbo.getComma([w03],2) a11
		,case when isnull([weight],0)=0 then 0 else ROUND(([w01]+[w02]+[w03])/[weight]*100,2) end a12
		,case when isx01=1 then 'V' else '' end a13
		,case when isx02=1 then 'V' else '' end a14
		,case when isx03=1 then 'V' else '' end a15
		,case when isx04=1 then 'V' else '' end a16
		,case when isx05=1 then 'V' else '' end a17
		,case when isx06=1 then 'V' else '' end a18
		,case when isx07=1 then 'V' else '' end a19
		,dbo.getComma([tweight],-1) a20
		,dbo.getComma([cost],-1) a21
		,dbo.getComma([mins],-1) a22
		,dbo.getComma([x01],-1) a23
		,dbo.getComma([x02],-1) a24
		,dbo.getComma([x03],-1) a25
		,dbo.getComma([x04],-1) a26
		,dbo.getComma([x05],-1) a27
		,dbo.getComma([x06],-1) a28
		,dbo.getComma([x07],-1) a29
		,dbo.getComma([xmoney],-1) a30
		,dbo.getComma(case when ISNULL([weight],0)=0 then 0 else ROUND(xmoney/[weight],4) end,4) a31
		,dbo.getComma([total],-1) a32
		,dbo.getComma(case when ISNULL([weight],0)=0 then 0 else ROUND(total/[weight],4) end,4) a33
	from @tmpb order by pno,recno
	drop table #z_cub_rkp04;
	
z_cub_rkp04:--z_cub_rkp04	在製品彙總表
	SET QUOTED_IDENTIFIER OFF 
	declare @cmd nvarchar(max)
	declare @t_path nvarchar(max) = '[1]'
	declare @t_db nvarchar(max) = '[2]'
	
	declare @t_bdate nvarchar(20) = case when '#non' = [4] then '' else [4] end	
	declare @t_edate nvarchar(20) = case when '#non' = [5] then char(255) else [5] end
	declare @t_makeno nvarchar(max) = case when '#non' = [8] then '' else [8] end	
	------------------------------------------------------------------------------------
	IF OBJECT_ID('tempdb..#z_cub_rkp04')is not null
	BEGIN
		drop table #z_cub_rkp04
	END
	select * into #z_cub_rkp04 from [dbo].[z_cub_rkp04](@t_bdate,@t_edate,@t_makeno)
	
	-----------------------------------------------------------------
	-- 期初資料排在前面 itema
	update #z_cub_rkp04 set recno= b.recno
	from #z_cub_rkp04 a
	left join itema b on a.makeno=b.makeno
	where b.makeno is not null

	update #z_cub_rkp04 set recno=b.recno + 1000
	from #z_cub_rkp04 a
	left join (select sel,ROW_NUMBER()over(order by makeno) recno from #z_cub_rkp04) b on a.sel=b.sel
	where isnull(a.recno,0)=0
	
	update #z_cub_rkp04 set recno=b.recno
	from #z_cub_rkp04 a
	left join (select sel,ROW_NUMBER()over(order by recno) recno from #z_cub_rkp04) b on a.sel=b.sel

	insert into #z_cub_rkp04(gno,pno,weight01,weight02,weight03,weight04,weight05,weight06,weight07,weight10
		,total01,total02,total03,total04,total05,total06,total07,total10
		,mins)
	select '2',2
		,sum(isnull(weight01,0)),sum(isnull(weight02,0)),sum(isnull(weight03,0)),sum(isnull(weight04,0))
		,sum(isnull(weight05,0)),sum(isnull(weight06,0)),sum(isnull(weight07,0)),sum(isnull(weight10,0))
		,sum(isnull(total01,0)),sum(isnull(total02,0)),sum(isnull(total03,0)),sum(isnull(total04,0))
		,sum(isnull(total05,0)),sum(isnull(total06,0)),sum(isnull(total07,0)),sum(isnull(total10,0))
		,sum(isnull(mins,0))
	from #z_cub_rkp04	

	select gno
		,'日期：'+case when @t_bdate=@t_edate then @t_bdate else @t_bdate+' ~ '+@t_edate end aa
		,recno rr
		,dime a01
		,radius a02
		,width a03
		,lengthb a04
		,pvcno a05
		,makeno a06
		,tmakeno a06a
		,cust a07
		,cspec a08
		--期初存貨								
		,dbo.getComma(weight01,-1) a09
		,dbo.getComma(price01,4) a10
		,dbo.getComma(total01,-1) a11
		--盤點調整			
		,dbo.getComma(weight02,-1) a12
		,dbo.getComma(price02,4) a13
		,dbo.getComma(total02,-1) a14
		--本期完工投入
		,dbo.getComma(weight03,-1) a15
		,dbo.getComma(price03,4) a16
		,dbo.getComma(total03,-1) a17			
		--本期耗料
		,dbo.getComma(weight04,-1) a18
		,dbo.getComma(price04,4) a19
		,dbo.getComma(total04,-1) a20			
		--本期樣品 
		,dbo.getComma(weight05,-1) a21
		,dbo.getComma(price05,4) a22
		,dbo.getComma(total05,-1) a23
		--本期報廢	
		,dbo.getComma(weight06,-1) a24
		,dbo.getComma(price06,4) a25
		,dbo.getComma(total06,-1) a26	
		--本期領用
		,dbo.getComma(weight07,-1) a27
		,dbo.getComma(price07,4) a28
		,dbo.getComma(total07,-1) a29
		--期末存貨
		,dbo.getComma(weight10,-1) a30
		,dbo.getComma(price10,4) a31
		,dbo.getComma(total10,-1) a32
		,mins t01
	from #z_cub_rkp04 order by pno,recno
	drop table #z_cub_rkp04;
	
z_cub_rkp02:--z_cub_rkp02	在製品單位成本表
	SET QUOTED_IDENTIFIER OFF 
	declare @cmd nvarchar(max)
	declare @t_path nvarchar(max) = '[1]'
	declare @t_db nvarchar(max) = '[2]'
	
	declare @t_bdate nvarchar(max) = case when '#non' = [4] then '' else [4] end
	declare @t_edate nvarchar(max) = case when '#non' = [5] then char(255) else [5] end
	--------------------------------------------------------------------------------
	declare @t_bcustno nvarchar(20) = case when '#non' = [6] then '' else [6] end
	declare @t_ecustno nvarchar(20) = case when '#non' = [7] then char(255) else [7] end
	declare @t_makeno nvarchar(max) = case when '#non' = [8] then '' else [8] end
	declare @t_xbdime nvarchar(20) = case when '#non' = [10] then '' else [10] end
	declare @t_xedime nvarchar(20) = case when '#non' = [11] then '' else [11] end
	--------------------------------------------------------------------------------
	--------------------------------------------------------------------------------
	declare @t_bdime float=0,@t_edime float=0
	begin try
		set @t_bdime = CAST(@t_xbdime as float)
		set @t_edime = CAST(@t_xedime as float)
	end try
	begin catch
		--nothing
	end catch
	--------------------------------------------------------------------------------
	--------------------------------------------------------------------------------
	declare @tmp table(
		sel int identity(1,1),
		cubno nvarchar(20),
		cubnoq nvarchar(10),
		gno nvarchar(10),
		dime float,
		radius float,
		width float,
		lengthb float,
		makeno nvarchar(20),
		uno nvarchar(30),
		custno nvarchar(20),
		cust nvarchar(50),
		productno nvarchar(20),
		product nvarchar(50),
		pvcno nvarchar(20),--皮膜
		pvc nvarchar(20),
		peno nvarchar(20),--保護膜
		pe nvarchar(20),
		timea float,
		weight01 float,--投入重量
		weight02 float,--完工重量
		money01 float,--半成品金額
		rate01 float,
		money02 float,--直接人工金額
		rate02 float,
		money03 float,--製造費用金額
		rate03 float,
		money04 float,--電費
		rate04 float,
		money05 float,--瓦斯費
		rate05 float,
		money06 float,--合計
		price01 float,--加工成本單價
		price02 float,--在製品單價
		
		memo nvarchar(max)
		,ordeno nvarchar(20)
		,no2 nvarchar(10)
		,mon nvarchar(20)
		,spec nvarchar(20)
		,cspec nvarchar(50)
	)
	insert into @tmp(cubno,cubnoq,gno,dime,radius,width,lengthb
		,makeno,uno,custno,cust,productno,product,timea,weight01,weight02,ordeno,no2
		,money01,money02,money03,money04,money05)
	select a.noa,a.noq, '1',a.dime,a.radius,a.width,a.lengthb
		,a.makeno,a.uno,a.custno,a.comp,a.productno,a.product
		,a.mins,a.w03,a.hweight,a.ordeno,a.no2
		,ISNULL(a.y01,0)+ISNULL(a.y02,0)+ISNULL(a.y03,0)+ISNULL(a.y04,0)
			+ISNULL(a.y05,0)+ISNULL(a.y06,0)+ISNULL(a.y07,0)+ISNULL(a.y08,0)
		,ISNULL(a.w01,0),ISNULL(a.w02,0),ISNULL(a.w04,0),ISNULL(a.w05,0)
	from view_cubs a
	left join view_cub b on a.accy=b.accy and a.noa=b.noa
	left join view_uccb c on a.uno=c.uno
	where b.datea between @t_bdate and @t_edate
	and a.custno between @t_bcustno and @t_ecustno
	and (len(@t_makeno)=0 or CHARINDEX(@t_makeno,a.makeno)>0)
	and a.dime between @t_bdime and @t_edime
	
	update @tmp set spec = b.spec,cspec=c.product
	from @tmp a
	left join view_ordes b on a.ordeno=b.noa and a.no2=b.no2
	left join spec c on b.spec=c.noa
	where b.noa is not null
	
	update @tmp set custno=b.custno,cust=b.nick
	from @tmp a
	left join view_orde b on a.ordeno=b.noa
	where len(ISNULL(a.custno,''))=0
	and b.noa is not null
	
	update @tmp set cust=b.nick
	from @tmp a
	left join cust b on a.custno=b.noa
	where len(ISNULL(a.custno,''))>0
	and b.noa is not null
	
	--皮膜、保護膜
	update @tmp set pvcno=ISNULL(b.productno,''),pvc=ISNULL(b.product,'')
	from @tmp a
	outer apply (select top 1 productno,product from view_cubt where noa=a.cubno and nor=a.cubnoq and kind='1' order by noq) b
	update @tmp set peno=ISNULL(b.productno,''),pe=ISNULL(b.product,'')
	from @tmp a
	outer apply (select top 1 productno,product from view_cubt where noa=a.cubno and nor=a.cubnoq and kind='2' order by noq) b
	
	--皮膜(再投入)	
	update @tmp set pvcno=case when len(a.pvcno)>0 then a.pvcno else ISNULL(b.spec,a.pvcno) end
		,pvc=case when len(a.pvc)>0 then a.pvc else  ISNULL(b.class,a.pvc) end
	from @tmp a
	left join view_cuts b on a.uno=b.bno
	where b.noa is not null

	update @tmp set money06=ISNULL(money01,0)+ISNULL(money02,0)+ISNULL(money03,0)+ISNULL(money04,0)+ISNULL(money05,0)
	--小計
	insert into @tmp(gno,timea,makeno,weight01,weight02,money01,money02,money03,money04,money05,money06)
	select '2',sum(isnull(timea,0)),LEFT(makeno,1),sum(isnull(weight01,0)),sum(isnull(weight02,0)),sum(isnull(money01,0))
		,sum(isnull(money02,0)),sum(isnull(money03,0)),sum(isnull(money04,0)),sum(isnull(money05,0)),sum(isnull(money06,0))
	from @tmp
	where gno='1'
	group by LEFT(makeno,1)
	
	--合計
	insert into @tmp(gno,timea,weight01,weight02,money01,money02,money03,money04,money05,money06)
	select '3',sum(isnull(timea,0)),sum(isnull(weight01,0)),sum(isnull(weight02,0)),sum(isnull(money01,0))
		,sum(isnull(money02,0)),sum(isnull(money03,0)),sum(isnull(money04,0)),sum(isnull(money05,0)),sum(isnull(money06,0))
	from @tmp
	where gno='1'
	
	update @tmp set rate01 = case when money06=0 then 0 else ROUND(money01/money06*100,2) end
		,rate02 = case when money06=0 then 0 else ROUND(money02/money06*100,2) end
		,rate03 = case when money06=0 then 0 else ROUND(money03/money06*100,2) end
		,rate04 = case when money06=0 then 0 else ROUND(money04/money06*100,2) end
		,rate05 = case when money06=0 then 0 else ROUND(money05/money06*100,2) end
		,price01 = case when weight02=0 then 0 else ROUND((isnull(money02,0)+isnull(money03,0)+isnull(money04,0)+isnull(money05,0))/weight02,4) end
		,price02 = case when weight02=0 then 0 else ROUND(money06/weight02,4) end
	
	update @tmp set mon=LEFT(c.datea,6)
	from @tmp a
	left join view_cuts b on a.makeno=b.cname
	left join view_cut c on b.accy=c.accy and b.noa=c.noa
	where gno='1'
	
	select gno
		,'日期：'+case when @t_bdate=@t_edate then @t_bdate else @t_bdate+' ~ '+@t_edate end aa
		,row_number()over(order by gno,makeno) rr
		,CAST(ROW_NUMBER()over(order by gno,makeno) as nvarchar) rr
		,CAST(dime as nvarchar) a01
		,CAST(radius as nvarchar) a02
		,CAST(width as nvarchar) a03
		,CAST(lengthb as nvarchar) a04
		,makeno a05
		,cust a06
		,pvcno a07
		,isnull(cspec,'') a08
		,peno a09
		,pe a10
		,CAST(timea as nvarchar) a11
		,dbo.getComma(weight01,-1) a12
		,dbo.getComma(weight02,-1) a13
		,dbo.getComma(money01,0) a14
		,dbo.getComma(rate01,-1) a15
		,dbo.getComma(money02,0) a16
		,dbo.getComma(rate02,-1) a17
		,dbo.getComma(money03,0) a18
		,dbo.getComma(rate03,-1) a19
		,dbo.getComma(money04,0) a20
		,dbo.getComma(rate04,-1) a21
		,dbo.getComma(money05,0) a22
		,dbo.getComma(rate05,-1) a23
		,dbo.getComma(money06,0) a24
		,dbo.getComma(price01,4) a25
		,dbo.getComma(price02,4) a26
		,mon a27
	from @tmp
	order by gno,makeno;
	
z_cub_rkp09:--z_cub_rkp09	批量管制卡
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_path nvarchar(max) = '[1]'
	declare @t_db nvarchar(max) = '[2]'
	declare @t_bdate nvarchar(20) = case when '#non' = [4] then '' else [4] end
	declare @t_edate nvarchar(20) = case when '#non' = [5] then char(255) else [5] end
	declare @t_makeno nvarchar(max) = case when '#non' = [8] then '' else [8] end
	declare @t_uno nvarchar(max) = case when '#non' = [9] then '' else [9] end
	------------------------------------------------------------------------------------
	declare @tmpa table(
		sel int identity(1,1)
		,makeno nvarchar(30)		
	)
	insert into @tmpa(makeno)
	select a.makeno
	from view_cubs a
	left join view_cub b on a.accy=b.accy and a.noa=b.noa
	where ISNULL(b.datea,'') between @t_bdate and @t_edate
	and (len(@t_makeno)=0 or @t_makeno=a.makeno)
	and (len(@t_uno)=0 or exists(select * from view_cuts where bno=@t_uno and cname=a.makeno))
	---------------------------------------------------------------------------
	declare @tmpb table(
		sel int identity(1,1)
		,gno nvarchar(10)
		,makeno nvarchar(30)
		,tmakeno nvarchar(30)
		,pno int
		,typea nvarchar(30)
		,datea nvarchar(20)
		,accy nvarchar(10)
		,noa nvarchar(20)
		,noq nvarchar(10)
		,size nvarchar(max)
		,pvcno nvarchar(20)
		,pvc nvarchar(50)	
		
		,mount float
		,[weight] float
		,[money] float
		,memo nvarchar(max)

		--良品
		,mount1 float--數量	
		,length1 float--米數	
		,weight1 float--重量
		
		--不良品
		,mount2 float--數量	
		,weight2 float--重量
		
		--餘料	
		,weight3 float
		--廢料
		,weight4 float
		--工時
		,mins float
		--客戶
		,custno nvarchar(20)
		,cust nvarchar(max)
		--合約NO         生產日報表
		,contractno nvarchar(30)
		--規格尺寸
		,asize nvarchar(max)
		--皮膜         生產日報表
		--保謢膜         生產日報表
		,pveno nvarchar(20)
		,pve nvarchar(50)
		--背漆           生產日報表
		,item1 nvarchar(50)
		--製造批號
		--makeno 
		--鋼捲材質       生產日報表
		,spec nvarchar(50)
		--原鋼捲規格
		,bsize nvarchar(max)
		--鋼捲批號
		,uno nvarchar(30)
		--原鋼捲母號
		,uno2 nvarchar(30)
		--投入重量       生產日報表
		,w01 float
		--完工重量       進倉單
		,w02 float
		--總損耗        (投入重量-完工重量)/投入重量 請以%表達	
		,rate01 float
	)
	declare @makeno nvarchar(20)
	
	declare cursor_table cursor for
	select makeno from @tmpa	
	open cursor_table
	fetch next from cursor_table
	into @makeno
	while(@@FETCH_STATUS <> -1)
	begin	
		--CUB
		insert into @tmpb(makeno,tmakeno,pno,typea,datea,accy,noa,noq,size,memo
			,mount1,length1,weight1
			,mount2,weight2
			,weight3
			,weight4
			,mins)
		select a.makeno,a.makeno,1,'生產',b.datea,a.accy,a.noa,a.noq
		--生產："LENGTHB"固定以" C"表達
			,CAST(a.dime as nvarchar)+'+'+CAST(a.radius as nvarchar)
				+'*'+CAST(a.width as nvarchar)+'*C'
			,a.memo
			,0 mount1
			,ISNULL(a.w09,0) length1
			,isnull(a.hweight,0) weight1
			,0 mount2
			,0 weight2
			,0 weight3
			,ISNULL(a.price,0) weight04
			,ISNULL(a.mins,0) mins
		from view_cubs a
		left join view_cub b on a.accy=b.accy and a.noa=b.noa
		where a.makeno=@makeno
		--CUC
		insert into @tmpb(makeno,tmakeno,pno,typea,datea,accy,noa,noq,size,memo
			,mount1,length1,weight1
			,mount2,weight2
			,weight3
			,weight4
			,mins)
		select a.cubno,a.cubno,2,b.typea,b.datea,a.accy,a.noa,a.noq
			--分條：最後請固定加上"C"
			,a.size2+'*'+CAST(a.width as nvarchar)+'*'+CAST(a.lengthb as nvarchar) + case when CHARINDEX('分條',b.typea)>0 then 'C' else '' end
			,a.memo
			,case when CHARINDEX('分條',b.typea)>0 then a.mount2 when CHARINDEX('裁切',b.typea)>0 then a.mount3 else 0 end
			,case when CHARINDEX('分條',b.typea)>0 then 0 when CHARINDEX('裁切',b.typea)>0 then 0 else 0 end
			,case when CHARINDEX('分條',b.typea)>0 then a.weight2 when CHARINDEX('裁切',b.typea)>0 then a.weight3 else 0 end
			,0 mount2
			,ISNULL(a.weight8,0)+ISNULL(a.weight9,0)+ISNULL(a.weight10,0) weight2
			,ISNULL(a.weight4,0) weight3
			,ISNULL(a.waste,0)+ISNULL(a.weight7,0) weight4
			,isnull(a.mins,0) mins
		from view_cucs a
		left join view_cuc b on a.accy=b.accy and a.noa=b.noa
		where a.cubno = @makeno
		--CUT
		insert into @tmpb(makeno,tmakeno,pno,typea,datea,accy,noa,noq,size,memo
			,mount1,length1,weight1
			,mount2,weight2
			,weight3
			,weight4
			,mins)
		select a.cname,a.cname,3,'進倉',b.datea,a.accy,a.noa,a.noq
			,CAST(a.dime as nvarchar)+'+'+CAST(a.radius as nvarchar)
				+'*'+CAST(a.width as nvarchar)+'*'+CAST(a.lengthb as nvarchar)
			,a.memo
			,ISNULL(a.mount,0) mount1
			,0 length1
			,ISNULL(a.[weight],0) weight1
			,0 mount2,0 weight2
			,0 weight3,0 weight4,0 mins 
		from view_cuts a
		left join view_cut b on a.accy=b.accy and a.noa=b.noa
		where a.cname = @makeno
		
		--再投入
		insert into @tmpb(makeno,tmakeno,pno,typea,datea,accy,noa,noq,size,memo
			,mount1,length1,weight1
			,mount2,weight2
			,weight3
			,weight4
			,mins)
		select @makeno,b.makeno,5,'再投入',c.datea,b.accy,b.noa,b.noq
		--生產："LENGTHB"固定以" C"表達
			,CAST(b.dime as nvarchar)+'+'+CAST(b.radius as nvarchar)
				+'*'+CAST(b.width as nvarchar)+'*C'
			,b.memo
			,0 mount1
			,ISNULL(b.w09,0) length1
			,isnull(b.hweight,0) weight1
			,0 mount2
			,0 weight2
			,0 weight3
			,ISNULL(b.price,0) weight04
			,ISNULL(b.mins,0) mins
		from view_cuts a
		left join view_cubs b on a.bno=b.uno
		left join view_cub c on b.accy=c.accy and b.noa=c.noa
		where a.cname=@makeno	
		and b.noa is not null
		
		fetch next from cursor_table
		into @makeno
	end
	close cursor_table
	deallocate cursor_table
	
	update @tmpb set gno='1'
	
	insert into @tmpb(gno,pno,makeno,tmakeno,typea,mount1,weight1,mount2,weight2,weight3,weight4,mins)
	select '2',4,makeno,makeno,typea,SUM(ISNULL(mount1,0)),SUM(ISNULL(weight1,0)),SUM(ISNULL(mount2,0)),SUM(ISNULL(weight2,0))
		,SUM(ISNULL(weight3,0)),SUM(ISNULL(weight4,0)),SUM(ISNULL(mins,0))
	from @tmpb
	where typea='進倉'
	group by makeno,typea
	
	
	update @tmpb set custno=b.custno,cust=b.comp,contractno=b.ordeno+'-'+b.no2
		,asize=CAST(b.dime as nvarchar)+'+'+CAST(b.radius as nvarchar)+'*'+CAST(b.width as nvarchar)+'*'+CAST(b.lengthb as nvarchar)
		,pveno=c.productno,pve=c.product,item1=d.product
		,spec=b.size
		,bsize=CAST(b.dime as nvarchar)+'*'+CAST(b.width as nvarchar)
		,uno=b.uno,uno2=e.uno2
		,w01=b.w03,w02=f.[weight]
		,rate01= case when ISNULL(b.hweight,0)=0 then 0 else  round((ISNULL(b.hweight,0)-ISNULL(f.[weight],0))*100/ISNULL(b.hweight,0),2) end
	from @tmpb a
	left join view_cubs b on a.makeno=b.makeno
	outer apply(select top 1 * from view_cubt where accy=b.accy and noa=b.noa and nor=b.noq and kind='2') c
	outer apply(select top 1 x.* from view_cubu x
		left join ucc y on x.productno=y.noa
		where x.accy=b.accy and x.noa=b.noa and y.groupano='A03') d
	left join view_uccb e on b.uno=e.uno
	outer apply(select SUM(ISNULL([weight],0)) [weight] from view_cuts where cname=a.makeno) f
	
	update @tmpb set spec = b.productno +' '+ ISNULL(c.product,'') 
	from @tmpb a
	left join view_uccb b on a.uno=b.uno
	left join spec c on b.spec=c.noa
	
	--沒有皮膜就改顯示面漆
	update @tmpb set pvcno=c.productno,pvc=c.product
	from @tmpb a
	outer apply(select top 1 * from view_cubt where accy=a.accy and noa=a.noa and nor=a.noq and kind='1') c
	where c.noa is not null
	
	update @tmpb set pvcno=b.productno,pvc=b.product
	from @tmpb a
	outer apply(select top 1 x.* 
			from view_cubu x 
			left join ucc y on x.productno=y.noa 
			where x.accy=a.accy and x.noa=a.noa and y.groupano='A05') b
	where len(ISNULL(pvcno,''))=0
	
	--換頁
	insert into @tmpb(makeno,gno,pno)select makeno,'3',999 from @tmpb group by makeno
	
	select gno,pno
		, cust a01
		, pveno+' '+pve a02
		, makeno a03a
		, tmakeno a03b
		, bsize a04
		, dbo.getComma(w01,0) a05
		, contractno a06
		, item1 a07
		, spec a08
		, uno a09
		, dbo.getComma(w02,0) a10
		, asize a11
		, uno2 a12
		, cast(rate01 as nvarchar)+' %' a13
		,pvcno a14
		
		,datea b01
		,typea b02
		,noa b03
		,size b04
		,mount1 b05
		,length1 b06
		,weight1 b07
		,mount2 b08
		,weight2 b09
		,weight3 b10
		,weight4 b11
		,mins b12
		,memo b13
	from @tmpb 
	order by makeno,pno;

z_cub_rkp07:--z_cub_rkp07 包裝費用明細表
	SET QUOTED_IDENTIFIER OFF 
	declare @cmd nvarchar(max)
	declare @t_path nvarchar(max) = '[1]'
	declare @t_db nvarchar(max) = '[2]'

	declare @t_bdate nvarchar(20) = case when '#non' = [4] then '' else [4] end
	declare @t_edate nvarchar(20) = case when '#non' = [5] then char(255) else [5] end
	declare @t_bcustno nvarchar(20) =case when '#non' = [6] then '' else [6] end
	declare @t_ecustno nvarchar(20) = case when '#non' = [7] then char(255) else [7] end
	------------------------------------------------------------------------------------------
	declare @tmp table(
		sel int identity(1,1)
		,gno nvarchar(10)
		,datea nvarchar(10)
		,vccno nvarchar(20)
		,ordeno nvarchar(20)
		,stype nvarchar(20)
		,custtype nvarchar(max)
		,ccusttype nvarchar(max)
		,custno nvarchar(20)
		,cust nvarchar(max)
		,nick nvarchar(max)
		,[weight] float
		,m01 float	--包裝
		,m02 float	--海運費	
		,m03 float	--拖櫃費	
		,m04 float	--報關費	
		,m05 float	--保險費	
		,m06 float	--商建費/推廣費	
		,m07 float	--貨運費
		,m08 float	--裝櫃
		,total float
		,rate float
	)
	insert into @tmp(gno,datea,vccno,custno,[weight],m01,m07)
	select '1',a.datea,a.noa,a.custno
		,case when a.typea='1' then 1 else -1 end * a.[weight]
		,a.cartrips,a.tranmoney
	from view_vcc a
	where isnull(a.datea,'') between @t_bdate and @t_edate
	--and ISNULL(a.typea,'')='1'
	and ISNULL(a.custno,'') between @t_bcustno and @t_ecustno
	
	declare @ordeno nvarchar(20)
	declare @stype nvarchar(20)
	declare @vccno nvarchar(20)
	declare @chgitem nvarchar(50)
	declare @total float
	
	declare @custtype nvarchar(20)
	declare @ccusttype nvarchar(20)
	
	declare cursor_table cursor for
	select a.vccno from @tmp a
	open cursor_table
	fetch next from cursor_table
	into @vccno
	while(@@FETCH_STATUS <> -1)
	begin
	
		select @ordeno='',@stype='',@custtype='',@ccusttype=''
		
		select top 1 @ordeno=a.ordeno
			,@stype=case b.stype when '1' then '內銷' when '3' then '外銷' else b.stype end
			,@custtype=c.custpro
			,@ccusttype=d.product
		from view_vccs a
		left join view_orde b on a.ordeno=b.noa
		outer apply(select top 1 * from view_ordes where noa=a.ordeno and no2=a.no2) c
		left join adpro d on c.custpro=d.noa
		where a.noa=@vccno and len(ISNULL(a.ordeno,''))>0
		order by a.noq
		update @tmp set ordeno=@ordeno,stype=@stype,custtype=@custtype,ccusttype=@ccusttype where vccno=@vccno
	
		fetch next from cursor_table
		into @vccno
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select a.vccno,b.chgitem,isnull(b.total,0)
	from @tmp a
	left join paybs b on a.vccno=b.payno
	where b.noa is not null
	open cursor_table
	fetch next from cursor_table
	into @vccno,@chgitem,@total
	while(@@FETCH_STATUS <> -1)
	begin
		if CHARINDEX('包裝',@chgitem)>0
		begin
			update @tmp set m01=ISNULL(m01,0)+@total where vccno=@vccno
		end
		else if CHARINDEX('海運費',@chgitem)>0
		begin
			update @tmp set m02=ISNULL(m02,0)+@total where vccno=@vccno
		end
		else if CHARINDEX('拖櫃費',@chgitem)>0
		begin
			update @tmp set m03=ISNULL(m03,0)+@total where vccno=@vccno
		end
		else if CHARINDEX('報關費',@chgitem)>0
		begin
			update @tmp set m04=ISNULL(m04,0)+@total where vccno=@vccno
		end
		else if CHARINDEX('保險費',@chgitem)>0
		begin
			update @tmp set m05=ISNULL(m05,0)+@total where vccno=@vccno
		end
		else if CHARINDEX('商建費',@chgitem)>0 or CHARINDEX('推廣費',@chgitem)>0
		begin
			update @tmp set m06=ISNULL(m06,0)+@total where vccno=@vccno
		end
		else if CHARINDEX('貨運費',@chgitem)>0
		begin
			update @tmp set m07=ISNULL(m07,0)+@total where vccno=@vccno
		end
		else if CHARINDEX('裝櫃',@chgitem)>0
		begin
			update @tmp set m08=ISNULL(m08,0)+@total where vccno=@vccno
		end
		
		fetch next from cursor_table
		into @vccno,@chgitem,@total
	end
	close cursor_table
	deallocate cursor_table
	
	----------------------------------------------------------------------------------------
	update @tmp set cust=b.comp,nick=b.nick
		--,custtype=b.typea,ccusttype=c.namea
	from @tmp a
	left join cust b on a.custno=b.noa
--	left join custtype c on b.typea=c.noa
	----------------------------------------------------------------------------------------
	insert into @tmp(gno,[weight],m01,m02,m03,m04,m05,m06,m07,m08)
	select '2',SUM(ISNULL([weight],0))
		,SUM(ISNULL(m01,0)),SUM(ISNULL(m02,0)),SUM(ISNULL(m03,0)),SUM(ISNULL(m04,0))
		,SUM(ISNULL(m05,0)),SUM(ISNULL(m06,0)),SUM(ISNULL(m07,0)),SUM(ISNULL(m08,0))
	from @tmp
	
	
	update @tmp set total=ISNULL(m01,0)+ISNULL(m02,0)+ISNULL(m03,0)+ISNULL(m04,0)
		+ISNULL(m05,0)+ISNULL(m06,0)+ISNULL(m07,0)+ISNULL(m08,0)
	update @tmp set rate = case when ISNULL([weight],0)=0 then 0 else ROUND(total/[weight]*100,2) end

	select gno
		,ROW_NUMBER()over(order by gno,datea,vccno) rr
		,vccno a01
		,datea a02
		,nick a03
		,ccusttype a04
		,dbo.getComma([weight],-1) a05
		,dbo.getComma(m01,-1) a06
		,dbo.getComma(m08,-1) a07
		,dbo.getComma(m02,-1) a08
		,dbo.getComma(m03,-1) a09
		,dbo.getComma(m04,-1) a10
		,dbo.getComma(m05,-1) a11
		,dbo.getComma(m06,-1) a12
		,dbo.getComma(m07,-1) a13
		,dbo.getComma(total,-1) a14	
		,dbo.getComma(rate,-1) a15
		,stype a16
	from @tmp
	order by gno,datea,vccno;
	
z_cub_rkp05:--z_cub_rkp05 分批成本表	
	SET QUOTED_IDENTIFIER OFF 
	declare @cmd nvarchar(max)
	declare @t_path nvarchar(max) = '[1]'
	declare @t_db nvarchar(max) = '[2]'
	
	declare @t_bdate nvarchar(max) = case when '#non' = [4] then '' else [4] end
	declare @t_edate nvarchar(max) = case when '#non' = [5] then char(255) else [5] end
	declare @t_bcustno nvarchar(20) =case when '#non' = [6] then '' else [6] end
	declare @t_ecustno nvarchar(20) = case when '#non' = [7] then char(255) else [7] end
	declare @t_makeno nvarchar(max) = case when '#non' = [8] then '' else [8] end
	declare @t_pvcno nvarchar(max) = case when '#non' = [14] then '' else [14] end
	--------------------------------------------------------------------------------
	declare @tmp table(
		sel int identity(1,1)
		,gno nvarchar(10)
		,pno int
		,recno int
		,accy nvarchar(10)
		,noa nvarchar(20)
		,noq nvarchar(10)
		,datea nvarchar(20)
		,makeno nvarchar(20),
		custno nvarchar(20),
		cust nvarchar(50),
		dime float,
		radius float,
		width float,
		lengthb float,
		pvc nvarchar(20),
		--coil
		uno01 nvarchar(30),
		weight01 float,
		price01 float,
		money01 float,
		--pvc
		uno02 nvarchar(30),
		mount02 float,
		weight02 float,
		price02 float,
		money02 float,
		--pe 1
		uno03 nvarchar(30),
		productno03 nvarchar(20),
		dime03 float,
		width03 float,
		lengthb03 float,
		mount03 float,
		weight03 float,
		price03 float,
		money03 float,

		--A01 接著劑	
		weight04 float,
		price04 float,
		money04 float,
		--A02 接著劑稀釋劑
		weight05 float,
		price05 float,
		money05 float,	
		--A03 背漆
		weight06 float,
		price06 float,
		money06 float,
		--A04 背漆稀釋液
		weight07 float,
		price07 float,
		money07 float,	
		--A05 面漆
		weight08 float,
		price08 float,
		money08 float,
		
		weight10 float,--投入重量
		money10 float,--半成品金額
		weight11 float,--完工重量
		
		--半成品
		money11a float,--直接人工
		money12a float,--製造費用
		money13a float,--電費
		money14a float,--瓦斯費
		--成品
		money11b float,--直接人工
		money12b float,--製造費用
		
		weight12 float,--成品重量
		money13 float,--總計
		price10 float,--單位成本
		rate01 float,--損耗率
		mon nvarchar(10),--完工月份
		
		memo nvarchar(max)
	)
	--鋼捲
	insert into @tmp(gno,pno,accy,noa,noq,datea,makeno,custno,cust,dime,radius,width,lengthb
		,uno01,weight01,money01)
	select '1',1,a.accy,a.noa,a.noq,b.datea,a.makeno,a.custno,a.comp,a.dime,a.radius,a.width,a.lengthb
		,a.uno,a.x01,a.y01
	from view_cubs a
	left join view_cub b on a.noa=b.noa
	where b.datea between @t_bdate and @t_edate
	and (ISNULL(a.custno,'') between @t_bcustno and @t_ecustno)
	and (len(@t_makeno)=0 or charindex(@t_makeno,a.makeno)>0)
	if len(@t_pvcno)>0
		delete @tmp 
		from @tmp a
		outer apply(select top 1 * from view_cubt where a.accy=accy and a.noa=noa and a.noq=nor and kind='1' and productno=@t_pvcno) b
		where b.noa is null
	
	--皮膜
	update @tmp set mount02=c.[weight],weight02=b.x02,money02=b.y02
		,pvc=c.productno
	from @tmp a
	left join view_cubs b on a.accy=b.accy and a.noa=b.noa and a.noq=b.noq
	outer apply(select top 1 * from view_cubt where a.accy=accy and a.noa=noa and a.noq=nor and kind = '1' order by noq) c
	--where b.noa is not null 
	
	--保護膜
	declare @accy nvarchar(10)
	declare @noa nvarchar(20)
	declare @noq nvarchar(10)
	declare @uno nvarchar(30)
	declare @productno nvarchar(20)
	declare @mount float
	declare @weight float
	declare @money float
	declare @n int 
	declare @sel int

	declare cursor_table cursor for
	select accy,noa,noq from @tmp group by accy,noa,noq
	open cursor_table
	fetch next from cursor_table
	into @accy,@noa,@noq
	while(@@FETCH_STATUS <> -1)
	begin
		declare cursor_table2 cursor for
		select a.uno,a.productno,a.[weight],a.[wweight],a.scost
		from view_cubt a
		where a.accy=@accy and a.noa=@noa and a.nor=@noq and kind='2'
		open cursor_table2
		fetch next from cursor_table2
		into @uno,@productno,@mount,@weight,@money
		while(@@FETCH_STATUS <> -1)
		begin
			set @sel = 0
			select @sel = sel from @tmp where accy=@accy and noa=@noa and noq=@noq and len(isnull(uno03,''))=0
			if @sel>0
			begin
				update @tmp set uno03=@uno,productno03=@productno,mount03=@mount,weight03=@weight,money03=@money
					,dime03=b.dime,width03=b.width,lengthb03=b.lengthb
				from @tmp a
				left join view_uccb b on b.uno=@uno
				where a.sel=@sel
			end
			else
			begin
				insert into @tmp(gno,pno,accy,noa,noq,makeno,uno03,productno03,mount03,weight03,money03,dime03,width03,lengthb03)
				select '2',2,@accy,@noa,@noq,c.makeno,@uno,@productno,@mount,@weight,@money,b.dime,b.width,b.lengthb
				from @tmp a
				left join view_uccb b on b.uno=@uno
				left join view_cubs c on a.accy=c.accy and a.noa=c.noa and a.noq=c.noq
				where a.accy=@accy and a.noa=@noa and a.noq=@noq and gno='1'
			end
	
			fetch next from cursor_table2
			into @uno,@productno,@mount,@weight,@money
		end
		close cursor_table2
		deallocate cursor_table2

		fetch next from cursor_table
		into @accy,@noa,@noq
	end
	close cursor_table
	deallocate cursor_table

--select *
--from(
--select makeno,SUM(isnull(money03,0)) money03 from @tmp group by makeno) a
--left join view_cubs b on a.makeno=b.makeno 
--where a.money03!=b.y03
--return	
	update @tmp set 
		weight04=b.x04,money04=b.y04  --A01 接著劑
		,weight05=b.x05,money05=b.y05 --A02 接著劑稀釋劑
		,weight06=b.x06,money06=b.y06 --A03 背漆
		,weight07=b.x07,money07=b.y07 --A04 背漆稀釋液
		,weight08=b.x08,money08=b.y08 --A05 面漆
		,weight10=b.w03               --投入重量
		,money10=ISNULL(b.y01,0)+ISNULL(b.y02,0)+ISNULL(b.y03,0)+ISNULL(b.y04,0)
			+ISNULL(b.y05,0)+ISNULL(b.y06,0)+ISNULL(b.y07,0)+ISNULL(b.y08,0)   --半成品金額
		,weight11=b.hweight           --完工重量
		,money11a=b.w01               --直接人工
		,money12a=b.w02               --製造費用
		,money13a=b.w04               --電費
		,money14a=b.w05              --瓦斯費
		,weight12=b.hweight --成品重量
		,money13 = b.total --總計
	from @tmp a
	left join view_cubs b on a.accy=b.accy and a.noa=b.noa and a.noq=b.noq and pno=1
	where b.noa is not null

	--update @tmp set 
	--	money11b = 0   --成品 直接人工
	--	,money12b = 0  --成品 製造費用
	--from @tmp a
	--left join (select cname,SUM(ISNULL([weight],0)) [weight] from view_cuts group by cname) b on a.makeno=b.cname
	--where a.pno=1
	
	update @tmp set price10=case when weight12=0 then 0 else round(money13/weight12,2) end
		,rate01 = case when weight10=0 then 0 else round((isnull(weight10,0)-isnull(weight12,0))/weight10*100,2) end
	
	update @tmp set mon=LEFT(c.datea,6)
	from @tmp a
	left join view_cuts b on a.makeno=b.cname
	left join view_cut c on b.accy=c.accy and b.noa=c.noa
	where pno=1
	
	update @tmp set mon=b.mon
	from @tmp a
	outer apply(select * from @tmp where a.accy=accy and a.noa=noa and a.noq=noq and pno=1) b
	where a.pno=2
	
	--delete @tmp where not isnull(mon,'') between left(@t_bdate,6) and left(@t_edate,6)
	
	update @tmp set recno=b.recno
	from @tmp a
	left join (select sel,ROW_NUMBER()over(order by makeno,accy,noa,noq) recno from @tmp where pno=1) b on a.sel=b.sel
	where b.sel is not null
	
	insert into @tmp(gno,pno,makeno,weight01,money01,mount02,weight02,money02
		,mount03,weight03,money03,weight04,money04,weight05,money05,weight06,money06
		,weight07,money07,weight08,money08,weight10,money10,weight11
		,money11a,money12a,money13a,money14a,money11b,money12b
		,weight12,money13)
	select '3',3,CHAR(255),sum(isnull(weight01,0)),sum(isnull(money01,0)),sum(isnull(mount02,0))
		,sum(isnull(weight02,0)),sum(isnull(money02,0))
		,sum(isnull(mount03,0)),sum(isnull(weight03,0)),sum(isnull(money03,0)),sum(isnull(weight04,0)),sum(isnull(money04,0))
		,sum(isnull(weight05,0)),sum(isnull(money05,0)),sum(isnull(weight06,0)),sum(isnull(money06,0))
		,sum(isnull(weight07,0)),sum(isnull(money07,0)),sum(isnull(weight08,0)),sum(isnull(money08,0))
		,sum(isnull(weight10,0)),sum(isnull(money10,0)),sum(isnull(weight11,0))
		,sum(isnull(money11a,0)),sum(isnull(money12a,0)),sum(isnull(money13a,0)),sum(isnull(money14a,0))
		,sum(isnull(money11b,0)),sum(isnull(money12b,0)),sum(isnull(weight12,0)),sum(isnull(money13,0))
	from @tmp

	update @tmp set 
		 price01 = case when ISNULL(weight01,0) = 0 then 0 else round(money01/weight01,2) end
		 --皮膜  單價是用M算
		,price02 = case when ISNULL(mount02,0) = 0 then 0 else round(money02/mount02,2) end
		 --保護膜  單價是用M算
		,price03 = case when ISNULL(mount03,0) = 0 then 0 else round(money03/mount03,2) end
		,price04 = case when ISNULL(weight04,0) = 0 then 0 else round(money04/weight04,2) end
		,price05 = case when ISNULL(weight05,0) = 0 then 0 else round(money05/weight05,2) end
		,price06 = case when ISNULL(weight06,0) = 0 then 0 else round(money06/weight06,2) end
		,price07 = case when ISNULL(weight07,0) = 0 then 0 else round(money07/weight07,2) end
		,price08 = case when ISNULL(weight08,0) = 0 then 0 else round(money08/weight08,2) end
		,price10 = case when ISNULL(weight12,0) = 0 then 0 else round(money13/weight12,2) end
		
	select gno
		,recno rr
		,makeno a01
		,cust a02
		,case when isnull(dime,0)=0 then '' else dime end a03
		,case when isnull(radius,0)=0 then '' else radius end a04
		,case when isnull(width,0)=0 then '' else width end a05
		,case when isnull(lengthb,0)=0 then '' else lengthb end a06
		,pvc a07
		,dbo.getComma(weight01,-1) a08
		,price01 a09
		,dbo.getComma(money01,-1) a10
		,dbo.getComma(mount02,-1) a11
		,dbo.getComma(weight02,-1) a12
		,price02 a13
		,dbo.getComma(money02,-1) a14
		,productno03 a15
		,dime03 a16
		,width03 a17
		,lengthb03 a18
		,dbo.getComma(mount03,-1) a19
		,dbo.getComma(weight03,-1) a20
		,price03 a21
		,dbo.getComma(money03,-1) a22
		
		,dbo.getComma(weight04,-1) a23
		,price04 a24
		,dbo.getComma(money04,-1) a25
		,dbo.getComma(weight05,-1) a26
		,price05 a27
		,dbo.getComma(money05,-1) a28
		,dbo.getComma(weight06,-1) a29
		,price06 a30
		,dbo.getComma(money06,-1) a31
		,dbo.getComma(weight07,-1) a32
		,price07 a33
		,dbo.getComma(money07,-1) a34
		,dbo.getComma(weight08,-1) a35
		,price08 a36
		,dbo.getComma(money08,-1) a37
		,dbo.getComma(weight10,-1) a38        --投入重量
		,dbo.getComma(money10,-1) a39         --半成品金額
		,dbo.getComma(weight11,-1) a40        --完工重量
		
		,dbo.getComma(money11a,-1) a41        --半成品 直接人工
		,dbo.getComma(money12a,-1) a42        --半成品 製造費用
		,dbo.getComma(money13a,-1) a43        --半成品 電費
		,dbo.getComma(money14a,-1) a44        --半成品 瓦斯費
		,dbo.getComma(weight12,-1) a45        --成品重量
		,dbo.getComma(money13,-1) a46         --總計
		,price10 a47                          --單位成本
		,rate01 a48                           --損耗率
		,mon a49                              --完工月份
	from @tmp
	order by makeno,accy,noa,noq,pno;
z_cub_rkp03: -- z_cub_rkp03  成本結轉
	---  要先計算  人工費用、製造費用、電費、瓦斯費
	SET QUOTED_IDENTIFIER OFF 
	declare @cmd nvarchar(max)
	declare @t_path nvarchar(max) = '[1]'
	declare @t_db nvarchar(max) = '[2]'
	
	declare @t_bdate nvarchar(10) = case when '#non'=[4] then '' else [4] end
	declare @t_edate nvarchar(10) = case when '#non'=[5] then char(255) else [5] end
	
	--=============================================================================================
	declare @accy nvarchar(10),@noa nvarchar(20),@noq nvarchar(10),@makeno nvarchar(30)
	declare @cost float
	declare @uno nvarchar(30)
	declare @date nvarchar(20)
	declare @mon nvarchar(20)
	declare @weight float
	declare @totweight float
	declare @m01 float,@m02 float,@m03 float,@m04 float
	declare @totm01 float,@totm02 float,@totm03 float,@totm04 float
	
	declare @y01 float,@y02 float,@y03 float,@y04 float,@y05 float,@y06 float,@y07 float,@y08 float,@total float
	declare @n int = 0,@m int = 0
	
	declare @tmp table(
		gno nvarchar(10)
		,title nvarchar(max)
		,n int
		,ms float
	)
	
	DECLARE @t1 DATETIME
	DECLARE @t2 DATETIME
	declare @tott1 datetime=getdate(),@tott2 datetime
	--=============================================================================================
	--=============================================================================================
	--半成品
	SET @t1 = GETDATE()
	IF OBJECT_ID('tempdb..#z_cub_rkp03_aa')is not null
	BEGIN
		drop table #z_cub_rkp03_aa
	END
	create table #z_cub_rkp03_aa(
		accy nvarchar(10)
		,noa nvarchar(20)
		,noq nvarchar(10)
		,y01 float
		,y02 float
		,y03 float
		,y04 float
		,y05 float
		,y06 float
		,y07 float
		,y08 float
		,total float
		,x01 float
		,x02 float
		,x03 float
		,x04 float
		,x05 float
		,x06 float
		,x07 float
		,x08 float
		,w03 float
	)
	declare cursor_table cursor for
		select a.accy,a.noa,a.noq,a.makeno 
		from view_cubs a
		left join view_cub b on a.accy=b.accy and a.noa=b.noa 
		where len(isnull(a.makeno,''))>0 
		and b.datea between @t_bdate and @t_edate
		order by a.accy,a.noa,a.noq
	open cursor_table
	fetch next from cursor_table
	into @accy,@noa,@noq,@makeno
	while(@@FETCH_STATUS <> -1)
	begin
		insert into #z_cub_rkp03_aa(accy,noa,noq
			,y01,y02,y03,y04,y05,y06,y07,y08,total
			,x01,x02,x03,x04,x05,x06,x07,x08,w03)
		select @accy,@noa,@noq
			,x01,x02,x03,y01,y02,y03,y04,y05,total
			,wx01,wx02,wx03,wy01,wy02,wy03,wy04,wy05,ww
		from dbo.makecost_rk(@makeno)
		
		fetch next from cursor_table
		into @accy,@noa,@noq,@makeno
	end
	close cursor_table
	deallocate cursor_table
	---update
	select @n=0
	
	declare cursor_table cursor for
		select accy from #z_cub_rkp03_aa group by accy
	open cursor_table
	fetch next from cursor_table
	into @accy
	while(@@FETCH_STATUS <> -1)
	begin
		set @cmd =
		"update cubs"+@accy+" set y01=b.y01,y02=b.y02,y03=b.y03
			,y04=b.y04,y05=b.y05,y06=b.y06,y07=b.y07,y08=b.y08
			,total=b.total
			,x01=b.x01,x02=b.x02,x03=b.x03,x04=b.x04
			,x05=b.x05,x06=b.x06,x07=b.x07,x08=b.x08
			,w03=b.w03
		from cubs"+@accy+" a
		left join #z_cub_rkp03_aa b on b.accy=@accy and b.noa=a.noa and b.noq=a.noq
		where b.noa is not null"
		execute sp_executesql @cmd,N'@accy nvarchar(10)'
		,@accy=@accy

		select @m = 0
		set @cmd =
		"select @m = count(1) 
		from cubs"+@accy+" a
		left join #z_cub_rkp03_aa b on b.accy=@accy and b.noa=a.noa and b.noq=a.noq
		where b.noa is not null"
		execute sp_executesql @cmd,N'@accy nvarchar(10),@m int output'
		,@accy=@accy,@m=@m output
		set @n = @n + @m

		fetch next from cursor_table
		into @accy
	end
	close cursor_table
	deallocate cursor_table
	SET @t2 = GETDATE()

	insert into @tmp(gno,title,n,ms)
	select '1'
		,'半成品成本-生產作業'
		,@n
		,round(DATEDIFF(millisecond,@t1,@t2)/1000,0)
	
	drop table #z_cub_rkp03_aa
	--=============================================================================================
	--=============================================================================================
	--出貨領料
	IF OBJECT_ID('tempdb..#z_cub_rkp03_bb')is not null
	BEGIN
		drop table #z_cub_rkp03_bb
	END
	create table #z_cub_rkp03_bb(
		accy nvarchar(10)
		,noa nvarchar(20)
		,noq nvarchar(10)
		,cost float
	)

	--=============================================================================================
	-- VCC
	SET @t1 = GETDATE()
	delete #z_cub_rkp03_bb
	declare cursor_table cursor for
		select a.accy,a.noa,a.noq 
		from view_vccs a
		left join view_vcc b on a.accy=b.accy and a.noa=b.noa 
		where len(isnull(a.uno,''))>0 
		and b.datea between @t_bdate and @t_edate
		order by a.accy,a.noa,a.noq
	open cursor_table
	fetch next from cursor_table
	into @accy,@noa,@noq
	while(@@FETCH_STATUS <> -1)
	begin
		select @cost=0
		select @cost = [money] from dbo.cost_rk('vccs',@accy,@noa,@noq) 
		insert into #z_cub_rkp03_bb(accy,noa,noq,cost)
		select @accy,@noa,@noq,@cost
		
		fetch next from cursor_table
		into @accy,@noa,@noq
	end
	close cursor_table
	deallocate cursor_table
	---update
	select @n = 0
	
	declare cursor_table cursor for
		select accy from #z_cub_rkp03_bb group by accy
	open cursor_table
	fetch next from cursor_table
	into @accy
	while(@@FETCH_STATUS <> -1)
	begin
		set @cmd =
		"update vccs"+@accy+" set scost=b.cost
		from vccs"+@accy+" a
		left join #z_cub_rkp03_bb b on b.accy=@accy and b.noa=a.noa and b.noq=a.noq
		where b.noa is not null"
		execute sp_executesql @cmd,N'@accy nvarchar(10)'
		,@accy=@accy
		
		select @m = 0
		set @cmd =
		"select @m = count(1) 
		from vccs"+@accy+" a
		left join #z_cub_rkp03_bb b on b.accy=@accy and b.noa=a.noa and b.noq=a.noq
		where b.noa is not null"
		execute sp_executesql @cmd,N'@accy nvarchar(10),@m int output'
		,@accy=@accy,@m=@m output
		set @n = @n + @m
		
		fetch next from cursor_table
		into @accy
	end
	close cursor_table
	deallocate cursor_table
	
	SET @t2 = GETDATE()
	insert into @tmp(gno,title,n,ms)
	select '1'
		,'領料成本-出貨作業'
		,@n
		,round(DATEDIFF(millisecond,@t1,@t2)/1000,0)
	--=============================================================================================
	-- GET
	SET @t1 = GETDATE()
	delete #z_cub_rkp03_bb
	declare cursor_table cursor for
		select a.accy,a.noa,a.noq 
		from view_gets a
		left join view_get b on a.accy=b.accy and a.noa=b.noa 
		where len(isnull(a.uno,''))>0 
		and b.datea between @t_bdate and @t_edate
		order by a.accy,a.noa,a.noq
	open cursor_table
	fetch next from cursor_table
	into @accy,@noa,@noq
	while(@@FETCH_STATUS <> -1)
	begin
		select @cost=0
		select @cost = [money] from dbo.cost_rk('gets',@accy,@noa,@noq) 
		insert into #z_cub_rkp03_bb(accy,noa,noq,cost)
		select @accy,@noa,@noq,@cost
		
		fetch next from cursor_table
		into @accy,@noa,@noq
	end
	close cursor_table
	deallocate cursor_table
	---update
	select @n = 0
	
	declare cursor_table cursor for
		select accy from #z_cub_rkp03_bb group by accy
	open cursor_table
	fetch next from cursor_table
	into @accy
	while(@@FETCH_STATUS <> -1)
	begin
		set @cmd =
		"update gets"+@accy+" set scost=b.cost
		from gets"+@accy+" a
		left join #z_cub_rkp03_bb b on b.accy=@accy and b.noa=a.noa and b.noq=a.noq
		where b.noa is not null"
		execute sp_executesql @cmd,N'@accy nvarchar(10)'
		,@accy=@accy
		
		select @m = 0
		set @cmd =
		"select @m = count(1) 
		from gets"+@accy+" a
		left join #z_cub_rkp03_bb b on b.accy=@accy and b.noa=a.noa and b.noq=a.noq
		where b.noa is not null"
		execute sp_executesql @cmd,N'@accy nvarchar(10),@m int output'
		,@accy=@accy,@m=@m output
		set @n = @n + @m
		
		fetch next from cursor_table
		into @accy
	end
	close cursor_table
	deallocate cursor_table
	
	SET @t2 = GETDATE()
	insert into @tmp(gno,title,n,ms)
	select '1'
		,'領料成本-鋼捲、物料'
		,@n
		,round(DATEDIFF(millisecond,@t1,@t2)/1000,0)
	--=============================================================================================
	-- CUBT
	SET @t1 = GETDATE()
	delete #z_cub_rkp03_bb
	declare cursor_table cursor for
		select a.accy,a.noa,a.noq 
		from view_cubt a
		left join view_cub b on a.accy=b.accy and a.noa=b.noa 
		where len(isnull(a.uno,''))>0 
		and b.datea between @t_bdate and @t_edate
		order by a.accy,a.noa,a.noq
	open cursor_table
	fetch next from cursor_table
	into @accy,@noa,@noq
	while(@@FETCH_STATUS <> -1)
	begin
		select @cost=0
		select @cost = [money] from dbo.cost_rk('cubt',@accy,@noa,@noq) 
		insert into #z_cub_rkp03_bb(accy,noa,noq,cost)
		select @accy,@noa,@noq,@cost
		
		fetch next from cursor_table
		into @accy,@noa,@noq
	end
	close cursor_table
	deallocate cursor_table
	---update
	select @n = 0
	
	declare cursor_table cursor for
		select accy from #z_cub_rkp03_bb group by accy
	open cursor_table
	fetch next from cursor_table
	into @accy
	while(@@FETCH_STATUS <> -1)
	begin
		set @cmd =
		"update cubt"+@accy+" set scost=b.cost
		from cubt"+@accy+" a
		left join #z_cub_rkp03_bb b on b.accy=@accy and b.noa=a.noa and b.noq=a.noq
		where b.noa is not null"
		execute sp_executesql @cmd,N'@accy nvarchar(10)'
		,@accy=@accy
		
		select @m = 0
		set @cmd =
		"select @m = count(1) 
		from cubt"+@accy+" a
		left join #z_cub_rkp03_bb b on b.accy=@accy and b.noa=a.noa and b.noq=a.noq
		where b.noa is not null"
		execute sp_executesql @cmd,N'@accy nvarchar(10),@m int output'
		,@accy=@accy,@m=@m output
		set @n = @n + @m
		
		fetch next from cursor_table
		into @accy
	end
	close cursor_table
	deallocate cursor_table
	drop table #z_cub_rkp03_bb
	
	SET @t2 = GETDATE()
	insert into @tmp(gno,title,n,ms)
	select '1'
		,'領料成本-皮膜、保護膜'
		,@n
		,round(DATEDIFF(millisecond,@t1,@t2)/1000,0)
	--=============================================================================================
	--=============================================================================================
	--成品進倉
	SET @t1 = GETDATE()
	IF OBJECT_ID('tempdb..#z_cub_rkp03_cc')is not null
	BEGIN
		drop table #z_cub_rkp03_cc
	END
	create table #z_cub_rkp03_cc(
		accy nvarchar(10)
		,noa nvarchar(20)
		,noq nvarchar(10)
		,mon nvarchar(20)
		,makeno nvarchar(30)
		,uno nvarchar(30)
		,cost float
		,m01 float --直接人工			
		,m02 float --製造費用
		,m03 float --電費
		,m04 float --瓦斯費
		,total float
	)

	declare cursor_table cursor for
		select a.accy,a.noa,a.noq,substring(a.datea,1,len(a.datea)-3),a.cname,a.bno,a.datea 
		from view_cuts a
		where len(isnull(a.bno,''))>0 
		and a.datea between @t_bdate and @t_edate
		order by a.accy,a.noa,a.noq
	open cursor_table
	fetch next from cursor_table
	into @accy,@noa,@noq,@mon,@makeno,@uno,@date
	while(@@FETCH_STATUS <> -1)
	begin
		set @cost = 0
		select @cost = [money] from dbo.money_rk(@uno,@date)
		insert into #z_cub_rkp03_cc(accy,noa,noq,mon,makeno,uno,cost
			,m01,m02,m03,m04,total)
		select @accy,@noa,@noq,@mon,@makeno,@uno,@cost
			,0,0,0,0,0
		
		fetch next from cursor_table
		into @accy,@noa,@noq,@mon,@makeno,@uno,@date
	end
	close cursor_table
	deallocate cursor_table
	-- 列出當期全部的資料
	declare @tmpc table(
		sel int identity(1,1)
		,accy nvarchar(20)
		,noa nvarchar(20)
		,noq nvarchar(10)
		,makeno nvarchar(30)
		,mon nvarchar(20)
		,[weight] float
		,m01 float --直接人工			
		,m02 float --製造費用
		,m03 float --電費
		,m04 float --瓦斯費
	)
	insert into @tmpc(accy,noa,noq,makeno,mon,[weight])
	select a.accy,a.noa,a.noq,a.cname,substring(b.datea,1,len(b.datea)-3),isnull(a.[weight],0)
	from view_cuts a
	left join view_cut b on a.accy=b.accy and a.noa=b.noa
	left join (select makeno,mon from #z_cub_rkp03_cc group by makeno,mon) c 
		on a.cname=c.makeno and substring(b.datea,1,len(b.datea)-3)=c.mon
	where c.makeno is not null
	
	-- 當期費用
	declare @tmpd table(
		makeno nvarchar(30)
		,mon nvarchar(20)
		,m01 float --直接人工			
		,m02 float --製造費用
		,m03 float --電費
		,m04 float --瓦斯費
	)
	insert into @tmpd(makeno,mon,m01,m02,m03,m04)
	select a.cubno,substring(b.datea,1,len(b.datea)-3)
		,SUM(ISNULL(a.w01,0)),SUM(ISNULL(a.w02,0)),SUM(ISNULL(a.w04,0)),SUM(ISNULL(a.w05,0))
	from view_cucs a
	left join view_cuc b on a.accy=b.accy and a.noa=b.noa
	left join (select makeno,mon from @tmpc group by makeno,mon) c on a.cubno=c.makeno 
	and substring(b.datea,1,len(b.datea)-3)<=c.mon
	--and substring(b.datea,1,len(b.datea)-3)=c.mon
	where c.makeno is not null
	group by a.cubno,substring(b.datea,1,len(b.datea)-3)
	
	declare cursor_table cursor for
		select makeno,mon,m01,m02,m03,m04 from @tmpd
	open cursor_table
	fetch next from cursor_table
	into @makeno,@mon,@m01,@m02,@m03,@m04
	while(@@FETCH_STATUS <> -1)
	begin
		select @totweight=0
		select @totweight = sum([weight]) from @tmpc where makeno=@makeno and mon=@mon
		
		if @totweight!=0
		begin
			update @tmpc set m01 = round(@m01 * [weight] / @totweight,0)
				,m02 = round(@m02 * [weight] / @totweight,0)
				,m03 = round(@m03 * [weight] / @totweight,0)
				,m04 = round(@m04 * [weight] / @totweight,0)
			where makeno=@makeno and mon=@mon
			--尾差修正
			select @totm01 = 0,@totm02 = 0,@totm03 = 0,@totm04 = 0
			select @totm01 = SUM(m01),@totm02 = SUM(m02),@totm03 = SUM(m03),@totm04 = SUM(m04)
			from @tmpc 
			where makeno=@makeno and mon=@mon
			
			if @m01 != @totm01 or @m02 != @totm02 or @m03 != @totm03 or @m04 != @totm04
			begin
				update @tmpc set m01 = a.m01 + (@m01-@totm01)
					,m02 = a.m02 + (@m02-@totm02)
					,m03 = a.m03 + (@m03-@totm03)
					,m04 = a.m04 + (@m04-@totm04)
				from @tmpc a
				outer apply(select top 1 sel from @tmpc 
					where makeno=@makeno and mon=@mon order by accy desc,noa desc,noq desc) b
				where a.sel=b.sel
			end
		end

		fetch next from cursor_table
		into @makeno,@mon,@m01,@m02,@m03,@m04
	end
	close cursor_table
	deallocate cursor_table
	
	update #z_cub_rkp03_cc set m01=b.m01,m02=b.m02,m03=b.m03,m04=b.m04
	from #z_cub_rkp03_cc a
	left join @tmpc b on a.accy=b.accy and a.noa=b.noa and a.noq=b.noq
	where b.noa is not null
	
	update #z_cub_rkp03_cc set total=ISNULL(cost,0)+ISNULL(m01,0)+ISNULL(m02,0)+ISNULL(m03,0)+ISNULL(m04,0)
	
--select * from #z_cub_rkp03_cc where makeno='M175428-1'
--return
	---update
	select @n = 0
	declare cursor_table cursor for
		select accy from #z_cub_rkp03_cc group by accy
	open cursor_table
	fetch next from cursor_table
	into @accy
	while(@@FETCH_STATUS <> -1)
	begin
		set @cmd =
		"update cuts"+@accy+" set scost=b.cost,total=b.total
		from cuts"+@accy+" a
		left join #z_cub_rkp03_cc b on b.accy=@accy and b.noa=a.noa and b.noq=a.noq
		where b.noa is not null
		and len(a.noa)!=5
		"
		execute sp_executesql @cmd,N'@accy nvarchar(10)'
		,@accy=@accy
		
		select @m = 0
		set @cmd =
		"select @m = count(1) 
		from cuts"+@accy+" a
		left join #z_cub_rkp03_cc b on b.accy=@accy and b.noa=a.noa and b.noq=a.noq
		where b.noa is not null
		and len(a.noa)!=5"
		execute sp_executesql @cmd,N'@accy nvarchar(10),@m int output'
		,@accy=@accy,@m=@m output
		set @n = @n + @m
		
		fetch next from cursor_table
		into @accy
	end
	close cursor_table
	deallocate cursor_table
	drop table #z_cub_rkp03_cc
	
	SET @t2 = GETDATE()
	insert into @tmp(gno,title,n,ms)
	select '1'
		,'成品成本-進倉作業'
		,@n
		,round(DATEDIFF(millisecond,@t1,@t2)/1000,0)
		
	SET @tott2 = GETDATE()
	/*insert into @tmp(gno,title,n,ms)
	select '2'
		,'總計算'
		,0
		,dbo.getComma(DATEDIFF(millisecond,@tott1,@tott2)/1000,3)*/
		
	select * from @tmp;
	
z_cub_rkp03X: -- z_cub_rkp03X  成本結轉
	---  要先計算  人工費用、製造費用、電費、瓦斯費
	SET QUOTED_IDENTIFIER OFF 
	declare @cmd nvarchar(max)
	declare @t_path nvarchar(max) = '[1]'
	declare @t_db nvarchar(max) = '[2]'
	
	declare @bdate nvarchar(10) = case when '#non'=[4] then '' else [4] end
	declare @edate nvarchar(10) = case when '#non'=[5] then char(255) else [5] end
	declare @uno nvarchar(30) = ''
	-------------------------------------------------------------------------------------
	--開帳記錄存在  itema,itemb	
	-- 計算sprice
	-- 當進貨退回時,成本單價將會變動
	declare @tmp_01 table(
		uno nvarchar(30)
	)
	--先列出會異動到的批號
	insert into @tmp_01(uno)
	select a.uno
	from view_rc2s a
	left join view_rc2 b on a.accy=b.accy and a.noa=b.noa
	where len(isnull(a.uno,''))>0
	and b.datea between @bdate and @edate
	group by a.uno
	---
	declare @tmp_02 table(
		uno nvarchar(30)
		,datea nvarchar(20)
		,[weight] float
		,[total] float
	)
	--進口報單轉來的要注意
	insert into @tmp_02(uno,datea,[weight],total)
	select a.uno,c.datea
		,sum(case when c.typea='1' then 1 else -1 end * isnull(b.[weight],0))
		,sum(case when c.typea='1' then 1 else -1 end * case when e.noa is null then isnull(b.[total],0) else e.cost end)
	from @tmp_01 a
	left join view_rc2s b on a.uno=b.uno
	left join view_rc2 c on b.accy=c.accy and b.noa=c.noa
	left join deli d on b.noa=d.rc2no
	left join delis e on d.noa=e.noa and e.noq=b.noq
	group by a.uno,c.datea
	---
	declare @tmp_03 table(
		uno nvarchar(30)
		,datea nvarchar(20)
		,price float
	)
	declare @xuno nvarchar(30)
	declare @xdate nvarchar(20)
	declare @xweight float
	declare @xtotal float
	
	declare @zweight float
	declare @ztotal float
	
	declare cursor_table cursor for 
	select uno from @tmp_01 order by uno
	open cursor_table 
	fetch next from cursor_table 
	into @xuno
	while(@@FETCH_STATUS <> -1) 
	begin 
		select @zweight = 0, @ztotal = 0
		
		declare cursor_table2 cursor for 
		select datea,[weight],total from @tmp_02 where uno=@xuno order by datea
		open cursor_table2 
		fetch next from cursor_table2 
		into @xdate,@xweight,@xtotal
		while(@@FETCH_STATUS <> -1) 
		begin 
			set @zweight = @zweight + @xweight
			set @ztotal = @ztotal + @xtotal 
			
			insert into @tmp_03(uno,datea,price)
			select @xuno,@xdate,case when isnull(@zweight,0) !=0 then round(@ztotal/@zweight,5) else 0 end
		
			fetch next from cursor_table2 
			into @xdate,@xweight,@xtotal
		end 
		close cursor_table2 
		deallocate cursor_table2
		
	
		fetch next from cursor_table 
		into @xuno
	end 
	close cursor_table 
	deallocate cursor_table 


	--- 寫入SPRICE
	delete sprice 
	from sprice a
	left join @tmp_01 b on a.uno=b.uno
	where b.uno is not null
	
	insert into sprice(datea,sprice,uno,tablea)
	select datea,price,uno,'rc2s'
	from @tmp_03
	----===================================================================================
	declare @tmp table(
		gno nvarchar(10)
		,uno nvarchar(30)
		,msg nvarchar(max)
	)
	
	-- 找到要計算的單據
	------- VCCS
	declare @tmpa table(uno nvarchar(30))
	insert into @tmpa(uno)
	select a.uno
	from view_vccs a
	left join view_vcc b on a.accy=b.accy and a.noa=b.noa
	left join view_uccb c on a.uno=c.uno
	where len(isnull(a.uno,''))>0
	and case when isnull(gweight,0)!=0 then gweight else isnull(a.[weight],0) end != 0 
	and b.datea between @bdate and @edate
	and (len(@uno)=0 or a.uno=@uno)
	and (c.kind='A1' or c.kind='A4' or c.kind='A5' or c.kind='A7' or c.kind='A8')
	------- GETS
	insert into @tmpa(uno)
	select a.uno
	from view_gets a
	left join view_get b on a.accy=b.accy and a.noa=b.noa
	left join view_uccb c on a.uno=c.uno
	where len(isnull(a.uno,''))>0
	and case when isnull(gweight,0)!=0 then gweight else isnull(a.[weight],0) end != 0 
	and b.datea between @bdate and @edate
	and (len(@uno)=0 or a.uno=@uno)
	and (c.kind='A1' or c.kind='A4' or c.kind='A5' or c.kind='A7' or c.kind='A8')
	------- CUBT
	insert into @tmpa(uno)
	select a.uno
	from view_cubt a
	left join view_cub b on a.accy=b.accy and a.noa=b.noa
	left join view_uccb c on a.uno=c.uno
	where len(isnull(a.uno,''))>0
	and isnull(a.[weight],0) != 0 
	and b.datea between @bdate and @edate
	and (len(@uno)=0 or a.uno=@uno)
	and (c.kind='A1' or c.kind='A4' or c.kind='A5' or c.kind='A7' or c.kind='A8')
	------- CUTS(暫時用不到)
	----===================================================================================
	-- 列出所要計算的批號
	declare @tmpUno table(
		sel int identity(1,1)
		,uno nvarchar(30)
	)
	insert into @tmpUno(uno)
	select uno from @tmpa group by uno
	---------------------------------------------------------------------
	IF OBJECT_ID('tempdb..#z_cub_rkp03')is not null
	BEGIN
		drop table #z_cub_rkp03
	END
	create table #z_cub_rkp03(
		sel int identity(1,1)
		,recno int
		,datea nvarchar(20)
		,tablea nvarchar(20)
		,accy nvarchar(10)
		,noa nvarchar(20)
		,noq nvarchar(10)
		,uno nvarchar(30)
		,typea nvarchar(10)
		,[weight] float
		,scost float
		
		,isUcce int -- 盤點
		,isIna int -- 判斷是否是領料組合後的東西,如果是就要等INAS的金額寫入後才能算出來成本
	)
	--- VCCS
	insert into #z_cub_rkp03(datea,tablea,accy,noa,noq,typea,uno,[weight])
	select b.datea,'vccs',a.accy,a.noa,a.noq,b.typea,a.uno
		,case when ISNULL(a.gweight,0)!=0 then a.gweight else a.[weight] end
	from view_vccs a
	left join view_vcc b on a.accy=b.accy and a.noa=b.noa
	left join @tmpUno c on a.uno=c.uno
	where c.sel is not null
	and case when ISNULL(a.gweight,0)!=0 then a.gweight else ISNULL(a.[weight],0) end!=0
	
	--- GETS
	insert into #z_cub_rkp03(datea,tablea,accy,noa,noq,uno,[weight],isucce,scost)
	select b.datea,'gets',a.accy,a.noa,a.noq,a.uno,case when ISNULL(a.gweight,0)!=0 then a.gweight else a.[weight] end
		,case when charindex('盤點',b.typea)>0 then 1 else 0 end
		,case when charindex('盤點',b.typea)>0 then a.scost else 0 end
	from view_gets a
	left join view_get b on a.accy=b.accy and a.noa=b.noa
	left join @tmpUno c on a.uno=c.uno
	where c.sel is not null
	and (charindex('盤點',b.typea)>0 or (case when ISNULL(a.gweight,0)!=0 then a.gweight else ISNULL(a.[weight],0) end)!=0)
	
	--- CUBT
	insert into #z_cub_rkp03(datea,tablea,accy,noa,noq,uno,[weight])
	select b.datea,'cubt',a.accy,a.noa,a.noq,a.uno,a.[weight]
	from view_cubt a
	left join view_cub b on a.accy=b.accy and a.noa=b.noa
	left join @tmpUno c on a.uno=c.uno
	where c.sel is not null
	and ISNULL(a.[weight],0)!=0
	
	--- CHECK
	update #z_cub_rkp03 set isIna = case when b.noa is null then 0 else 1 end
	from #z_cub_rkp03 a
	left join view_get b on a.uno=b.idno and len(ISNULL(b.idno,''))>0 
	
	update #z_cub_rkp03 set recno=b.recno
	from #z_cub_rkp03 a
	left join(select sel,ROW_NUMBER()over(PARTITION by uno order by datea,noa,noq)recno from #z_cub_rkp03) b on a.sel=b.sel	
	--======================================================================================
	--計算成本  
	----(盤點的由人工輸入,故忽略)
	---- 進貨成本單價要依 TABLE SPRICE的資料來判斷
	update #z_cub_rkp03 set scost = ROUND(a.[weight]* case when c.uno is null then b.sprice else isnull(c.sprice,0) end,0)
	from #z_cub_rkp03 a
	left join view_uccb b on a.uno=b.uno
	outer apply(select top 1 * from sprice where b.tablea=tablea and a.uno=uno and a.datea>=datea order by datea desc) c
	where isnull(a.isucce,0)!=1

	--先計算不是領料組合的
--	declare @xuno nvarchar(30)
	declare @weight float --進貨、入庫重量
	declare @money float --進貨、入庫成本
	
--	declare @xweight float -- 領料重量
	declare @xcost float -- 領料成本
	declare @diff float
	
	declare @sel int
	declare @scost float
	
	declare cursor_table cursor for
	select uno,sum(isnull([weight],0)),sum(isnull(scost,0)) from #z_cub_rkp03 where isnull(isIna,0)!=1 group by uno
	open cursor_table
	fetch next from cursor_table
	into @xuno,@xweight,@xcost
	while(@@FETCH_STATUS <> -1)
	begin
		select @weight=0,@money = 0
		if exists(select top 1 * from view_rc2s where uno=@xuno)
		begin
			select @weight=SUM( case when b.typea='1' then 1 else -1 end * isnull(a.[weight],0)) 
				,@money=SUM( case when b.typea='1' then 1 else -1 end * isnull(a.total,0)) 
			from view_rc2s a 
			left join view_rc2 b on a.accy=b.accy and a.noa=b.noa
			where a.uno=@xuno
		end
		else if exists(select top 1 * from view_inas where uno=@xuno)
		begin
			select @weight=SUM( isnull(a.[weight],0)) ,@money=SUM( isnull(a.total,0)) 
			from view_inas a 
			where a.uno=@xuno
		end
		else if exists(select top 1 * from view_cuts where bno=@xuno)
		begin
			select @weight=SUM( isnull(a.[weight],0)) 
				--,@money=SUM( round(isnull(a.[weight],0)*sprice,0)) 
				,@money=SUM(isnull(a.total,0)) 
			from view_cuts a 
			where a.bno=@xuno
		end
		--假如還有庫存就不需要調整金額
		if @xweight>=@weight
		begin
			--找最後一筆調整金額,  盤點的不改
			set @diff = @xcost - isnull(@money,0)

			if @diff!=0
			begin
				declare cursor_table2 cursor for
				select sel,scost from #z_cub_rkp03 where uno=@xuno and isnull(isucce,0)!=1 order by recno desc
				open cursor_table2
				fetch next from cursor_table2
				into @sel,@scost
				while(@@FETCH_STATUS <> -1)
				begin
					if @diff<0
					begin
						update #z_cub_rkp03 set scost=@scost-@diff where sel=@sel
						set @diff = 0
						break
					end
					else 
					begin
						if @scost>=@diff
						begin
							update #z_cub_rkp03 set scost=@scost-@diff where sel=@sel
							set @diff = 0
							break
						end
						else
						begin
							update #z_cub_rkp03 set scost=0 where sel=@sel
							set @diff = @diff - @scost
						end
					end
					fetch next from cursor_table2
					into @sel,@scost
				end
				close cursor_table2
				deallocate cursor_table2
				
				if @diff!=0
				begin
					insert into @tmp(uno,msg)values(@xuno,' 尾差 '+ cast(@diff as nvarchar))
					--print @xuno +' 尾差 '+ cast(@diff as nvarchar)
					--select @xuno +' 尾差 '+ cast(@diff as nvarchar)
				end
			end
		end
		
		fetch next from cursor_table
		into @xuno,@xweight,@xcost
	end
	close cursor_table
	deallocate cursor_table

	--計算領料組合的  (之後回寫到入庫單)
	declare @tmpd table(
		sel int identity(1,1)
		,accy nvarchar(10)
		,noa nvarchar(20)
		,noq nvarchar(10)
		,uno nvarchar(30)
		,[money] float
	)
	declare @accy nvarchar(10)
	declare @noa nvarchar(20)
	declare @noq nvarchar(10)
	declare @n int = 10

	while @n > 0
	begin
		declare cursor_table cursor for
		select a.uno 
		from #z_cub_rkp03 a
		left join @tmpd b on a.uno=b.uno
		where b.uno is null and a.isIna=1 
		group by a.uno
		open cursor_table
		fetch next from cursor_table
		into @xuno
		while(@@FETCH_STATUS <> -1)
		begin
			select @accy='',@noa = '',@noq='',@money=0
			select @accy=a.accy,@noa = b.noa,@noq=a.noq 
			from view_inas a
			left join view_get b on a.noa=b.noa
			where a.uno=@xuno and b.noa is not null 
	
			if exists(select * from #z_cub_rkp03 where tablea='gets' and noa=@noa)
			begin
				select @money=SUM(ISNULL(scost,0)) from #z_cub_rkp03 where tablea='gets' and noa=@noa
			end
			else
			begin
				select @money=SUM(ISNULL(scost,0)) from view_gets where noa=@noa
			end
			
			insert into @tmpd(accy,noa,noq,uno,[money])
			select @accy,@noa,@noq,@xuno,@money

			fetch next from cursor_table
			into @xuno
		end
		close cursor_table
		deallocate cursor_table
		set @n = @n - 1
	end
	
	---- 回寫ina total
	declare cursor_table cursor for
	select accy,noa,noq,[money] from @tmpd
	open cursor_table
	fetch next from cursor_table
	into @accy,@noa,@noq,@money
	while(@@FETCH_STATUS <> -1)
	begin
		set @cmd =  
		"update inas"+@accy+" set total=@money,price=case when isnull([weight],0)=0 then 0 else round(@money/[weight],5) end
		where noa=@noa and noq=@noq"
		execute sp_executesql @cmd,N'@noa nvarchar(20),@noq nvarchar(10),@money float'
			,@noa=@noa,@noq=@noq,@money=@money
		fetch next from cursor_table
		into @accy,@noa,@noq,@money
	end
	close cursor_table
	deallocate cursor_table
	--------------------------------------------------------------------------------------------------------------
	-- 計算領料組合的
	declare cursor_table cursor for
	select uno,sum(isnull([weight],0)),sum(isnull(scost,0)) from #z_cub_rkp03 where isnull(isIna,0)=1 group by uno
	open cursor_table
	fetch next from cursor_table
	into @xuno,@xweight,@xcost
	while(@@FETCH_STATUS <> -1)
	begin
		select @weight=0,@money = 0
		if exists(select top 1 * from view_rc2s where uno=@xuno)
		begin
			select @weight=SUM( case when b.typea='1' then 1 else -1 end * isnull(a.[weight],0)) 
				,@money=SUM( case when b.typea='1' then 1 else -1 end * isnull(a.total,0)) 
			from view_rc2s a 
			left join view_rc2 b on a.accy=b.accy and a.noa=b.noa
			where a.uno=@xuno
		end
		else if exists(select top 1 * from view_inas where uno=@xuno)
		begin
			select @weight=SUM( isnull(a.[weight],0)) ,@money=SUM( isnull(a.total,0)) 
			from view_inas a 
			where a.uno=@xuno
		end
		else if exists(select top 1 * from view_cuts where bno=@xuno)
		begin
			select @weight=SUM( isnull(a.[weight],0)) ,@money=SUM(isnull(a.total,0)) 
			from view_cuts a 
			where a.bno=@xuno
		end
		--假如還有庫存就不需要調整金額
		if @xweight>=@weight
		begin
			--找最後一筆調整金額,  盤點的不改
			set @diff = @xcost - isnull(@money,0)

			if @diff!=0
			begin
				declare cursor_table2 cursor for
				select sel,scost from #z_cub_rkp03 where uno=@xuno and isnull(isucce,0)!=1 order by recno desc
				open cursor_table2
				fetch next from cursor_table2
				into @sel,@scost
				while(@@FETCH_STATUS <> -1)
				begin
					if @diff<0
					begin
						update #z_cub_rkp03 set scost=@scost-@diff where sel=@sel
						set @diff = 0
						break
					end
					else 
					begin
						if @scost>=@diff
						begin
							update #z_cub_rkp03 set scost=@scost-@diff where sel=@sel
							set @diff = 0
							break
						end
						else
						begin
							update #z_cub_rkp03 set scost=0 where sel=@sel
							set @diff = @diff - @scost
						end
					end
					fetch next from cursor_table2
					into @sel,@scost
				end
				close cursor_table2
				deallocate cursor_table2
				
				if @diff!=0
				begin
					insert into @tmp(uno,msg)values(@xuno,' 尾差 '+ cast(@diff as nvarchar))
					--print @xuno +' 尾差 '+ cast(@diff as nvarchar)
					--select @xuno +' 尾差 '+ cast(@diff as nvarchar)
				end
			end
		end
		
		fetch next from cursor_table
		into @xuno,@xweight,@xcost
	end
	close cursor_table
	deallocate cursor_table
	-----------------------------------------------------------------------
	-- 更新資料  回寫到各TABLE
	-----------------------------------------------------------------------
	declare cursor_table cursor for
	select accy from #z_cub_rkp03 group by accy
	open cursor_table
	fetch next from cursor_table
	into @accy	
	while(@@FETCH_STATUS <> -1)
	begin
		--vccs
		set @cmd =
		"update vccs"+@accy+" set scost=b.scost
		from vccs"+@accy+" a
		left join #z_cub_rkp03 b on b.tablea='vccs' and b.accy=@accy and a.noa=b.noa and a.noq=b.noq
		where b.noa is not null"
		execute sp_executesql @cmd,N'@accy nvarchar(10),@noa nvarchar(20),@noq nvarchar(10)'
			,@accy=@accy,@noa=@noa,@noq=@noq
		--gets
		set @cmd =
		"update gets"+@accy+" set scost=b.scost
		from gets"+@accy+" a
		left join #z_cub_rkp03 b on b.tablea='gets' and b.accy=@accy and a.noa=b.noa and a.noq=b.noq 
		where b.noa is not null"
		execute sp_executesql @cmd,N'@accy nvarchar(10),@noa nvarchar(20),@noq nvarchar(10)'
			,@accy=@accy,@noa=@noa,@noq=@noq
		--cubt
		set @cmd =
		"update cubt"+@accy+" set scost=b.scost
		from cubt"+@accy+" a
		left join #z_cub_rkp03 b on b.tablea='cubt' and b.accy=@accy and a.noa=b.noa and a.noq=b.noq 
		where b.noa is not null"
		execute sp_executesql @cmd,N'@accy nvarchar(10),@noa nvarchar(20),@noq nvarchar(10)'
			,@accy=@accy,@noa=@noa,@noq=@noq
		
		fetch next from cursor_table
		into @accy
	end
	close cursor_table
	deallocate cursor_table
	-----------------------------------------------------------------------------------------------
	--=============================================================================================
	-- 計算在製品成本  CUBS
	IF OBJECT_ID('tempdb..#z_cub_rkp03_cubs')is not null
	BEGIN
		drop table #z_cub_rkp03_cubs
	END
	create table #z_cub_rkp03_cubs(
		sel int identity(1,1)
		,accy nvarchar(10)
		,noa nvarchar(20)
		,noq nvarchar(10)
		,makeno nvarchar(20)		
		
		,cubs float        --鋼捲成本
		,cubs_weight float --鋼捲重量
		,cubs_length float --鋼捲長度
		
		,pvc float         --皮膜成本
		,pvc_weight float  --皮膜重量
		
		,pve float         --保護膜成本
		,pve_weight float  --保護膜重量
		
		,A01 float         --物料成本
		,A01_weight float  --物料重量
		,A02 float         
		,A02_weight float
		,A03 float         
		,A03_weight float
		,A04 float         
		,A04_weight float
		,A05 float         
		,A05_weight float  
		
		,w01 float --直接人工
		,w02 float --製造費用
		,w04 float --電費
		,w05 float --瓦斯費
		
		,tweight float
		,total float
	)
	--鋼捲
	insert into #z_cub_rkp03_cubs(accy,noa,noq,makeno,cubs,cubs_weight,cubs_length,w01,w02,w04,w05)
	select a.accy,a.noa,a.noq,a.makeno,c.scost,a.[weight],a.w09,a.w01,a.w02,a.w04,a.w05
	from view_cubs a 
	left join view_cub b on a.accy=b.accy and a.noa=b.noa
	left join view_gets c on a.accy=c.accy and a.noa=c.noa and a.noq=c.noq
	where b.datea between @bdate and @edate
	--皮膜
	update #z_cub_rkp03_cubs set pvc=b.scost
		,pvc_weight = b.[weight]
	from #z_cub_rkp03_cubs a
	outer apply(select SUM(isnull([wweight],0)) [weight],SUM(isnull([scost],0)) scost 
		from view_cubt where accy=a.accy and noa=a.noa and nor=a.noq and kind='1') b
	--保護膜
	update #z_cub_rkp03_cubs set pve= b.scost
		,pve_weight = b.[weight]
	from #z_cub_rkp03_cubs a
	outer apply(select SUM(isnull([wweight],0)) [weight],SUM(isnull([scost],0)) scost 
		from view_cubt where accy=a.accy and noa=a.noa and nor=a.noq and kind='2') b
	--物料	
	declare @tmp_cubu table(
		sel int identity(1,1)
		,accy nvarchar(10)
		,noa nvarchar(20)
		,groupano nvarchar(20)
		,uno nvarchar(30)
		,[weight] float
		,scost float
	)
	declare @tmp_cubs_cubu table(
		sel int identity(1,1)
		,accy nvarchar(10)
		,noa nvarchar(20)
		,noq nvarchar(10)
		,[length] float 
		,cubu_sel int
		,groupano nvarchar(20)
		,[weight] float
		,scost float
	)
	declare @length float
	declare @tlength float
	
	declare cursor_table cursor for
	select accy,noa,sum(isnull([cubs_length],0))
	from #z_cub_rkp03_cubs
	group by accy,noa
	open cursor_table
	fetch next from cursor_table
	into @accy,@noa,@tlength
	while(@@FETCH_STATUS <> -1)
	begin
		insert into @tmp_cubu(accy,noa,groupano,uno,[weight],scost)
		select a.accy,a.noa,c.groupano,a.ucolor,a.[weight],b.scost
		from view_cubu a
		left join view_gets b on a.accy=b.accy and a.noa=b.noa and a.ucolor=b.uno
		left join ucc c on a.productno=c.noa
		where a.accy=@accy and a.noa=@noa
		
		insert into @tmp_cubs_cubu(accy,noa,noq,[length],cubu_sel,groupano,[weight],scost)
		select a.accy,a.noa,a.noq,a.cubs_length,b.sel,b.groupano
			,case when ISNULL(@tlength,0)!=0 then round(b.[weight]*a.cubs_length/@tlength,2) else 0 end
			,case when ISNULL(@tlength,0)!=0 then round(b.[scost]*a.cubs_length/@tlength,0) else 0 end
		from #z_cub_rkp03_cubs a
		left join @tmp_cubu b on a.accy=b.accy and a.noa=b.noa 
		where a.accy=@accy and a.noa=@noa
		order by a.accy,a.noa,a.noq

		fetch next from cursor_table
		into @accy,@noa,@tlength
	end
	close cursor_table
	deallocate cursor_table	
	--物料 尾差修正
	declare @sel2 int
	declare @weight2 float
	declare @scost2 float
	
	declare cursor_table cursor for
	select sel,[weight],scost from @tmp_cubu
	open cursor_table
	fetch next from cursor_table
	into @sel,@weight,@scost
	while(@@FETCH_STATUS <> -1)
	begin
		select @weight2=0,@scost2=0
		select @weight2=SUM(ISNULL([weight],0)),@scost2=SUM(ISNULL([scost],0))
		from @tmp_cubs_cubu where cubu_sel=@sel
		
		--尾差都由最後一筆修正
		update @tmp_cubs_cubu set [weight]=round(b.[weight] + @weight - @weight2,2)
			,scost = b.scost + @scost - @scost2
		from @tmp_cubs_cubu a
		outer apply(select top 1 * from @tmp_cubs_cubu where cubu_sel=@sel order by sel desc) b
		where a.sel=b.sel

		fetch next from cursor_table
		into @sel,@weight,@scost
	end
	close cursor_table
	deallocate cursor_table	
	
	 update #z_cub_rkp03_cubs set A01 = b.A01,A01_weight=b.A01_weight
		,A02 = b.A02,A02_weight=b.A02_weight
		,A03 = b.A03,A03_weight=b.A03_weight
		,A04 = b.A04,A04_weight=b.A04_weight
		,A05 = b.A05,A05_weight=b.A05_weight
	 from #z_cub_rkp03_cubs a
	 left join (select accy,noa,noq
		,SUM(case when groupano='A01' then isnull([scost],0) else 0 end) A01
		,SUM(case when groupano='A01' then isnull([weight],0) else 0 end) A01_weight
		,SUM(case when groupano='A02' then isnull([scost],0) else 0 end) A02
		,SUM(case when groupano='A02' then isnull([weight],0) else 0 end) A02_weight
		,SUM(case when groupano='A03' then isnull([scost],0) else 0 end) A03
		,SUM(case when groupano='A03' then isnull([weight],0) else 0 end) A03_weight
		,SUM(case when groupano='A04' then isnull([scost],0) else 0 end) A04
		,SUM(case when groupano='A04' then isnull([weight],0) else 0 end) A04_weight
		,SUM(case when groupano='A05' then isnull([scost],0) else 0 end) A05
		,SUM(case when groupano='A05' then isnull([weight],0) else 0 end) A05_weight
		from @tmp_cubs_cubu group by accy,noa,noq) b on a.accy=b.accy and a.noa=b.noa and a.noq=b.noq
	where b.noa is not null
	
	update #z_cub_rkp03_cubs set tweight = round(ISNULL(cubs_weight,0) + ISNULL(pvc_weight,0) + ISNULL(pve_weight,0) 
		+ ISNULL(A01_weight,0) + ISNULL(A02_weight,0) + ISNULL(A03_weight,0) + ISNULL(A04_weight,0) + ISNULL(A05_weight,0),2)
		,total = ISNULL(cubs,0) + ISNULL(pvc,0) + ISNULL(pve,0) 
		+ ISNULL(A01,0) + ISNULL(A02,0) + ISNULL(A03,0) + ISNULL(A04,0) + ISNULL(A05,0)
		+ ISNULL(w01,0) + ISNULL(w02,0) + ISNULL(w04,0) + ISNULL(w05,0)
	-----------------------------------------------------------------------
	-- 更新資料  回寫到CUBS
	-----------------------------------------------------------------------	
	declare cursor_table cursor for
	select accy from #z_cub_rkp03_cubs group by accy
	open cursor_table
	fetch next from cursor_table
	into @accy	
	while(@@FETCH_STATUS <> -1)
	begin
		set @cmd =
		"update cubs"+@accy+" set [total] = b.total,w03=b.tweight
			,x01 = b.cubs_weight
			,x02 = b.pvc_weight
			,x03 = b.pve_weight
			,x04 = b.A01_weight
			,x05 = b.A02_weight
			,x06 = b.A03_weight
			,x07 = b.A04_weight
			,x08 = b.A05_weight
			,y01 = b.cubs
			,y02 = b.pvc
			,y03 = b.pve
			,y04 = b.A01
			,y05 = b.A02
			,y06 = b.A03
			,y07 = b.A04
			,y08 = b.A05
		from cubs"+@accy+" a
		left join #z_cub_rkp03_cubs b on @accy=b.accy and a.noa=b.noa and a.noq=b.noq
		where b.noa is not null"
		execute sp_executesql @cmd,N'@accy nvarchar(10)',@accy=@accy
		
		fetch next from cursor_table
		into @accy
	end
	close cursor_table
	deallocate cursor_table
	-----------------------------------------------------------------------
	-- 計算 樣品、報廢
	-----------------------------------------------------------------------	
	-- 計算在製品成本  CUCS
	IF OBJECT_ID('tempdb..#z_cub_rkp03_cucs')is not null
	BEGIN
		drop table #z_cub_rkp03_cucs
	END
	create table #z_cub_rkp03_cucs(
		sel int identity(1,1)
		
		,accy nvarchar(10) 
		,noa nvarchar(20)
		,noq nvarchar(10)
		,makeno nvarchar(20)
		,price float   		
		
		,weight6 float  -- 樣品重
		,weight7 float  -- 報廢重
		,weight11 float -- 盤盈
		,template_money float
		,waste_money float
		,surplus_money float
	)
	
	insert into #z_cub_rkp03_cucs(accy,noa,noq,makeno,weight6,weight7,weight11)
	select a.accy,a.noa,a.noq,a.cubno,a.weight6,a.weight7,a.weight11
	from view_cucs a
	left join view_cuc b on a.accy=b.accy and a.noa=b.noa
	where 1=1
	and b.datea between @bdate and @edate	
	and not(ISNULL(a.weight6,0)=0 and ISNULL(a.weight7,0)=0 and ISNULL(a.weight11,0)=0)
	
	declare @tmpCubs table(
		sel int identity(1,1)
		,makeno nvarchar(20)
		,[weight] float  --用完工重量計算
		,total float
		,price float
	)
	--計算原物料單位成本
	insert into @tmpCubs(makeno,[weight],total,price)
	select a.makeno ,a.hweight,a.total,case when ISNULL(a.hweight,0)=0 then 0 else ROUND(ISNULL(a.total,0)/a.hweight,2) end
	from view_cubs a
	left join (select makeno from #z_cub_rkp03_cucs group by makeno) b on a.makeno=b.makeno
	where b.makeno is not null
	--推算出樣品、報廢成本,        **成品成本= 原物料成本 - 樣品成本 - 報廢成本
	update #z_cub_rkp03_cucs set template_money = round(a.weight6 * b.price,0)
		,waste_money = ROUND(a.weight7*b.price,0)
		,surplus_money = ROUND(a.weight11*b.price,0)
	from #z_cub_rkp03_cucs a
	left join @tmpCubs b on a.makeno=b.makeno
	-----資料回寫
	declare cursor_table cursor for
	select accy from #z_cub_rkp03_cucs group by accy
	open cursor_table
	fetch next from cursor_table
	into @accy	
	while(@@FETCH_STATUS <> -1)
	begin
		set @cmd =
		"update cucs"+@accy+" set m02=b.template_money,m03=b.waste_money,m04=b.surplus_money
		from cucs"+@accy+" a
		left join #z_cub_rkp03_cucs b on b.accy=@accy and a.noa=b.noa and a.noq=b.noq
		where b.noa is not null"
		execute sp_executesql @cmd,N'@accy nvarchar(20)',@accy=@accy
		
		fetch next from cursor_table
		into @accy
	end
	close cursor_table
	deallocate cursor_table
	
	-------------------------------------------------------------------------------------
	--開帳庫存
	update cubs105 set hweight=b.mount,total= b.money,sprice=b.price,price=b.price
	from cubs105 a
	left join itema b on a.makeno=b.makeno
	where b.makeno is not null

	update cubs106 set hweight=b.mount,total= b.money,sprice=b.price,price=b.price
	from cubs106 a
	left join itema b on a.makeno=b.makeno
	where b.makeno is not null
	
	--z_cub_rkp06 計算 cuts.total
	-- 計算成品的金額
	declare @tmpCuts_1 table(
		sel int identity(1,1)
		,accy nvarchar(10)
		,noa nvarchar(20)
		,noq nvarchar(10)
		,makeno nvarchar(20)
		,[weight] float --入庫重量 
		,cost float 
	)
	insert into @tmpCuts_1(accy,noa,noq,makeno,[weight])
	select a.accy,a.noa,a.noq,a.cname,a.[weight]
	from view_cuts a
	left join view_cut b on a.accy=b.accy and a.noa=b.noa
	where b.datea between @bdate and @edate
	and len(ISNULL(a.cname,'')) > 0
	
	--半成品成本
	declare @tmpCuts_2 table(
		sel int identity(1,1)
		,makeno nvarchar(20)
		,[weight] float --入庫重量 
		,total float 
		,xweight float --成品進倉的總重
		,xtotal float
	)
	insert into @tmpCuts_2(makeno)
	select makeno from @tmpCuts_1 group by makeno
	update @tmpCuts_2 set [weight]=ISNULL(b.hweight,0),total=ISNULL(b.total,0)
	from @tmpCuts_2 a
	left join view_cubs b on a.makeno=b.makeno
	--忽略CUBS不存在的
	delete @tmpCuts_2
	from @tmpCuts_2 a
	left join view_cubs b on a.makeno=b.makeno
	where b.noa is null
	
	--相關的成品進倉品項
	IF OBJECT_ID('tempdb..#z_cub_rkp03a')is not null
	BEGIN
		drop table #z_cub_rkp03a
	END
	create table #z_cub_rkp03a(
		sel int identity(1,1)
		,accy nvarchar(10)
		,noa nvarchar(20)
		,noq nvarchar(10)
		,makeno nvarchar(20)
		,[weight] float --入庫重量 
		,cost float 
	)
	insert into #z_cub_rkp03a(accy,noa,noq,makeno,weight)
	select a.accy,a.noa,a.noq,a.cname,ISNULL(a.weight,0)
	from view_cuts a
	left join @tmpCuts_2 b on a.cname=b.makeno
	where b.makeno is not null
	order by a.datea,a.accy,a.noa,a.noq
	
	update @tmpCuts_2 set xweight = ISNULL(b.weight,0)
	from @tmpCuts_2 a
	left join (select makeno,SUM(weight) weight from #z_cub_rkp03a group by makeno) b on a.makeno=b.makeno
	
	update #z_cub_rkp03a set cost = case when b.xweight=0 then 0 else round(b.total*a.weight/b.xweight,0) end
	from #z_cub_rkp03a a
	left join @tmpCuts_2 b on a.makeno=b.makeno
	
	update @tmpCuts_2 set xtotal = ISNULL(b.cost,0)
	from @tmpCuts_2 a
	left join (select makeno,SUM(cost) cost from #z_cub_rkp03a group by makeno) b on a.makeno=b.makeno
	--尾差修正 (由最後一筆修正)
	declare @makeno nvarchar(30)
	
	declare cursor_table cursor for
	select makeno,total-xtotal from @tmpCuts_2 where total!=xtotal
	open cursor_table
	fetch next from cursor_table
	into @makeno,@diff
	while(@@FETCH_STATUS <> -1)
	begin
		update #z_cub_rkp03a set cost = a.cost + @diff
		from #z_cub_rkp03a a
		outer apply(select top 1 sel from #z_cub_rkp03a where makeno=@makeno order by sel) b
		where a.sel=b.sel
		fetch next from cursor_table
		into @makeno,@diff
	end
	close cursor_table
	deallocate cursor_table

	-----資料回寫
	declare cursor_table cursor for
	select accy from #z_cub_rkp03a group by accy
	open cursor_table
	fetch next from cursor_table
	into @accy
	while(@@FETCH_STATUS <> -1)
	begin
		set @cmd =
		"update cuts"+@accy+" set scost=b.cost
		 from cuts"+@accy+" a
		 left join #z_cub_rkp03a b on a.noa=b.noa and a.noq=b.noq
		 where b.accy=@accy"
		execute sp_executesql @cmd,N'@accy nvarchar(10)'
		,@accy=@accy
		
		fetch next from cursor_table
		into @accy
	end
	close cursor_table
	deallocate cursor_table
	-------------------------------------------------------------------------------------------------------
	set @n=0
	select @n=count(1) from #z_cub_rkp03
	drop table #z_cub_rkp03
	insert into @tmp(uno,msg)values('','共計算 '+CAST(ISNULL(@n,0) as nvarchar)+' 筆資料')
	select * from @tmp;
	
z_cub_rkp01:--z_cub_rkp01  費用攤提
	SET QUOTED_IDENTIFIER OFF 
	declare @cmd nvarchar(max)
	declare @t_path nvarchar(max) = '[1]'
	declare @t_db nvarchar(max) = '[2]'
	
	declare @t_mon nvarchar(max) = case when '#non' = [3] then '' else [3] end
	--------------------------------------------------------------------------------------------------
	declare @tmp table(
		makeno nvarchar(30)
		,m01 float --人工費用
		,m02 float --製造費用
		,m03 float --電費
		,m04 float --瓦斯費
		,totmins float --總工時
		,tm01 float 
		,tm02 float 
		,tm03 float 
		,tm04 float 
	)
	--生產  CUB
	insert into @tmp(makeno,m01,m02,m03,m04)
	select isnull(a.makeno,'')
		,sum(isnull(a.price1,0))
		,sum(isnull(a.price2,0))
		,sum(isnull(a.price3,0))
		,sum(isnull(a.price4,0))
	from costas a
	left join costa b on a.noa=b.noa
	where b.mon=@t_mon
	group by isnull(a.makeno,'')
	
	IF OBJECT_ID('tempdb..#z_cub_rkp04a')is not null
	BEGIN
		drop table #z_cub_rkp04a
	END
	create table #z_cub_rkp04a (
		sel int identity(1,1)
		,tablea nvarchar(20)
		,datea nvarchar(20)
		,accy nvarchar(10)
		,noa nvarchar(20)
		,noq nvarchar(10)
		,makeno nvarchar(30)
		,tmakeno nvarchar(30)
		,mins float
		,money01 float
		,money02 float
		,money03 float
		,money04 float
	)
	insert into #z_cub_rkp04a(tablea,datea,accy,noa,noq,makeno,tmakeno,mins)
	select 'cubs',b.datea,a.accy,a.noa,a.noq,a.makeno,ISNULL(c.makeno,''),isnull(a.mins,0)
	from view_cubs a
	left join view_cub b on a.noa=b.noa
	left join @tmp c on a.makeno=c.makeno
	where left(b.datea,6)=@t_mon
	and isnull(a.mins,0)!=0
	order by a.accy,a.noa,a.noq
	
	--工時統計
	update @tmp set totmins=ISNULL(b.mins,0)
	from @tmp a
	left join (select tmakeno,SUM(ISNULL(mins,0)) mins
		from #z_cub_rkp04a 
		group by tmakeno) b on a.makeno=b.tmakeno
	--初步分攤金額
	update #z_cub_rkp04a set 
		money01 = case when b.totmins=0 then 0 else round(b.m01*a.mins/b.totmins,0) end
		,money02 = case when b.totmins=0 then 0 else round(b.m02*a.mins/b.totmins,0) end
		,money03 = case when b.totmins=0 then 0 else round(b.m03*a.mins/b.totmins,0) end
		,money04 = case when b.totmins=0 then 0 else round(b.m04*a.mins/b.totmins,0) end
	from #z_cub_rkp04a a
	left join @tmp b on a.tmakeno=b.makeno

	--統計金額
	update @tmp set tm01=b.money01,tm02=b.money02,tm03=b.money03,tm04=b.money04
	from @tmp a
	left join (select tmakeno
		,SUM(money01) money01 
		,SUM(money02) money02 
		,SUM(money03) money03 
		,SUM(money04) money04 
		from #z_cub_rkp04a group by tmakeno) b on a.makeno=b.tmakeno 

	--尾差由最後一筆攤提,但金額最多扣到0
	declare @makeno nvarchar(30)
	declare @m01 float
	declare @m02 float
	declare @m03 float
	declare @m04 float
	declare @sel int
	declare @money01 float
	declare @money02 float
	declare @money03 float
	declare @money04 float
	
	declare cursor_table cursor for
	select makeno,tm01-m01,tm02-m02,tm03-m03,tm04-m04 from @tmp
	open cursor_table
	fetch next from cursor_table
	into @makeno,@m01,@m02,@m03,@m04
	while(@@FETCH_STATUS <> -1)
	begin	
		
		declare cursor_table2 cursor for
		select sel,money01,money02,money03,money04 
		from #z_cub_rkp04a 
		where makeno=@makeno
		order by datea desc,accy desc,noa desc,noq desc
		open cursor_table2
		fetch next from cursor_table2
		into @sel,@money01,@money01,@money01,@money01
		while(@@FETCH_STATUS <> -1)
		begin	
			if @m01=0 and @m02=0 and @m03=0 and @m04=0
			begin
				break
			end
			
			if @money01>0 and @money01>=@m01
			begin
				update #z_cub_rkp04a set money01 = money01 - @m01 where sel=@sel
				set @m01 = 0
			end
			else if @money01>0 and @money01<@m01
			begin 
				update #z_cub_rkp04a set money01 = 0 where sel=@sel
				set @m01 = @m01 - @money01
			end
			
			if @money02>0 and @money02>=@m02
			begin
				update #z_cub_rkp04a set money02 = money02 - @m02 where sel=@sel
				set @m02 = 0
			end
			else if @money02>0 and @money02<@m02
			begin 
				update #z_cub_rkp04a set money02 = 0 where sel=@sel
				set @m02 = @m02 - @money02
			end
			
			if @money03>0 and @money03>=@m03
			begin
				update #z_cub_rkp04a set money03 = money03 - @m03 where sel=@sel
				set @m03 = 0
			end
			else if @money03>0 and @money03<@m03
			begin 
				update #z_cub_rkp04a set money03 = 0 where sel=@sel
				set @m03 = @m03 - @money03
			end
			
			if @money04>0 and @money04>=@m01
			begin
				update #z_cub_rkp04a set money04 = money04 - @m04 where sel=@sel
				set @m01 = 0
			end
			else if @money04>0 and @money04<@m01
			begin 
				update #z_cub_rkp04a set money04 = 0 where sel=@sel
				set @m04 = @m04 - @money04
			end

			fetch next from cursor_table2
			into @sel,@money01,@money01,@money01,@money01
		end
		close cursor_table2
		deallocate cursor_table2
		
		--假如尾差依舊消不掉,直接找最後一筆消掉
		update #z_cub_rkp04a set money01 = money01-@m01
			,money02 = money02-@m02
			,money03 = money03-@m03
			,money04 = money04-@m04
		from #z_cub_rkp04a a
		outer apply (select top 1 sel from #z_cub_rkp04a order by datea desc,accy desc,noa desc,noq desc) b
		where a.sel=b.sel
		
		fetch next from cursor_table
		into @makeno,@m01,@m02,@m03,@m04
	end
	close cursor_table
	deallocate cursor_table
	--TEST
	--update @tmp set tm01=b.money01,tm02=b.money02,tm03=b.money03,tm04=b.money04
	--from @tmp a
	--left join (select tmakeno
	--	,SUM(money01) money01 
	--	,SUM(money02) money02 
	--	,SUM(money03) money03 
	--	,SUM(money04) money04 
	--	from #z_cub_rkp04a group by tmakeno) b on a.makeno=b.tmakeno 
		
	--select * from @tmp
	--select * from #z_cub_rkp04a where makeno='M175A25-1'
	--select * from #z_cub_rkp04a
	
	-----------------------------------------------------------------------
	--裁切  CUC
	delete @tmp
	insert into @tmp(makeno,m01,m02,m03,m04)
	select isnull(a.makeno,'')
		,sum(isnull(a.price5,0))
		,sum(isnull(a.price6,0))
		,sum(isnull(a.price7,0))
		,sum(isnull(a.price8,0))
	from costas a
	left join costa b on a.noa=b.noa
	where b.mon=@t_mon
	group by isnull(a.makeno,'')
	
	IF OBJECT_ID('tempdb..#z_cub_rkp04b')is not null
	BEGIN
		drop table #z_cub_rkp04b
	END
	create table #z_cub_rkp04b(
		sel int identity(1,1)
		,tablea nvarchar(20)
		,datea nvarchar(20)
		,accy nvarchar(10)
		,noa nvarchar(20)
		,noq nvarchar(10)
		,makeno nvarchar(30)
		,tmakeno nvarchar(30)
		,mins float
		,money01 float
		,money02 float
		,money03 float
		,money04 float
	)
	insert into #z_cub_rkp04b(tablea,datea,accy,noa,noq,makeno,tmakeno,mins)
	select 'cucs',b.datea,a.accy,a.noa,a.noq,a.cubno,ISNULL(c.makeno,''),isnull(a.mins,0)
	from view_cucs a
	left join view_cuc b on a.noa=b.noa
	left join @tmp c on a.cubno=c.makeno
	where left(b.datea,6)=@t_mon
	and isnull(a.mins,0)!=0
	order by a.accy,a.noa,a.noq
	
	--工時統計
	update @tmp set totmins=ISNULL(b.mins,0)
	from @tmp a
	left join (select tmakeno,SUM(ISNULL(mins,0)) mins
		from #z_cub_rkp04b 
		group by tmakeno) b on a.makeno=b.tmakeno
	--初步分攤金額
	update #z_cub_rkp04b set 
		money01 = case when b.totmins=0 then 0 else round(b.m01*a.mins/b.totmins,0) end
		,money02 = case when b.totmins=0 then 0 else round(b.m02*a.mins/b.totmins,0) end
		,money03 = case when b.totmins=0 then 0 else round(b.m03*a.mins/b.totmins,0) end
		,money04 = case when b.totmins=0 then 0 else round(b.m04*a.mins/b.totmins,0) end
	from #z_cub_rkp04b a
	left join @tmp b on a.tmakeno=b.makeno

	--統計金額
	update @tmp set tm01=b.money01,tm02=b.money02,tm03=b.money03,tm04=b.money04
	from @tmp a
	left join (select tmakeno
		,SUM(money01) money01 
		,SUM(money02) money02 
		,SUM(money03) money03 
		,SUM(money04) money04 
		from #z_cub_rkp04b group by tmakeno) b on a.makeno=b.tmakeno 

	--尾差由最後一筆攤提,但金額最多扣到0
	declare cursor_table cursor for
	select makeno,tm01-m01,tm02-m02,tm03-m03,tm04-m04 from @tmp
	open cursor_table
	fetch next from cursor_table
	into @makeno,@m01,@m02,@m03,@m04
	while(@@FETCH_STATUS <> -1)
	begin	
		
		declare cursor_table2 cursor for
		select sel,money01,money02,money03,money04 
		from #z_cub_rkp04b
		where makeno=@makeno
		order by datea desc,accy desc,noa desc,noq desc
		open cursor_table2
		fetch next from cursor_table2
		into @sel,@money01,@money01,@money01,@money01
		while(@@FETCH_STATUS <> -1)
		begin	
			if @m01=0 and @m02=0 and @m03=0 and @m04=0
			begin
				break
			end
			
			if @money01>0 and @money01>=@m01
			begin
				update #z_cub_rkp04b set money01 = money01 - @m01 where sel=@sel
				set @m01 = 0
			end
			else if @money01>0 and @money01<@m01
			begin 
				update #z_cub_rkp04b set money01 = 0 where sel=@sel
				set @m01 = @m01 - @money01
			end
			
			if @money02>0 and @money02>=@m02
			begin
				update #z_cub_rkp04b set money02 = money02 - @m02 where sel=@sel
				set @m02 = 0
			end
			else if @money02>0 and @money02<@m02
			begin 
				update #z_cub_rkp04b set money02 = 0 where sel=@sel
				set @m02 = @m02 - @money02
			end
			
			if @money03>0 and @money03>=@m03
			begin
				update #z_cub_rkp04b set money03 = money03 - @m03 where sel=@sel
				set @m03 = 0
			end
			else if @money03>0 and @money03<@m03
			begin 
				update #z_cub_rkp04b set money03 = 0 where sel=@sel
				set @m03 = @m03 - @money03
			end
			
			if @money04>0 and @money04>=@m01
			begin
				update #z_cub_rkp04b set money04 = money04 - @m04 where sel=@sel
				set @m01 = 0
			end
			else if @money04>0 and @money04<@m01
			begin 
				update #z_cub_rkp04b set money04 = 0 where sel=@sel
				set @m04 = @m04 - @money04
			end

			fetch next from cursor_table2
			into @sel,@money01,@money01,@money01,@money01
		end
		close cursor_table2
		deallocate cursor_table2
		
		--假如尾差依舊消不掉,直接找最後一筆消掉
		update #z_cub_rkp04b set money01 = money01-@m01
			,money02 = money02-@m02
			,money03 = money03-@m03
			,money04 = money04-@m04
		from #z_cub_rkp04b a
		outer apply (select top 1 sel from #z_cub_rkp04b order by datea desc,accy desc,noa desc,noq desc) b
		where a.sel=b.sel
		
		fetch next from cursor_table
		into @makeno,@m01,@m02,@m03,@m04
	end
	close cursor_table
	deallocate cursor_table
	----------------------------------------------------------------------------------------------------------
	-- UPDATE DATA
	declare @table nvarchar(20)
	declare @accy nvarchar(20)
	declare cursor_table cursor for
	select tablea,accy from #z_cub_rkp04a group by tablea,accy
	open cursor_table
	fetch next from cursor_table
	into @table,@accy
	while(@@FETCH_STATUS <> -1)
	begin
		set @cmd=
		"update "+@table+@accy+" set w01=0,w02=0,w04=0,w05=0
		from "+@table+@accy+" a
		left join #z_cub_rkp04a b on b.tablea=@table and b.accy=@accy and a.noa=b.noa and a.noq=b.noq
		where b.noa is null"
		execute sp_executesql @cmd,N'@table nvarchar(20),@accy nvarchar(10)',@table=@table,@accy=@accy
		
		set @cmd=
		"update "+@table+@accy+" set w01=b.money01,w02=b.money02,w04=b.money03,w05=b.money04
		from "+@table+@accy+" a
		left join #z_cub_rkp04a b on b.tablea=@table and b.accy=@accy and a.noa=b.noa and a.noq=b.noq
		where b.noa is not null"
		execute sp_executesql @cmd,N'@table nvarchar(20),@accy nvarchar(10)',@table=@table,@accy=@accy

		fetch next from cursor_table
		into @table,@accy
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select tablea,accy from #z_cub_rkp04b group by tablea,accy
	open cursor_table
	fetch next from cursor_table
	into @table,@accy
	while(@@FETCH_STATUS <> -1)
	begin
		set @cmd=
		"update "+@table+@accy+" set w01=0,w02=0,w04=0,w05=0
		from "+@table+@accy+" a
		left join #z_cub_rkp04b b on b.tablea=@table and b.accy=@accy and a.noa=b.noa and a.noq=b.noq
		where b.noa is null"
		execute sp_executesql @cmd,N'@table nvarchar(20),@accy nvarchar(10)',@table=@table,@accy=@accy
		
		set @cmd=
		"update "+@table+@accy+" set w01=b.money01,w02=b.money02,w04=b.money03,w05=b.money04
		from "+@table+@accy+" a
		left join #z_cub_rkp04b b on b.tablea=@table and b.accy=@accy and a.noa=b.noa and a.noq=b.noq
		where b.noa is not null"
		execute sp_executesql @cmd,N'@table nvarchar(20),@accy nvarchar(10)',@table=@table,@accy=@accy

		fetch next from cursor_table
		into @table,@accy
	end
	close cursor_table
	deallocate cursor_table
	
	drop table #z_cub_rkp04a
	drop table #z_cub_rkp04b
	select '0' gno, '結轉完成!' msg;