z_cub_rkp11:--z_cub_rkp11	營業成本表
	SET QUOTED_IDENTIFIER OFF 
	declare @cmd nvarchar(max)
	declare @t_path nvarchar(max) = '[1]'
	declare @t_db nvarchar(max) = '[2]'
	
	declare @t_bdate nvarchar(max) = case when '#non' = [4] then '' else [4] end
	declare @t_edate nvarchar(max) = case when '#non' = [5] then char(255) else [5] end
	----------------------------------------------------------------------------------------------------------
	declare @tmpKind table(
		kind nvarchar(20)
		,product nvarchar(50)
	)
	insert into @tmpKind(kind,product)
	select 'A1','金屬底材'
	union
	select 'A4','皮膜'
	union
	select 'A5','保護膜'
	union
	select 'A6','物料'
	union
	select 'A7','成品'
	union
	select 'A8','溶劑'
	--------------------------------------------------------------------------------------------------
--============================================================================================	
	-- 原物料
--============================================================================================
	IF OBJECT_ID('tempdb..#z_cub_rkp08a')is not null
	BEGIN
		drop table #z_cub_rkp08a
	END
	select * into #z_cub_rkp08a from [dbo].[material_rk](@t_bdate,@t_edate,'','','z')
	declare @tmp table(
		sel int identity(1,1)
		,gno nvarchar(10)
		,attr nvarchar(10)
		,typea nvarchar(20)
		,kind nvarchar(20)
		,product nvarchar(20)
		,itemno nvarchar(20)
		,item nvarchar(50)
		,[mount] float
		,[weight] float
		,[price] float
		,[money] float
	)
	--期初存貨 1
	insert into @tmp(gno,attr,typea,kind,product,itemno,item,mount,[weight],[money])
	select  '1','1'
		,case when (ISNULL(a.weight01,0)>0 and ISNULL(a.price01,0)=0) or (ISNULL(a.weight12,0)>0 and ISNULL(a.price12,0)=0) then '客供' else '' end
		,ISNULL(b.kind,''),ISNULL(c.product,'')
		,'A01' 
		,'期初' 
		,sum(isnull(a.mount01,0)),sum(isnull(a.weight01,0)),sum(isnull(a.total01,0))
	from #z_cub_rkp08a a
	left join view_uccb b on a.uno=b.uno
	left join @tmpKind c on b.kind=c.kind
	group by case when (ISNULL(a.weight01,0)>0 and ISNULL(a.price01,0)=0) or (ISNULL(a.weight12,0)>0 and ISNULL(a.price12,0)=0) then '客供' else '' end
		,ISNULL(b.kind,''),ISNULL(c.product,'')
	--盤點調整 2
	insert into @tmp(gno,attr,typea,kind,product,itemno,item,mount,[weight],[money])
	select  '1','1'
		,case when (ISNULL(a.weight01,0)>0 and ISNULL(a.price01,0)=0) or (ISNULL(a.weight12,0)>0 and ISNULL(a.price12,0)=0) then '客供' else '' end
		,ISNULL(b.kind,''),ISNULL(c.product,''),'A02','盤點'
		,sum(isnull(a.mount02,0)),sum(isnull(a.weight02,0)),sum(isnull(a.total02,0))
	from #z_cub_rkp08a a
	left join view_uccb b on a.uno=b.uno
	left join @tmpKind c on b.kind=c.kind
	group by case when (ISNULL(a.weight01,0)>0 and ISNULL(a.price01,0)=0) or (ISNULL(a.weight12,0)>0 and ISNULL(a.price12,0)=0) then '客供' else '' end
		,ISNULL(b.kind,''),ISNULL(c.product,'')
	--本期購入3
	insert into @tmp(gno,attr,typea,kind,product,itemno,item,mount,[weight],[money])
	select  '1','1'
		,case when (ISNULL(a.weight01,0)>0 and ISNULL(a.price01,0)=0) or (ISNULL(a.weight12,0)>0 and ISNULL(a.price12,0)=0) then '客供' else '' end
		,ISNULL(b.kind,''),ISNULL(c.product,''),'A03','購入'
		,sum(isnull(a.mount03,0)),sum(isnull(a.weight03,0)),sum(isnull(a.total03,0))
	from #z_cub_rkp08a a
	left join view_uccb b on a.uno=b.uno
	left join @tmpKind c on b.kind=c.kind
	group by case when (ISNULL(a.weight01,0)>0 and ISNULL(a.price01,0)=0) or (ISNULL(a.weight12,0)>0 and ISNULL(a.price12,0)=0) then '客供' else '' end
		,ISNULL(b.kind,''),ISNULL(c.product,'')
	
	--本期領料 5
	insert into @tmp(gno,attr,typea,kind,product,itemno,item,mount,[weight],[money])
	select  '1','1'
		,case when (ISNULL(a.weight01,0)>0 and ISNULL(a.price01,0)=0) or (ISNULL(a.weight12,0)>0 and ISNULL(a.price12,0)=0) then '客供' else '' end
		,ISNULL(b.kind,''),ISNULL(c.product,''),'B05','領料'
		,sum(isnull(a.mount05,0)),sum(isnull(a.weight05,0)),sum(isnull(a.total05,0))
	from #z_cub_rkp08a a
	left join view_uccb b on a.uno=b.uno
	left join @tmpKind c on b.kind=c.kind
	group by case when (ISNULL(a.weight01,0)>0 and ISNULL(a.price01,0)=0) or (ISNULL(a.weight12,0)>0 and ISNULL(a.price12,0)=0) then '客供' else '' end
		,ISNULL(b.kind,''),ISNULL(c.product,'')
	--本期自調入 6
	insert into @tmp(gno,attr,typea,kind,product,itemno,item,mount,[weight],[money])
	select  '1','1'
		,case when (ISNULL(a.weight01,0)>0 and ISNULL(a.price01,0)=0) or (ISNULL(a.weight12,0)>0 and ISNULL(a.price12,0)=0) then '客供' else '' end
		,ISNULL(b.kind,''),ISNULL(c.product,''),'A06','自調入'
		,sum(isnull(a.mount06,0)),sum(isnull(a.weight06,0)),sum(isnull(a.total06,0))
	from #z_cub_rkp08a a
	left join view_uccb b on a.uno=b.uno
	left join @tmpKind c on b.kind=c.kind
	group by case when (ISNULL(a.weight01,0)>0 and ISNULL(a.price01,0)=0) or (ISNULL(a.weight12,0)>0 and ISNULL(a.price12,0)=0) then '客供' else '' end
		,ISNULL(b.kind,''),ISNULL(c.product,'')
	--本期自調用料 7
	insert into @tmp(gno,attr,typea,kind,product,itemno,item,mount,[weight],[money])
	select  '1','1'
		,case when (ISNULL(a.weight01,0)>0 and ISNULL(a.price01,0)=0) or (ISNULL(a.weight12,0)>0 and ISNULL(a.price12,0)=0) then '客供' else '' end
		,ISNULL(b.kind,''),ISNULL(c.product,''),'B07','自調用料'
		,sum(isnull(a.mount07,0)),sum(isnull(a.weight07,0)),sum(isnull(a.total07,0))
	from #z_cub_rkp08a a
	left join view_uccb b on a.uno=b.uno
	left join @tmpKind c on b.kind=c.kind
	group by case when (ISNULL(a.weight01,0)>0 and ISNULL(a.price01,0)=0) or (ISNULL(a.weight12,0)>0 and ISNULL(a.price12,0)=0) then '客供' else '' end
		,ISNULL(b.kind,''),ISNULL(c.product,'')
	--本期銷貨 8
	insert into @tmp(gno,attr,typea,kind,product,itemno,item,mount,[weight],[money])
	select  '1','1'
		,case when (ISNULL(a.weight01,0)>0 and ISNULL(a.price01,0)=0) or (ISNULL(a.weight12,0)>0 and ISNULL(a.price12,0)=0) then '客供' else '' end
		,ISNULL(b.kind,''),ISNULL(c.product,''),'B08','銷貨'
		,sum(isnull(a.mount08,0)),sum(isnull(a.weight08,0)),sum(isnull(a.total08,0))
	from #z_cub_rkp08a a
	left join view_uccb b on a.uno=b.uno
	left join @tmpKind c on b.kind=c.kind
	group by case when (ISNULL(a.weight01,0)>0 and ISNULL(a.price01,0)=0) or (ISNULL(a.weight12,0)>0 and ISNULL(a.price12,0)=0) then '客供' else '' end
		,ISNULL(b.kind,''),ISNULL(c.product,'')
	--本期銷貨退回	9
	insert into @tmp(gno,attr,typea,kind,product,itemno,item,mount,[weight],[money])
	select  '1','1'
		,case when (ISNULL(a.weight01,0)>0 and ISNULL(a.price01,0)=0) or (ISNULL(a.weight12,0)>0 and ISNULL(a.price12,0)=0) then '客供' else '' end
		,ISNULL(b.kind,''),ISNULL(c.product,''),'A09','銷貨退回'
		,sum(isnull(a.mount09,0)),sum(isnull(a.weight09,0)),sum(isnull(a.total09,0))
	from #z_cub_rkp08a a
	left join view_uccb b on a.uno=b.uno
	left join @tmpKind c on b.kind=c.kind
	group by case when (ISNULL(a.weight01,0)>0 and ISNULL(a.price01,0)=0) or (ISNULL(a.weight12,0)>0 and ISNULL(a.price12,0)=0) then '客供' else '' end
		,ISNULL(b.kind,''),ISNULL(c.product,'')
	--本期報廢 10
	insert into @tmp(gno,attr,typea,kind,product,itemno,item,mount,[weight],[money])
	select  '1','1'
		,case when (ISNULL(a.weight01,0)>0 and ISNULL(a.price01,0)=0) or (ISNULL(a.weight12,0)>0 and ISNULL(a.price12,0)=0) then '客供' else '' end
		,ISNULL(b.kind,''),ISNULL(c.product,''),'B10','報廢'
		,sum(isnull(a.mount10,0)),sum(isnull(a.weight10,0)),sum(isnull(a.total10,0))
	from #z_cub_rkp08a a
	left join view_uccb b on a.uno=b.uno
	left join @tmpKind c on b.kind=c.kind
	group by case when (ISNULL(a.weight01,0)>0 and ISNULL(a.price01,0)=0) or (ISNULL(a.weight12,0)>0 and ISNULL(a.price12,0)=0) then '客供' else '' end
		,ISNULL(b.kind,''),ISNULL(c.product,'')
	--本期退料 11
	insert into @tmp(gno,attr,typea,kind,product,itemno,item,mount,[weight],[money])
	select  '1','1'
		,case when (ISNULL(a.weight01,0)>0 and ISNULL(a.price01,0)=0) or (ISNULL(a.weight12,0)>0 and ISNULL(a.price12,0)=0) then '客供' else '' end
		,ISNULL(b.kind,''),ISNULL(c.product,''),'B11','退料'
		,sum(isnull(a.mount11,0)),sum(isnull(a.weight11,0)),sum(isnull(a.total11,0))
	from #z_cub_rkp08a a
	left join view_uccb b on a.uno=b.uno
	left join @tmpKind c on b.kind=c.kind
	group by case when (ISNULL(a.weight01,0)>0 and ISNULL(a.price01,0)=0) or (ISNULL(a.weight12,0)>0 and ISNULL(a.price12,0)=0) then '客供' else '' end
		,ISNULL(b.kind,''),ISNULL(c.product,'')
	--期末存貨 12
	insert into @tmp(gno,attr,typea,kind,product,itemno,item,mount,[weight],[money])
	select  '1','1'
		,case when (ISNULL(a.weight01,0)>0 and ISNULL(a.price01,0)=0) or (ISNULL(a.weight12,0)>0 and ISNULL(a.price12,0)=0) then '客供' else '' end
		,ISNULL(b.kind,''),ISNULL(c.product,''),'C12','期末存貨'
		,sum(isnull(a.mount12,0)),sum(isnull(a.weight12,0)),sum(isnull(a.total12,0))
	from #z_cub_rkp08a a
	left join view_uccb b on a.uno=b.uno
	left join @tmpKind c on b.kind=c.kind
	group by case when (ISNULL(a.weight01,0)>0 and ISNULL(a.price01,0)=0) or (ISNULL(a.weight12,0)>0 and ISNULL(a.price12,0)=0) then '客供' else '' end
		,ISNULL(b.kind,''),ISNULL(c.product,'')
	--本期耗料 4
	insert into @tmp(gno,attr,typea,kind,product,itemno,item,mount,[weight],[money])
	select  '2','1'
		,case when (ISNULL(a.weight01,0)>0 and ISNULL(a.price01,0)=0) or (ISNULL(a.weight12,0)>0 and ISNULL(a.price12,0)=0) then '客供' else '' end
		,ISNULL(b.kind,''),ISNULL(c.product,''),'D01','耗料'
		,sum(isnull(a.mount04,0)),sum(isnull(a.weight04,0)),sum(isnull(a.total04,0))
	from #z_cub_rkp08a a
	left join view_uccb b on a.uno=b.uno
	left join @tmpKind c on b.kind=c.kind
	group by case when (ISNULL(a.weight01,0)>0 and ISNULL(a.price01,0)=0) or (ISNULL(a.weight12,0)>0 and ISNULL(a.price12,0)=0) then '客供' else '' end
		,ISNULL(b.kind,''),ISNULL(c.product,'')
	--------------------------------------------------------------------------------------------------
	delete @tmp where mount=0 and [weight]=0 and [money]=0 and itemno!='D01'  --耗料還是要顯示
	--------------------------------------------------------------------------------------------------
--============================================================================================
	-- 在製品
--============================================================================================
	IF OBJECT_ID('tempdb..#z_cub_rkp08b')is not null
	BEGIN
		drop table #z_cub_rkp08b
	END
	select * into #z_cub_rkp08b from [dbo].[unfinished_rk](@t_bdate,@t_edate)

	--期初
	insert into @tmp(gno,attr,typea,kind,product,itemno,item,[weight],[money])
	select '1','2' attr,'' typea,'' kind,'在製品' product,'A01' itemno,'期初' item
		,sum(isnull(a.[weight01],0)),sum(isnull(a.[total01],0))
	from #z_cub_rkp08b a
	--完工投入 
	insert into @tmp(gno,attr,typea,kind,product,itemno,item,[weight],[money])
	select '1','2' attr,'' typea,'' kind,'在製品' product,'A01' itemno,'完工投入' item
		,sum(isnull(a.[weight03],0)),sum(isnull(a.[total03],0))
	from #z_cub_rkp08b a
	--期末
	insert into @tmp(gno,attr,typea,kind,product,itemno,item,[weight],[money])
	select '1','2' attr,'' typea,'' kind,'在製品' product,'C01' itemno,'期末' item
		,sum(isnull(a.[weight07],0)),sum(isnull(a.[total07],0))
	from #z_cub_rkp08b a
	--耗料
	insert into @tmp(gno,attr,typea,kind,product,itemno,item,[weight],[money])
	select '2','2' attr,'' typea,'' kind,'在製品' product,'A01' itemno,'耗料' item
		,sum(isnull(a.[weight04],0)),sum(isnull(a.[total04],0))
	from #z_cub_rkp08b a
	---------------------------------------------------------------------------
--============================================================================================
	--製成品
--============================================================================================	
	IF OBJECT_ID('tempdb..#z_cub_rkp08c')is not null
	BEGIN
		drop table #z_cub_rkp08c
	END
	select * into #z_cub_rkp08c from [dbo].[finished_rk](@t_bdate,@t_edate)
	
	--select * from #z_cub_rkp08c
	--select * from @tmp
	
	--期初
	insert into @tmp(gno,attr,typea,kind,product,itemno,item,[weight],[money])
	select '1','3' attr,'' typea,'' kind,'製成品' product,'A01' itemno,'期初' item
		,sum(isnull(a.[w01],0)),sum(isnull(a.[m01],0))
	from #z_cub_rkp08c a
	
	--本月生產	
	insert into @tmp(gno,attr,typea,kind,product,itemno,item,[weight],[money])
	select '1','3' attr,'' typea,'' kind,'製成品' product,'A01' itemno,'本月生產' item
		,sum(isnull(a.[w02],0)),sum(isnull(a.[m02],0))
	from #z_cub_rkp08c a		
	--盤點調整			
	insert into @tmp(gno,attr,typea,kind,product,itemno,item,[weight],[money])
	select '1','3' attr,'' typea,'' kind,'製成品' product,'A01' itemno,'盤點調整' item
		,sum(isnull(a.[w03],0)),sum(isnull(a.[m03],0))
	from #z_cub_rkp08c a
	--本期領料			
	insert into @tmp(gno,attr,typea,kind,product,itemno,item,[weight],[money])
	select '1','3' attr,'' typea,'' kind,'製成品' product,'A01' itemno,'本期領料' item
		,sum(isnull(a.[w04],0)),sum(isnull(a.[m04],0))
	from #z_cub_rkp08c a
	--本期報廢			
	insert into @tmp(gno,attr,typea,kind,product,itemno,item,[weight],[money])
	select '1','3' attr,'' typea,'' kind,'製成品' product,'A01' itemno,'本期報廢' item
		,sum(isnull(a.[w05],0)),sum(isnull(a.[m05],0))
	from #z_cub_rkp08c a
	--銷貨退回			
	insert into @tmp(gno,attr,typea,kind,product,itemno,item,[weight],[money])
	select '1','3' attr,'' typea,'' kind,'製成品' product,'A01' itemno,'銷貨退回' item
		,sum(isnull(a.[w06],0)),sum(isnull(a.[m06],0))
	from #z_cub_rkp08c a
	--委外加工			
	insert into @tmp(gno,attr,typea,kind,product,itemno,item,[weight],[money])
	select '1','3' attr,'' typea,'' kind,'製成品' product,'A01' itemno,'委外加工' item
		,sum(isnull(a.[w07],0)),sum(isnull(a.[m07],0))
	from #z_cub_rkp08c a
	----本月銷售收入  			
	--insert into @tmp(gno,attr,typea,kind,product,itemno,item,[weight],[money])
	--select 1,'3' attr,'' typea,'' kind,'製成品' product,'A01' itemno,'委外加工' item
	--	,sum(isnull(a.[w08],0)),sum(isnull(a.[m08],0))
	--from #z_cub_rkp08c a
	--本月銷售成本		
	insert into @tmp(gno,attr,typea,kind,product,itemno,item,[weight],[money])
	select '1','3' attr,'' typea,'' kind,'製成品' product,'A01' itemno,'銷售' item
		,sum(isnull(a.[w09],0)),sum(isnull(a.[m09],0))
	from #z_cub_rkp08c a	
	----銷售毛利
	--insert into @tmp(gno,attr,typea,kind,product,itemno,item,[weight],[money])
	--select 1,'3' attr,'' typea,'' kind,'製成品' product,'A01' itemno,'期初' item
	--	,sum(isnull(a.[w01],0)),sum(isnull(a.[m01],0))
	--from #z_cub_rkp08c a
	
	
	--期末 W11 P11 M11
	insert into @tmp(gno,attr,typea,kind,product,itemno,item,[weight],[money])
	select '1','3' attr,'' typea,'' kind,'製成品' product,'A01' itemno,'期末' item
		,sum(isnull(a.[w11],0)),sum(isnull(a.[m11],0))
	from #z_cub_rkp08c a

	update @tmp set price = case when [money]=0 or [weight]=0 then null else ROUND([money]/[weight],2) end
	--insert into @tmp(item,mount,[weight],[money])
	--select *
	--from #z_cub_rkp08b a
	--group by
	
	--select * from #z_cub_rkp08a
--	select * from #z_cub_rkp08b
	
	select gno
		, product a01
		, item + case when len(isnull(typea,''))>0 then '-' else '' end + typea a02
		, dbo.getComma(mount,-1) b01
		, dbo.getComma(weight,-1) b02
		, dbo.getComma(price,-1) b03
		, dbo.getComma([money],-1) b04 
	from @tmp 
	order by attr,typea,kind,sel
	drop table #z_cub_rkp08a
	drop table #z_cub_rkp08b
	drop table #z_cub_rkp08c;
	


z_cub_rkp08:--z_cub_rkp08	製成品彙總表
	SET QUOTED_IDENTIFIER OFF 
	declare @cmd nvarchar(max)
	declare @t_path nvarchar(max) = '[1]'
	declare @t_db nvarchar(max) = '[2]'
	
	declare @t_bdate nvarchar(max) = case when '#non' = [4] then '' else [4] end
	declare @t_edate nvarchar(max) = case when '#non' = [5] then char(255) else [5] end
	declare @t_makeno nvarchar(max) = case when '#non' = [8] then '' else [8] end
	declare @t_uno nvarchar(max) = case when '#non' = [9] then '' else [9] end
	declare @t_ordeno nvarchar(max) = case when '#non' = [12] then '' else [12] end
	-------------------------------------------------------------------------------------
	declare @tmp table(
		sel int identity(1,1)
		,recno int
		,gno nvarchar(20)
		,pno int
		,datea nvarchar(20)
		,typea nvarchar(20) -- 業種
		,dime float
		,radius float
		,width float
		,lengthb float
		,pvcno nvarchar(20)
		,makeno nvarchar(20)
		,uno nvarchar(30)
		,accy nvarchar(10)
		,noa nvarchar(20)
		,noq nvarchar(10)
		,ordeaccy nvarchar(10)
		,ordeno nvarchar(20)
		,no2 nvarchar(10)
		,[weight] float
		,[money] float
		,[price] float
		--期初存貨
		,w01 float
		,p01 float
		,m01 float
		--本月生產			
		,w02 float
		,p02 float
		,m02 float
		--盤點調整	
		,w03 float
		,p03 float
		,m03 float	
		--本期領料
		,w04 float
		,p04 float
		,m04 float	
		--本期報廢			
		,w05 float
		,p05 float
		,m05 float
		--銷貨退回	
		,w06 float
		,p06 float
		,m06 float		
		--委外加工	
		,w07 float
		,p07 float
		,m07 float		
		--本月銷售收入  			
		,w08 float
		,p08 float
		,m08 float
		--本月銷售成本			
		,w09 float
		,p09 float
		,m09 float
		--銷售毛利	
		,w10 float
		,p10 float
		,m10 float
		
		--期末存貨		
		,w11 float
		,p11 float
		,m11 float
		
	)
	insert into @tmp(gno,pno,datea,typea,dime,radius,width,lengthb,pvcno,makeno,uno,accy,noa,noq
		,ordeaccy,ordeno,no2,[weight],[money])
	select '1',1,a.datea,case when len(isnull(c.product,''))=0 then isnull(b.custpro,'') else isnull(c.product,'') end
		,a.dime,a.radius,a.width,a.lengthb,a.spec,a.cname,a.bno,a.accy,a.noa,a.noq
		,b.accy,a.ordeno,a.no2,a.[weight],a.[total]
	from view_cuts a
	left join view_ordes b on a.ordeno=b.noa and a.no2=b.no2
	left join adpro c on b.custpro=c.noa
	where a.datea<=@t_edate
	and len(ISNULL(a.bno,''))>0
	and (len(@t_makeno)=0 or a.cname=@t_makeno)
	and (len(@t_uno)=0 or a.bno=@t_uno)
	and (len(@t_ordeno)=0 or a.ordeno=@t_ordeno)
	
	update @tmp set price = case when ISNULL([weight],0)=0 then 0 else ROUND([money]/[weight],2) end
	---------------------------------------------------------------------------------------------------
	IF OBJECT_ID('tempdb..#z_cub_rkp08_uno')is not null
	BEGIN
		drop table #z_cub_rkp08_uno
	END
	create table #z_cub_rkp08_uno(
		sel int identity(1,1)
		,uno nvarchar(20)
		,price float
	)
	insert into #z_cub_rkp08_uno(uno,price)select uno,price from @tmp group by uno,price
	
	--期初存貨
	--本月生產	
	declare @tmpA table(
		sel int identity(1,1)
		,uno nvarchar(20)
		,accy nvarchar(10)
		,noa nvarchar(20)
		,noq nvarchar(10)
		,datea nvarchar(20)
		,[weight] float
		,[money] float
	)
	insert into @tmpA(uno,accy,noa,noq,datea,[weight],[money])
	select c.uno,a.accy,a.noa,a.noq,a.datea,isnull(a.[weight],0),isnull(a.total,0)
	from view_cuts a
	left join #z_cub_rkp08_uno c on a.bno=c.uno 
	where c.uno is not null
	--盤點調整	
	declare @tmpB table(
		sel int identity(1,1)
		,uno nvarchar(20)
		,accy nvarchar(10)
		,noa nvarchar(20)
		,noq nvarchar(10)
		,datea nvarchar(20)
		,[weight] float
		,[money] float
	)
	insert into @tmpB(uno,accy,noa,noq,datea,[weight],[money])
	select c.uno,a.accy,a.noa,a.noq,b.datea,isnull(a.[gweight],0),isnull(a.scost,0)
	from view_gets a
	left join view_get b on a.accy=b.accy and a.noa=b.noa
	left join #z_cub_rkp08_uno c on a.uno=c.uno 
	where c.uno is not null 
	and b.typea='盤點'
	--本期領料
	declare @tmpC table(
		sel int identity(1,1)
		,uno nvarchar(20)
		,accy nvarchar(10)
		,noa nvarchar(20)
		,noq nvarchar(10)
		,datea nvarchar(20)
		,[weight] float
		,[money] float
	)
	insert into @tmpC(uno,accy,noa,noq,datea,[weight],[money])
	select c.uno,a.accy,a.noa,a.noq,b.datea,isnull(a.[gweight],0),isnull(a.scost,0)
	from view_gets a
	left join view_get b on a.accy=b.accy and a.noa=b.noa
	left join #z_cub_rkp08_uno c on a.uno=c.uno 
	where c.uno is not null 
	and b.typea='領料單'
	--本期報廢
	declare @tmpD table(
		sel int identity(1,1)
		,uno nvarchar(20)
		,accy nvarchar(10)
		,noa nvarchar(20)
		,noq nvarchar(10)
		,datea nvarchar(20)
		,[weight] float
		,[money] float
	)
	insert into @tmpD(uno,accy,noa,noq,datea,[weight],[money])
	select c.uno,a.accy,a.noa,a.noq,b.datea,isnull(a.[gweight],0),isnull(a.scost,0)
	from view_gets a
	left join view_get b on a.accy=b.accy and a.noa=b.noa
	left join #z_cub_rkp08_uno c on a.uno=c.uno 
	where c.uno is not null 
	and b.typea='報廢'	
	--銷貨退回	
	declare @tmpE table(
		sel int identity(1,1)
		,uno nvarchar(20)
		,accy nvarchar(10)
		,noa nvarchar(20)
		,noq nvarchar(10)
		,datea nvarchar(20)
		,[weight] float
		,[money] float
	)
	insert into @tmpE(uno,accy,noa,noq,datea,[weight],[money])
	select c.uno,a.accy,a.noa,a.noq,b.datea
		,case when isnull(a.[gweight],0)=0 then isnull(a.[weight],0) else a.[gweight] end
		,isnull(a.scost,0)
	from view_vccs a
	left join view_vcc b on a.accy=b.accy and a.noa=b.noa
	left join #z_cub_rkp08_uno c on a.uno=c.uno 
	where c.uno is not null 
	and b.typea='2'	
	--委外加工	none		
	--本月銷售收入  
	declare @tmpF table(
		sel int identity(1,1)
		,uno nvarchar(20)
		,accy nvarchar(10)
		,noa nvarchar(20)
		,noq nvarchar(10)
		,datea nvarchar(20)
		,[weight] float
		,[money] float
	)
	insert into @tmpF(uno,accy,noa,noq,datea,[weight],[money])
	select c.uno,a.accy,a.noa,a.noq,b.datea
		,case when isnull(a.[gweight],0)=0 then isnull(a.[weight],0) else a.[gweight] end,isnull(a.total,0)
	from view_vccs a
	left join view_vcc b on a.accy=b.accy and a.noa=b.noa
	left join #z_cub_rkp08_uno c on a.uno=c.uno 
	where c.uno is not null 
	and b.typea='1'	
	--本月銷售成本	
	declare @tmpG table(
		sel int identity(1,1)
		,uno nvarchar(20)
		,accy nvarchar(10)
		,noa nvarchar(20)
		,noq nvarchar(10)
		,datea nvarchar(20)
		,[weight] float
		,[money] float
	)
	insert into @tmpG(uno,accy,noa,noq,datea,[weight],[money])
	select c.uno,a.accy,a.noa,a.noq,b.datea
		,case when isnull(a.[gweight],0)=0 then isnull(a.[weight],0) else a.[gweight] end
		,isnull(a.scost,0)
	from view_vccs a
	left join view_vcc b on a.accy=b.accy and a.noa=b.noa
	left join #z_cub_rkp08_uno c on a.uno=c.uno 
	where c.uno is not null 
	and b.typea='1'		
	--銷售毛利			
	--期末存貨
	------------------------------------------------------------------------------------------------------------
	------------------------------------------------------------------------------------------------------------
	--期初存貨
	update @tmp set w01 = ISNULL(aa.weight,0)-ISNULL(bb.weight,0)-ISNULL(cc.weight,0)-ISNULL(dd.weight,0)
		+ISNULL(ee.weight,0)-ISNULL(gg.weight,0)
		,m01 = ISNULL(aa.[money],0)-ISNULL(bb.[money],0)-ISNULL(cc.[money],0)-ISNULL(dd.[money],0)
		+ISNULL(ee.[money],0)-ISNULL(gg.[money],0)
	from @tmp a
	outer apply(select SUM([weight]) [weight],SUM([money]) [money] from @tmpA where uno=a.uno and datea<@t_bdate) aa
	outer apply(select SUM([weight]) [weight],SUM([money]) [money] from @tmpB where uno=a.uno and datea<@t_bdate) bb
	outer apply(select SUM([weight]) [weight],SUM([money]) [money] from @tmpC where uno=a.uno and datea<@t_bdate) cc
	outer apply(select SUM([weight]) [weight],SUM([money]) [money] from @tmpD where uno=a.uno and datea<@t_bdate) dd
	outer apply(select SUM([weight]) [weight],SUM([money]) [money] from @tmpE where uno=a.uno and datea<@t_bdate) ee
	outer apply(select SUM([weight]) [weight],SUM([money]) [money] from @tmpG where uno=a.uno and datea<@t_bdate) gg
	
	----本月生產			
	update @tmp set w02 = ISNULL(b.weight,0),m02 = ISNULL(b.money,0) 
	from @tmp a
	outer apply(select SUM([weight]) [weight], SUM([money]) [money] from @tmpA where uno=a.uno and datea>=@t_bdate) b
	----盤點調整	
	update @tmp set w03 = ISNULL(b.weight,0),m03 = ISNULL(b.money,0) 
	from @tmp a
	outer apply(select SUM([weight]) [weight], SUM([money]) [money] from @tmpB where uno=a.uno and datea>=@t_bdate) b	
	----本期領料
	update @tmp set w04 = ISNULL(b.weight,0),m04 = ISNULL(b.money,0) 
	from @tmp a
	outer apply(select SUM([weight]) [weight], SUM([money]) [money] from @tmpC where uno=a.uno and datea>=@t_bdate) b	
	----本期報廢			
	update @tmp set w05 = ISNULL(b.weight,0),m05 = ISNULL(b.money,0) 
	from @tmp a
	outer apply(select SUM([weight]) [weight], SUM([money]) [money] from @tmpD where uno=a.uno and datea>=@t_bdate) b	
	----銷貨退回	
	update @tmp set w06 = ISNULL(b.weight,0),m06 = ISNULL(b.money,0) 
	from @tmp a
	outer apply(select SUM([weight]) [weight], SUM([money]) [money] from @tmpE where uno=a.uno and datea>=@t_bdate) b			
	----委外加工 none
	update @tmp set w07=0,m07=0		
	----本月銷售收入  			
	update @tmp set w08 = ISNULL(b.weight,0),m08 = ISNULL(b.money,0) 
	from @tmp a
	outer apply(select SUM([weight]) [weight], SUM([money]) [money] from @tmpF where uno=a.uno and datea>=@t_bdate) b	
	----本月銷售成本			
	update @tmp set w09 = ISNULL(b.weight,0),m09 = ISNULL(b.money,0) 
	from @tmp a
	outer apply(select SUM([weight]) [weight], SUM([money]) [money] from @tmpG where uno=a.uno and datea>=@t_bdate) b	
	----銷售毛利
	update @tmp set w10=0,m10 = m08-m09
	----期末存貨		
	update @tmp set w11 = w01 + w02 - w03 -w04 - w05 + w06 - w09
		,m11 = m01 + m02 - m03 -m04 - m05 + m06 - m09
	update @tmp set p11 = case when w11=0 then 0 else ROUND(m11/w11,2) end
	----------------------------------------------------------------------------------------------------------------
	delete @tmp where w01=0 and w02=0 and w03=0 and w04=0 and w05=0 and w06=0 and w07=0 and w08=0 and w09=0 and w10=0 and w11=0
		and m01=0 and m02=0 and m03=0 and m04=0 and m05=0 and m06=0 and m07=0 and m08=0 and m09=0 and m10=0 and m11=0
	
	update @tmp set p01 = case when w01=0 then null else round(m01/w01,2) end
		,p02 = case when w02=0 then null else round(m02/w02,2) end
		,p03 = case when w03=0 then null else round(m03/w03,2) end
		,p04 = case when w04=0 then null else round(m04/w04,2) end
		,p05 = case when w05=0 then null else round(m05/w05,2) end
		,p06 = case when w06=0 then null else round(m06/w06,2) end
		,p07 = case when w07=0 then null else round(m07/w07,2) end
		,p08 = case when w08=0 then null else round(m08/w08,2) end
		,p09 = case when w09=0 then null else round(m09/w09,2) end
		,p11 = case when w11=0 then null else round(m11/w11,2) end
	----------------------------------------------------------------------------------------------------------------
	insert into @tmp(gno,pno,w01,w02,w03,w04,w05,w06,w07,w08,w09,w10,w11
		,m01,m02,m03,m04,m05,m06,m07,m08,m09,m10,m11)
	select '2',2,SUM(w01),SUM(w02),SUM(w03),SUM(w04),SUM(w05),SUM(w06),SUM(w07),SUM(w08),SUM(w09),SUM(w10),SUM(w11)
		,SUM(m01),SUM(m02),SUM(m03),SUM(m04),SUM(m05),SUM(m06),SUM(m07),SUM(m08),SUM(m09),SUM(m10),SUM(m11)
	from @tmp 
	where pno=1
	
	update @tmp set recno=b.recno
	from @tmp a
	left join (select sel,ROW_NUMBER()over(order by dime,makeno,accy,noa,noq) recno from @tmp where pno=1) b on a.sel=b.sel

	select gno	
		,recno rr
		,typea a01
		,dime a02
		,radius a03
		,width a04
		,lengthb a05
		,pvcno a06
		,makeno a07
		,uno a08
		,ordeno a09
		
		,w01 b01
		,p01 b02
		,m01 b03
		,w02 b04
		,p02 b05
		,m02 b06
		,w03 b07
		,p03 b08
		,m03 b09
		,w04 b10
		,p04 b11
		,m04 b12
		,w05 b13
		,p05 b14
		,m05 b15
		,w06 b16
		,p06 b17
		,m06 b18
		,w07 b19
		,p07 b20
		,m07 b21
		,w08 b22
		,p08 b23
		,m08 b24
		,w09 b25
		,p09 b26
		,m09 b27
		,m10 b28
		,w11 b29
		,p11 b30
		,m11 b31
	from @tmp 
	order by pno,recno;
	
z_cub_rkp06:--z_cub_rkp06	製成品單位成本表
	SET QUOTED_IDENTIFIER OFF 
	declare @cmd nvarchar(max)
	declare @t_path nvarchar(max) = '[1]'
	declare @t_db nvarchar(max) = '[2]'
	
	declare @t_bdate nvarchar(max) = case when '#non' = [4] then '' else [4] end
	declare @t_edate nvarchar(max) = case when '#non' = [5] then char(255) else [5] end
	declare @t_makeno nvarchar(max) = case when '#non' = [8] then '' else [8] end
	declare @t_detail nvarchar(max) = case when '#non' = [13] then '' else [13] end
	--------------------------------------------------------------------------------
	IF OBJECT_ID('tempdb..#z_cub_rkp06')is not null
	BEGIN
		drop table #z_cub_rkp06
	END
	create table #z_cub_rkp06(
		sel int identity(1,1),
		recno int,
		gno nvarchar(10),
		pno int,
		dime float,
		radius float,
		width float,
		lengthb float,
		pvcno nvarchar(20), --皮膜
		uno nvarchar(30),
		datea nvarchar(20),
		makeno nvarchar(20),
		custno nvarchar(20),
		cust nvarchar(50),
		weight01 float,--進倉重
		weight02 float,--不良損耗	
		weight03 float,--尺寸損耗	
		weight04 float,--頭尾損耗
		weight05 float,--損耗
		rate05 float,--損耗率
		----------------------------------
		status01 int,--分條
		status02 int,--二呎
		status03 int,--三呎
		status04 int,--四呎
		status05 int,--十呎
		----------------------------------
		w01 float,--在製品完工重
		m01 float,--在製品完工成本  (原物料成本+製費)
		p01 float,--在製品完工單價  (在製品完工成本/在製品完工重)
		w02 float,--在製品樣品重
		m02 float,--在製品樣品成本 =  在製品樣品重*在製品完工單價
		w03 float,--在製品報廢重
		m03 float,--在製品報廢成本 =  在製品報廢重*在製品完工單價
		w04 float,--在製品盤盈
		m04 float,--在製品盤盈成本 =  在製品盤盈*在製品完工單價
	
		money01 float,--加工成本 分條  (不含樣品、報廢、盤盈)
		money02 float,--加工成本 二呎 (不含樣品、報廢、盤盈)
		money03 float,--加工成本 三呎 (不含樣品、報廢、盤盈)
		money04 float,--加工成本 四呎 (不含樣品、報廢、盤盈)
		money05 float,--加工成本 十呎 (不含樣品、報廢、盤盈)
	
		money06 float,--加工成本合計
		price06 float,--加工單位成本
		
		money07 float,--製成品成本金額  =  在製品完工成本 - 在製品樣品成本 - 在製品報廢成本 - 在製品盤盈成本 + 加工成本
		price07 float,--製成品單位成本 = 製成品成本金額 / 進倉重
		memo nvarchar(max),
		ordeno nvarchar(20),
		no2 nvarchar(10),
		accy nvarchar(10),
		noa nvarchar(20),
		noq nvarchar(10)
	)
	declare @makeno nvarchar(20)
	declare @dime float
	declare @pvcno nvarchar(20)
	declare @recno int
	
	declare @tmp table(
		sel int identity(1,1)
		,recno int
		,makeno nvarchar(20)
		,dime float
		,pvcno nvarchar(20)
	)
	
	insert into @tmp(makeno)
	select a.cname from view_cuts a left join view_cut b on a.accy=b.accy and a.noa=b.noa 
	where b.datea between @t_bdate and @t_edate
	and (len(@t_makeno)=0 or a.cname=@t_makeno)
	and len(isnull(a.cname,''))>0
	group by a.cname
	
	update @tmp set dime = b.dime, pvcno= b.spec 
	from @tmp a
	outer apply(select top 1 dime,spec from view_cuts where cname=a.makeno) b
	
	update @tmp set recno=b.recno
	from @tmp a
	left join (select sel,ROW_NUMBER()over(order by dime,makeno,pvcno) recno from @tmp ) b on a.sel=b.sel

	declare cursor_table cursor for 
	select makeno,dime,pvcno,recno from @tmp order by recno
	open cursor_table 
	fetch next from cursor_table 
	into @makeno,@dime,@pvcno,@recno
	while(@@FETCH_STATUS <> -1) 
	begin 
		insert into #z_cub_rkp06(gno,pno,makeno,dime,pvcno,recno)
		select top 1 '1',1,@makeno,@dime,@pvcno,@recno
		
		update #z_cub_rkp06 set weight01=ISNULL(b.weight01,0)
		from #z_cub_rkp06 a
		outer apply(select SUM(ISNULL(weight,0)) weight01 from view_cuts where cname=@makeno) b
		where a.makeno=@makeno
		
		update #z_cub_rkp06 set weight02=ISNULL(b.weight02,0)
			,weight03=ISNULL(b.weight03,0)
			,weight04=ISNULL(b.weight04,0)
		from #z_cub_rkp06 a
		outer apply(select SUM(ISNULL(weight8,0)) weight02,SUM(ISNULL(weight9,0)) weight03,SUM(ISNULL(weight10,0)) weight04 
			from view_cucs where cubno=@makeno) b
		where a.makeno=@makeno
		
		--分條
		update #z_cub_rkp06 set status01 = 1
		where makeno=@makeno 
		and exists(select * from view_cucs a 
			left join view_cuc b on a.accy=b.accy and a.noa=b.noa
			where a.cubno=@makeno and b.typea='分條作業')
		--二呎
		update #z_cub_rkp06 set status02 = 1
		where makeno=@makeno 
		and exists(select * from view_cucs a 
			left join view_cuc b on a.accy=b.accy and a.noa=b.noa
			where a.cubno=@makeno and b.typea='二呎裁切')	
		--三呎
		update #z_cub_rkp06 set status03 = 1
		where makeno=@makeno 
		and exists(select * from view_cucs a 
			left join view_cuc b on a.accy=b.accy and a.noa=b.noa
			where a.cubno=@makeno and b.typea='三呎裁切')
		--四呎
		update #z_cub_rkp06 set status04 = 1
		where makeno=@makeno 
		and exists(select * from view_cucs a 
			left join view_cuc b on a.accy=b.accy and a.noa=b.noa
			where a.cubno=@makeno and b.typea='四呎裁切')
		--十呎
		update #z_cub_rkp06 set status05 = 1
		where makeno=@makeno 
		and exists(select * from view_cucs a 
			left join view_cuc b on a.accy=b.accy and a.noa=b.noa
			where a.cubno=@makeno and b.typea='十呎裁切')
		------------------------------------------------------------------
		--在製品完工重、在製品完工成本
		update #z_cub_rkp06 set w01 = isnull(b.hweight,0),m01=ISNULL(b.total,0)
		from #z_cub_rkp06 a
		outer apply(select SUM(isnull(hweight,0)) hweight,SUM(ISNULL(total,0)) total  from view_cubs where makeno=@makeno) b
		where a.makeno=@makeno
		--在製品完工單價
		update #z_cub_rkp06 set p01 = case when w01 =0 then 0 else ROUND(m01/w01,2) end where makeno=@makeno
		--在製品樣品重,在製品報廢重,在製品盤盈
		update #z_cub_rkp06 set w02 = ISNULL(b.weight6,0),w03 = ISNULL(b.weight7,0),w04 = ISNULL(b.weight11,0)
		from #z_cub_rkp06 a
		outer apply(select SUM(isnull(weight6,0)) weight6,SUM(isnull(weight7,0)) weight7,SUM(isnull(weight11,0)) weight11  from view_cucs where cubno=@makeno) b
		where a.makeno=@makeno
		update #z_cub_rkp06 set m02 = ROUND(w02*p01,0),m03 = ROUND(w03*p01,0),m04 = ROUND(w04*p01,0) where makeno=@makeno
		--加工成本 分條  (不含樣品、報廢、盤盈)
		update #z_cub_rkp06 set money01=ISNULL(b.mm,0)
		from #z_cub_rkp06 a
		outer apply(select SUM(ISNULL(x.w01,0)+ISNULL(x.w02,0)+ISNULL(x.w04,0)+ISNULL(x.w05,0)) mm from view_cucs x
			left join view_cuc y on x.accy=y.accy and x.noa=y.noa
			where x.cubno=@makeno and y.typea='分條作業'
			and ISNULL(x.weight6,0)=0
			and ISNULL(x.weight7,0)=0
			and ISNULL(x.weight11,0)=0) b
		where a.makeno=@makeno
		--加工成本 二呎 (不含樣品、報廢、盤盈)
		update #z_cub_rkp06 set money02=ISNULL(b.mm,0)
		from #z_cub_rkp06 a
		outer apply(select SUM(ISNULL(x.w01,0)+ISNULL(x.w02,0)+ISNULL(x.w04,0)+ISNULL(x.w05,0)) mm from view_cucs x
			left join view_cuc y on x.accy=y.accy and x.noa=y.noa
			where x.cubno=@makeno and y.typea='二呎裁切'
			and ISNULL(x.weight6,0)=0
			and ISNULL(x.weight7,0)=0
			and ISNULL(x.weight11,0)=0) b
		where a.makeno=@makeno
		--加工成本 三呎 (不含樣品、報廢、盤盈)
		update #z_cub_rkp06 set money03=ISNULL(b.mm,0)
		from #z_cub_rkp06 a
		outer apply(select SUM(ISNULL(x.w01,0)+ISNULL(x.w02,0)+ISNULL(x.w04,0)+ISNULL(x.w05,0)) mm from view_cucs x
			left join view_cuc y on x.accy=y.accy and x.noa=y.noa
			where x.cubno=@makeno and y.typea='三呎裁切'
			and ISNULL(x.weight6,0)=0
			and ISNULL(x.weight7,0)=0
			and ISNULL(x.weight11,0)=0) b
		where a.makeno=@makeno
		--加工成本 四呎 (不含樣品、報廢、盤盈)
		update #z_cub_rkp06 set money04=ISNULL(b.mm,0)
		from #z_cub_rkp06 a
		outer apply(select SUM(ISNULL(x.w01,0)+ISNULL(x.w02,0)+ISNULL(x.w04,0)+ISNULL(x.w05,0)) mm from view_cucs x
			left join view_cuc y on x.accy=y.accy and x.noa=y.noa
			where x.cubno=@makeno and y.typea='四呎裁切'
			and ISNULL(x.weight6,0)=0
			and ISNULL(x.weight7,0)=0
			and ISNULL(x.weight11,0)=0) b
		where a.makeno=@makeno
		--加工成本 十呎 (不含樣品、報廢、盤盈)
		update #z_cub_rkp06 set money05=ISNULL(b.mm,0)
		from #z_cub_rkp06 a
		outer apply(select SUM(ISNULL(x.w01,0)+ISNULL(x.w02,0)+ISNULL(x.w04,0)+ISNULL(x.w05,0)) mm from view_cucs x
			left join view_cuc y on x.accy=y.accy and x.noa=y.noa
			where x.cubno=@makeno and y.typea='十呎裁切'
			and ISNULL(x.weight6,0)=0
			and ISNULL(x.weight7,0)=0
			and ISNULL(x.weight11,0)=0) b
		where a.makeno=@makeno
		
		--明細
		insert into #z_cub_rkp06(recno,gno,pno,dime,radius,width,lengthb,pvcno,makeno,uno,custno,cust,datea,memo
			,weight01,ordeno,no2,accy,noa,noq)
		select @recno,'2',ROW_NUMBER()over(order by a.accy,a.noa,a.noq)
			,a.dime,a.radius,a.width,a.lengthb,a.spec,a.cname,a.bno,a.custno,a.comp,a.datea,a.memo
			,a.[weight],a.ordeno,a.no2,a.accy,a.noa,a.noq
		from view_cuts a
		left join view_cut b on a.accy=b.accy and a.no2=b.noa
		where a.cname=@makeno
		order by a.accy,a.noa,a.noq
	
	
		fetch next from cursor_table 
		into @makeno,@dime,@pvcno,@recno
	end 
	close cursor_table 
	deallocate cursor_table 
	-------------------------------------------------------------------------------------------------------
	-- 用進倉重 均攤
	declare @weight01 float,@weight02 float,@weight03 float,@weight04 float
	declare @w01 float,@w02 float,@w03 float,@w04 float
	declare @m01 float,@m02 float,@m03 float,@m04 float
	declare @money01 float,@money02 float,@money03 float,@money04 float,@money05 float
	
	declare cursor_table cursor for 
	select makeno,isnull(weight01,0),weight02,weight03,weight04
		,w01,w02,w03,w04,m01,m02,m03,m04
		,money01,money02,money03,money04,money05
	from #z_cub_rkp06 where gno='1' 
	open cursor_table 
	fetch next from cursor_table 
	into @makeno,@weight01,@weight02,@weight03,@weight04
		,@w01,@w02,@w03,@w04,@m01,@m02,@m03,@m04
		,@money01,@money02,@money03,@money04,@money05
	while(@@FETCH_STATUS <> -1) 
	begin 
		update #z_cub_rkp06 set weight02 = round(weight01/@weight01 * @weight02,0) 
			,weight03 = round(weight01/@weight01 * @weight03,0) 
			,weight04 = round(weight01/@weight01 * @weight04,0) 
			,w01 = round(weight01/@weight01 * @w01,0) 
			,w02 = round(weight01/@weight01 * @w02,0) 
			,w03 = round(weight01/@weight01 * @w03,0) 
			,w04 = round(weight01/@weight01 * @w04,0)
			,m01 = round(weight01/@weight01 * @m01,0) 
			,m02 = round(weight01/@weight01 * @m02,0) 
			,m03 = round(weight01/@weight01 * @m03,0) 
			,m04 = round(weight01/@weight01 * @m04,0)
			,money01 = round(weight01/@weight01 * @money01,0)  
			,money02 = round(weight01/@weight01 * @money02,0)  
			,money03 = round(weight01/@weight01 * @money03,0)  
			,money04 = round(weight01/@weight01 * @money04,0)  
			,money05 = round(weight01/@weight01 * @money05,0)   
		where makeno=@makeno and @weight01!=0 and gno='2'
		--最後一筆修正尾差
		update #z_cub_rkp06 set weight02 = a.weight02 + (@weight02-isnull(c.weight02,0))
			,weight03 = a.weight03 + (@weight03-isnull(c.weight03,0))
			,weight04 = a.weight04 + (@weight04-isnull(c.weight04,0))
			,w01 = a.w01 + (@w01-isnull(c.w01,0))
			,w02 = a.w02 + (@w02-isnull(c.w02,0))
			,w03 = a.w03 + (@w03-isnull(c.w03,0))
			,w04 = a.w04 + (@w04-isnull(c.w04,0))
			,m01 = a.m01 + (@m01-isnull(c.m01,0))
			,m02 = a.m02 + (@m02-isnull(c.m02,0))
			,m03 = a.m03 + (@m03-isnull(c.m03,0))
			,m04 = a.m04 + (@m04-isnull(c.m04,0))
			,money01 = a.money01 + (@money01-isnull(c.money01,0))
			,money02 = a.money02 + (@money02-isnull(c.money02,0))
			,money03 = a.money03 + (@money03-isnull(c.money03,0))
			,money04 = a.money04 + (@money04-isnull(c.money04,0))
			,money05 = a.money05 + (@money05-isnull(c.money05,0))
		from #z_cub_rkp06 a
		outer apply(select top 1 * from #z_cub_rkp06 where gno='2' and makeno=@makeno order by sel desc) b
		outer apply(select SUM(ISNULL(weight02,0)) weight02 
			,SUM(ISNULL(weight03,0)) weight03 
			,SUM(ISNULL(weight04,0)) weight04 
			,SUM(ISNULL(w01,0)) w01 
			,SUM(ISNULL(w02,0)) w02
			,SUM(ISNULL(w03,0)) w03
			,SUM(ISNULL(w04,0)) w04
			,SUM(ISNULL(m01,0)) m01
			,SUM(ISNULL(m02,0)) m02
			,SUM(ISNULL(m03,0)) m03
			,SUM(ISNULL(m04,0)) m04
			,SUM(ISNULL(money01,0)) money01
			,SUM(ISNULL(money02,0)) money02
			,SUM(ISNULL(money03,0)) money03
			,SUM(ISNULL(money04,0)) money04
			,SUM(ISNULL(money05,0)) money05
			from #z_cub_rkp06 where gno='2' and makeno=@makeno ) c
		where a.sel=b.sel
		
		fetch next from cursor_table 
		into @makeno,@weight01,@weight02,@weight03,@weight04
		,@w01,@w02,@w03,@w04,@m01,@m02,@m03,@m04
		,@money01,@money02,@money03,@money04,@money05
	end 
	close cursor_table 
	deallocate cursor_table 
	-------------------------------------------------------------------------------------------------------
	update #z_cub_rkp06 set weight05 = weight02+weight03+weight04
	update #z_cub_rkp06 set rate05 = case when ISNULL(weight01,0)=0 then 0 else ROUND(weight05*100/weight01,2)end
	--加工成本合計
	update #z_cub_rkp06 set money06 = ISNULL(money01,0)+ISNULL(money02,0)+ISNULL(money03,0)+ISNULL(money04,0)+ISNULL(money05,0) 
	--加工單位成本
	update #z_cub_rkp06 set price06 = case when ISNULL(weight01,0)=0 then 0 else ROUND(money06/weight01,2) end
	--製成品成本金額  =  在製品完工成本 - 在製品樣品成本 - 在製品報廢成本 - 在製品盤盈成本 + 加工成本
	update #z_cub_rkp06 set money07= m01 - m02 - m03 - m04 + money06
	--製成品單位成本 = 製成品成本金額 / 進倉重
	update #z_cub_rkp06 set price07 = case when ISNULL(weight01,0)=0 then 0 else ROUND(money07/weight01,2) end
		
	-------------------------------------------------------------------------------------------------------
	select @recno = MAX(recno) from #z_cub_rkp06
	insert into #z_cub_rkp06(recno,gno,weight01,weight02,weight03,weight04,weight05,w01,m01,w02,m02,w03,m03,w04,m04
		,money01,money02,money03,money04,money05,money06,money07)
	select @recno+1,'3',sum(isnull(weight01,0)),sum(isnull(weight02,0)),sum(isnull(weight03,0)),sum(isnull(weight04,0)),sum(isnull(weight05,0))
		,sum(isnull(w01,0)),sum(isnull(m01,0)),sum(isnull(w02,0)),sum(isnull(m02,0)),sum(isnull(w03,0)),sum(isnull(m03,0)),sum(isnull(w04,0)),sum(isnull(m04,0))
		,sum(isnull(money01,0)),sum(isnull(money02,0)),sum(isnull(money03,0)),sum(isnull(money04,0)),sum(isnull(money05,0)),sum(isnull(money06,0)),sum(isnull(money07,0))
	from #z_cub_rkp06
	where gno='1'
	
	--UPDATE DATA
	declare @accy nvarchar(10)
	
	declare cursor_table cursor for 
	select accy from #z_cub_rkp06 group by accy
	open cursor_table 
	fetch next from cursor_table 
	into @accy
	while(@@FETCH_STATUS <> -1) 
	begin 
		set @cmd =
		"update cuts"+@accy+" set total = ISNULL(b.money07,0)
		from cuts"+@accy+" a
		left join #z_cub_rkp06 b on b.accy=@accy and a.noa=b.noa and a.noq=b.noq and gno='2'
		where b.noa is not null"
		execute sp_executesql @cmd,N'@accy nvarchar(10)',@accy=@accy
		
		fetch next from cursor_table 
		into @accy
	end 
	close cursor_table 
	deallocate cursor_table 
	----------------------------------------------------------------------------------------
	--計算 出貨、領料 成本
	
	declare @tmpb table(
		sel int identity(1,1)
		,uno nvarchar(30)
		,[weight] float
		,[money] float
		,[price] float
	)
	insert into @tmpb(uno,[weight],[money],[price])
	select uno,weight01,money07,price07 from #z_cub_rkp06 where gno='2'
	
	--盤點成本
	declare @tmpc table(
		sel int identity(1,1)
		,uno nvarchar(20)
		,[weight] float
		,[money] float
	)
	insert into @tmpc(uno,[weight],[money])
	select a.uno
		,-1*case when ISNULL(a.gweight,0)=0 then ISNULL(a.[weight],0) else a.gweight end
		,-1*ISNULL(a.scost,0)
	from view_gets a
	left join view_get b on a.accy=b.accy and a.noa=b.noa
	left join @tmpb c on a.uno=c.uno
	where c.uno is not null
	and (b.typea='盤點'	) 
	
	
	IF OBJECT_ID('tempdb..#z_cub_rkp06_b')is not null
	BEGIN
		drop table #z_cub_rkp06_b
	END
	create table #z_cub_rkp06_b(
		sel int identity(1,1)
		,uno nvarchar(30)
		,datea nvarchar(20)
		,tablea nvarchar(20)
		,accy nvarchar(10)
		,noa nvarchar(20)
		,noq nvarchar(10)
		,[weight] float
		,[money] float
		,n float
	)
	insert into #z_cub_rkp06_b(uno,datea,tablea,accy,noa,noq,[weight],[money],n)
	select a.uno,b.datea,'vcc',a.accy,a.noa,a.noq
		,case when ISNULL(a.gweight,0)=0 then ISNULL(a.[weight],0) else a.gweight end
		,round(case when ISNULL(a.gweight,0)=0 then ISNULL(a.[weight],0) else a.gweight end * c.price ,0)
		,case when a.typea = '1' then -1 else 1 end
	from view_vccs a
	left join view_vcc b on a.accy=b.accy and a.noa=b.noa
	left join @tmpb c on a.uno=c.uno
	where c.uno is not null
	
	insert into #z_cub_rkp06_b(uno,datea,tablea,accy,noa,noq,[weight],[money],n)
	select a.uno,b.datea,'get',a.accy,a.noa,a.noq
		,case when ISNULL(a.gweight,0)=0 then ISNULL(a.[weight],0) else a.gweight end
		,round(case when ISNULL(a.gweight,0)=0 then ISNULL(a.[weight],0) else a.gweight end * c.price ,0)
		,-1
	from view_gets a
	left join view_get b on a.accy=b.accy and a.noa=b.noa
	left join @tmpb c on a.uno=c.uno
	where c.uno is not null
	and (b.typea='領料單' or b.typea='報廢'	)
	----------------------------------------------------------------------------------------
	declare @uno nvarchar(30)
	declare @weight float
	declare @money float
	declare @tweight float
	declare @tmoney float
	declare @diff float
	
	declare cursor_table cursor for 
	select uno,weight,money from @tmpb
	open cursor_table 
	fetch next from cursor_table 
	into @uno,@weight,@money
	while(@@FETCH_STATUS <> -1) 
	begin 
		select @tweight = @weight,@tmoney=@money
		--盤點
		select @tweight=@tweight + isnull(SUM([weight]),0) 
			,@tmoney=@tmoney + isnull(SUM([money]),0) 
		from @tmpc where uno=@uno 
		--領料、出退貨
		select @tweight=@tweight + isnull(SUM(n*[weight]),0) 
			,@tmoney=@tmoney + isnull(SUM(n*[money]),0) 
		from #z_cub_rkp06_b where uno=@uno 
		
		if(@tweight=0 and @tmoney!=0) 
		begin
			--最後一筆調整金額
			update #z_cub_rkp06_b set [money]=a.[money]- @tmoney*a.n
			from #z_cub_rkp06_b a
			left join(select top 1 * from #z_cub_rkp06_b where uno=@uno order by datea desc,sel desc) b on a.sel=b.sel 
			where b.noa is not null
		end
		else if(@tweight<0 and @tmoney!=0)
		begin
			print @uno+'有問題'
		end
	
		fetch next from cursor_table 
		into @uno,@weight,@money
	end 
	close cursor_table 
	deallocate cursor_table 

	--更新出貨、領料成本
	declare cursor_table cursor for 
	select accy from #z_cub_rkp06_b group by accy
	open cursor_table 
	fetch next from cursor_table 
	into @accy
	while(@@FETCH_STATUS <> -1) 
	begin 
		set @cmd=
		"update vccs"+@accy+" set scost=b.[money]
		from vccs"+@accy+" a
		left join #z_cub_rkp06_b b on b.tablea='vcc' and b.accy=@accy and a.noa=b.noa and a.noq=b.noq
		where b.noa is not null"
		execute sp_executesql @cmd,N'@accy nvarchar(20)',@accy=@accy
		
		set @cmd=
		"update gets"+@accy+" set scost=b.[money]
		from gets"+@accy+" a
		left join #z_cub_rkp06_b b on b.tablea='vcc' and b.accy=@accy and a.noa=b.noa and a.noq=b.noq
		where b.noa is not null"
		execute sp_executesql @cmd,N'@accy nvarchar(20)',@accy=@accy
		
		fetch next from cursor_table 
		into @accy
	end 
	close cursor_table 
	deallocate cursor_table
	----------------------------------------------------------------------------------------
	if LEN(@t_detail)=0
		delete #z_cub_rkp06 where gno='2'
	
	select gno
		,uno b02
		,recno rr
		,dime a01
		,radius b01
		,width a02
		,lengthb a03
		,pvcno a04
		,makeno a05
		,cust a06
		,weight01 a07
		,weight02 a08
		,weight03 a09
		,weight04 a10
		,rate05 a11
		,case when ISNULL(status01,0)=1 then 'V' else '' end a12
		,case when ISNULL(status02,0)=1 then 'V' else '' end a13
		,case when ISNULL(status03,0)=1 then 'V' else '' end a14
		,case when ISNULL(status04,0)=1 then 'V' else '' end a15
		,case when ISNULL(status05,0)=1 then 'V' else '' end a16
		,w01 a17
		,m01 a18
		,money01 a19
		,money02 a20
		,money03 a21
		,money04 a22
		,money05 a23
		,money06 a24
		,price06 a25
		,money07 a26
		,price07 a27
		,datea a28
	from #z_cub_rkp06 
	order by recno,makeno,gno,pno
	drop table #z_cub_rkp06;
	
z_cub_rkp04:--z_cub_rkp04	在製品彙總表
	SET QUOTED_IDENTIFIER OFF 
	declare @cmd nvarchar(max)
	declare @t_path nvarchar(max) = '[1]'
	declare @t_db nvarchar(max) = '[2]'
	
	declare @t_bdate nvarchar(20) = case when '#non' = [4] then '' else [4] end	
	declare @t_edate nvarchar(20) = case when '#non' = [5] then char(255) else [5] end	
	------------------------------------------------------------------------------------
	declare @tmp table(
		sel int identity(1,1)
		,gno nvarchar(20)
		,pno int
		,recno int
		,makeno nvarchar(30)
		,dime float
		,width float
		,lengthb float
		,radius float
		,pvcno nvarchar(20)
		,pvc nvarchar(30)
		,custno nvarchar(20)
		,cust nvarchar(50)
		,size nvarchar(20)
		,ordeno nvarchar(20)
		,ordeno2 nvarchar(10)
		,mins float
		
		,date_cub nvarchar(20) -- cub date
		,[weight] float
		,price float
		,total float
		
		,date_cut nvarchar(20) -- cut date
		--期初存貨
		,weight01 float
		,price01 float
		,total01 float			
		--盤點調整	
		,weight02 float
		,price02 float
		,total02 float			
		--完工投入	
		,weight03 float
		,price03 float
		,total03 float			
		--耗料	
		,weight04 float
		,price04 float
		,total04 float			
		--樣品	
		,weight05 float
		,price05 float
		,total05 float			
		--報廢	
		,weight06 float
		,price06 float
		,total06 float		
		--領用
		,weight07 float		
		,price07 float
		,total07 float
		--期末存貨	
		,weight10 float
		,price10 float
		,total10 float	
	)
	insert into @tmp(gno,pno,makeno,date_cub,[weight],total
		,dime,width,lengthb,radius,ordeno,ordeno2,custno,cust,size
		,mins)
	select '1',1,a.makeno,b.datea,a.hweight
		--原物料成本+費用
		,isnull(a.total,0) + isnull(a.w01,0)+ isnull(a.w02,0) + isnull(a.w04,0) + isnull(a.w05,0)
		,a.dime,a.width,a.lengthb,a.radius,a.ordeno,a.no2,a.custno,a.comp,a.size
		,a.mins
	from view_cubs a
	left join view_cub b on a.accy=b.accy and a.noa=b.noa
	where b.datea<=@t_edate
	
	update @tmp set pvcno=ISNULL(b.scolor,''),pvc=ISNULL(b.[class],'')
	from @tmp a
	left join view_ordes b on a.ordeno=b.noa and a.ordeno2=b.no2
	update @tmp set price = case when [weight]!=0 then round(total/[weight],3) else 0 end
	update @tmp set date_cut=ISNULL(b.datea,'')
	from @tmp a
	outer apply(select top 1 * from view_cuts where a.makeno=cname order by datea) b
	--前期庫存
	declare @bbdate nvarchar(20) = dbo.AD2ChineseEraName( dateadd(DD,-1,dbo.ChineseEraName2AD(@t_bdate)))
	declare @t_ecustno nvarchar(max) = char(255)
 
	update @tmp set weight01=isnull(b.w23,0)
	from @tmp a
	left join dbo.z_cub_rk02('',@bbdate,'','','',@t_ecustno) b on a.makeno=b.makeno
	
	-- 期末存貨
	update @tmp set weight10=ISNULL(b.w23,0)
	from @tmp a
	left join dbo.z_cub_rk02(@t_bdate,@t_edate,'','','',@t_ecustno) b on a.makeno=b.makeno
	
	--本期盤點調整
	update @tmp set weight02=ISNULL(b.weight11,0)
	from @tmp a
	outer apply(select SUM(isnull(x.weight11,0)) weight11 
		from view_cucs x 
		left join view_cuc y on x.accy=y.accy and x.noa=y.noa 
		where y.noa is not null and x.cubno=a.makeno and y.datea between @t_bdate and @t_edate) b
	
	--本期完工投入
	update @tmp set weight03=[weight],price03=price,total03=total 
		where date_cub>=@t_bdate
		
	--本期樣品、本期報廢
	update @tmp set weight05=ISNULL(b.weight6,0)
		,weight06=ISNULL(b.weight7,0)
	from @tmp a
	outer apply(select SUM(isnull(x.weight6,0)) weight6 
		,SUM(isnull(x.weight7,0)) weight7 
		from view_cucs x 
		left join view_cuc y on x.accy=y.accy and x.noa=y.noa 
		where y.noa is not null and x.cubno=a.makeno and y.datea between @t_bdate and @t_edate) b
	--	本期領用
	declare @makeno nvarchar(max)
	declare @aa nvarchar(max)
	
	declare cursor_table cursor for
	select makeno
	from view_cubs a
	left join view_cub b on a.accy=b.accy and a.noa=b.noa
	where b.datea between @t_bdate and @t_edate
	and LEFT(a.makeno,1)='R'	
	open cursor_table
	fetch next from cursor_table
	into @makeno
	while(@@FETCH_STATUS <> -1)
	begin	
		set @aa = reverse(RIGHT(@makeno,len(@makeno)-1))
		if CHARINDEX('-',@aa)>0
		begin
			set @aa =reverse( RIGHT(@aa,LEN(@aa)-CHARINDEX('-',@aa)))
		end
		
		update @tmp set weight07=ISNULL(a.weight07,0) + isnull(b.weight03,0)
		from @tmp a
		outer apply(select * from @tmp where makeno=@makeno) b
		where a.makeno=@aa
		
		fetch next from cursor_table
		into @makeno
	end
	close cursor_table
	deallocate cursor_table
	
	-- 本期耗料 =  前期庫存 + 盤點調整 + 本期完工投入 - 本期樣品 - 本期報廢 - 本期領用 - 期末存貨
	update @tmp set weight04 = ISNULL(weight01,0) + ISNULL(weight02,0) +ISNULL(weight03,0) - ISNULL(weight05,0) - ISNULL(weight06,0)- ISNULL(weight07,0)- ISNULL(weight10,0)
	------------------------------------------------------------------------------------------
	--declare @makeno nvarchar(20)
	--declare @weight float
	--declare @price float
	--declare @total float
	
	
	-- 只留下  有庫存 及 本期轉為成品的
	
	--delete @tmp where len(date_cut)>0 and date_cut<@t_bdate
	
	--update @tmp set weight01=isnull([weight],0)+ISNULL(bweight02,0)-ISNULL(bweight05,0)-ISNULL(bweight06,0)-ISNULL(bweight07,0)
	--	,price01=price,total01=total 
	--	where date_cub<@t_bdate
		
	
	--======================================
	--完工投入回CUTS抓
	--update @tmp set weight04=b.weight,total=b.total
	--	,price=case when ISNULL(b.weight,0)=0 then round(b.total/b.weight,2) else 0 end
	--from @tmp a
	--outer apply(select SUM(weight) weight,SUM(total) total 
	--	from view_cuts where cname=a.makeno) b
	------================================================
	--update @tmp set weight04=[weight],price04=price,total04=total where date_cut between @t_bdate and @t_edate
	--======================================
	
	

	
	--update @tmp set weight10=ISNULL(weight01,0)
	--	+ISNULL(weight02,0)-ISNULL(weight05,0)-ISNULL(weight06,0)-ISNULL(weight07,0)
	--	+ISNULL(weight03,0)-ISNULL(weight04,0)
	--	,total10=ISNULL(total01,0)+ISNULL(total03,0)-ISNULL(total04,0)
	
	update @tmp set recno=b.recno
	from @tmp a
	left join (select sel,ROW_NUMBER()over(order by makeno) recno from @tmp) b on a.sel=b.sel

	insert into @tmp(gno,pno,weight01,weight02,weight03,weight04,weight05,weight06,weight07,weight10
		,total01,total02,total03,total04,total05,total06,total10
		,mins)
	select '2',2
		,sum(isnull(weight01,0)),sum(isnull(weight02,0)),sum(isnull(weight03,0)),sum(isnull(weight04,0))
		,sum(isnull(weight05,0)),sum(isnull(weight06,0)),sum(isnull(weight07,0)),sum(isnull(weight10,0))
		,sum(isnull(total01,0)),sum(isnull(total02,0)),sum(isnull(total03,0)),sum(isnull(total04,0))
		,sum(isnull(total05,0)),sum(isnull(total06,0)),sum(isnull(total10,0))
		,sum(isnull(mins,0))
	from @tmp	
	
	update @tmp set price01 = case when ISNULL(weight01,0) = 0 then 0 else round(total01/weight01,2) end
		,price02 = case when ISNULL(weight02,0) = 0 then 0 else round(total02/weight02,2) end
		,price03 = case when ISNULL(weight03,0) = 0 then 0 else round(total03/weight03,2) end
		,price04 = case when ISNULL(weight04,0) = 0 then 0 else round(total04/weight04,2) end
		,price05 = case when ISNULL(weight05,0) = 0 then 0 else round(total05/weight05,2) end
		,price06 = case when ISNULL(weight06,0) = 0 then 0 else round(total06/weight06,2) end
		,price10 = case when ISNULL(weight10,0) = 0 then 0 else round(total10/weight10,2) end


--delete test.dbo.z_cub_rkp04
--insert into test.dbo.z_cub_rkp04(makeno,weight)
--select makeno,weight10 
--from @tmp
--where makeno is not null
--order by makeno

--select * from @tmp where makeno='M175A02-1'
--return
--return

	
	select gno
		,@t_bdate + '~' + @t_edate a00
		,recno rr
		,dime a01
		,radius a02
		,width a03
		,lengthb a04
		,pvcno a05
		,makeno a06
		,cust a07
		,size a08
		--期初存貨								

		,dbo.getComma(weight01,-1) a09
		,dbo.getComma(price01,-1) a10
		,dbo.getComma(total01,-1) a11
		--盤點調整			
		,dbo.getComma(weight02,-1) a12
		,'' a13
		,'' a14
		--本期完工投入
		,dbo.getComma(weight03,-1) a15
		,dbo.getComma(price03,-1) a16
		,dbo.getComma(total03,-1) a17			
		--本期耗料
		,dbo.getComma(weight04,-1) a18
		,dbo.getComma(price04,-1) a19
		,dbo.getComma(total04,-1) a20			
		--本期樣品 
		,dbo.getComma(weight05,-1) a21
		,'' a22
		,'' a23
		--本期報廢	
		,dbo.getComma(weight06,-1) a24
		,'' a25
		,'' a26	
		--本期領用
		,dbo.getComma(weight07,-1) a27
		,'' a28
		,'' a29
		--期末存貨
		,dbo.getComma(weight10,-1) a30
		,dbo.getComma(price10,-1) a31
		,dbo.getComma(total10,-1) a32
		,mins t01
	from @tmp order by pno,recno;
	
z_cub_rkp02:--z_cub_rkp02	在製品單位成本表
	SET QUOTED_IDENTIFIER OFF 
	declare @cmd nvarchar(max)
	declare @t_path nvarchar(max) = '[1]'
	declare @t_db nvarchar(max) = '[2]'
	
	declare @t_bdate nvarchar(max) = case when '#non' = [4] then '' else [4] end
	declare @t_edate nvarchar(max) = case when '#non' = [5] then char(255) else [5] end
	--------------------------------------------------------------------------------
	declare @t_bcustno nvarchar(20) = case when '#non' = [6] then '' else [6] end
	declare @t_ecustno nvarchar(20) = case when '#non' = [7] then char(255) else [7] end
	declare @t_makeno nvarchar(max) = case when '#non' = [8] then '' else [8] end
	declare @t_xbdime nvarchar(20) = case when '#non' = [10] then '' else [10] end
	declare @t_xedime nvarchar(20) = case when '#non' = [11] then '' else [11] end
	--------------------------------------------------------------------------------
	--------------------------------------------------------------------------------
	declare @t_bdime float=0,@t_edime float=0
	begin try
		set @t_bdime = CAST(@t_xbdime as float)
		set @t_edime = CAST(@t_xedime as float)
	end try
	begin catch
		--nothing
	end catch
	--------------------------------------------------------------------------------
	declare @tmp table(
		sel int identity(1,1),
		cubno nvarchar(20),
		cubnoq nvarchar(10),
		gno nvarchar(10),
		dime float,
		radius float,
		width float,
		lengthb float,
		makeno nvarchar(20),
		custno nvarchar(20),
		cust nvarchar(50),
		productno nvarchar(20),
		product nvarchar(50),
		pvcno nvarchar(20),--皮膜
		pvc nvarchar(20),
		peno nvarchar(20),--保護膜
		pe nvarchar(20),
		timea float,
		weight01 float,--投入重量
		weight02 float,--完工重量
		money01 float,--半成品金額
		rate01 float,
		money02 float,--直接人工金額
		rate02 float,
		money03 float,--製造費用金額
		rate03 float,
		money04 float,--電費
		rate04 float,
		money05 float,--瓦斯費
		rate05 float,
		money06 float,--合計
		price01 float,--加工成本單價
		price02 float,--在製品單價
		
		memo nvarchar(max)
		,ordeno nvarchar(20)
		,no2 nvarchar(10)
		,mon nvarchar(20)
		,spec nvarchar(20)
		,cspec nvarchar(50)
	)
	insert into @tmp(cubno,cubnoq,gno,dime,radius,width,lengthb
		,makeno,custno,cust,productno,product,timea,weight01,weight02,ordeno,no2
		,money01,money02,money03,money04,money05)
	select a.noa,a.noq, '1',a.dime,a.radius,a.width,a.lengthb
		,a.makeno,a.custno,a.comp,a.productno,a.product
		,a.mins,a.w03,a.hweight,a.ordeno,a.no2
		,ISNULL(a.total,0),ISNULL(a.w01,0),ISNULL(a.w02,0),ISNULL(a.w04,0),ISNULL(a.w05,0)
	from view_cubs a
	left join view_cub b on a.accy=b.accy and a.noa=b.noa
	left join view_uccb c on a.uno=c.uno
	where b.datea between @t_bdate and @t_edate
	and a.custno between @t_bcustno and @t_ecustno
	and (len(@t_makeno)=0 or CHARINDEX(@t_makeno,a.makeno)>0)
	and a.dime between @t_bdime and @t_edime
	
	update @tmp set spec = b.spec,cspec=c.product
	from @tmp a
	left join view_ordes b on a.ordeno=b.noa and a.no2=b.no2
	left join spec c on b.spec=c.noa
	where b.noa is not null
	
	update @tmp set custno=b.custno,cust=b.nick
	from @tmp a
	left join view_orde b on a.ordeno=b.noa
	where len(ISNULL(a.custno,''))=0
	and b.noa is not null
	
	update @tmp set cust=b.nick
	from @tmp a
	left join cust b on a.custno=b.noa
	where len(ISNULL(a.custno,''))>0
	and b.noa is not null
	
	--皮膜、保護膜
	update @tmp set pvcno=ISNULL(b.productno,''),pvc=ISNULL(b.product,'')
	from @tmp a
	outer apply (select top 1 productno,product from view_cubt where noa=a.cubno and nor=a.cubnoq and kind='1' order by noq) b
	update @tmp set peno=ISNULL(b.productno,''),pe=ISNULL(b.product,'')
	from @tmp a
	outer apply (select top 1 productno,product from view_cubt where noa=a.cubno and nor=a.cubnoq and kind='2' order by noq) b
	

	update @tmp set money06=ISNULL(money01,0)+ISNULL(money02,0)+ISNULL(money03,0)+ISNULL(money04,0)+ISNULL(money05,0)
	--小計
	insert into @tmp(gno,timea,makeno,weight01,weight02,money01,money02,money03,money04,money05,money06)
	select '2',sum(isnull(timea,0)),LEFT(makeno,1),sum(isnull(weight01,0)),sum(isnull(weight02,0)),sum(isnull(money01,0))
		,sum(isnull(money02,0)),sum(isnull(money03,0)),sum(isnull(money04,0)),sum(isnull(money05,0)),sum(isnull(money06,0))
	from @tmp
	where gno='1'
	group by LEFT(makeno,1)
	
	--合計
	insert into @tmp(gno,timea,weight01,weight02,money01,money02,money03,money04,money05,money06)
	select '3',sum(isnull(timea,0)),sum(isnull(weight01,0)),sum(isnull(weight02,0)),sum(isnull(money01,0))
		,sum(isnull(money02,0)),sum(isnull(money03,0)),sum(isnull(money04,0)),sum(isnull(money05,0)),sum(isnull(money06,0))
	from @tmp
	where gno='1'
	
	update @tmp set rate01 = case when money06=0 then 0 else ROUND(money01/money06*100,2) end
		,rate02 = case when money06=0 then 0 else ROUND(money02/money06*100,2) end
		,rate03 = case when money06=0 then 0 else ROUND(money03/money06*100,2) end
		,rate04 = case when money06=0 then 0 else ROUND(money04/money06*100,2) end
		,rate05 = case when money06=0 then 0 else ROUND(money05/money06*100,2) end
		,price01 = case when weight02=0 then 0 else ROUND((isnull(money02,0)+isnull(money03,0)+isnull(money04,0)+isnull(money05,0))/weight02,2) end
		,price02 = case when weight02=0 then 0 else ROUND(money06/weight02,2) end
	
	update @tmp set mon=LEFT(c.datea,6)
	from @tmp a
	left join view_cuts b on a.makeno=b.cname
	left join view_cut c on b.accy=c.accy and b.noa=c.noa
	where gno='1'
	
	select gno
		,row_number()over(order by gno,makeno) rr
		,'<a style="font-family:'+ "'Times New Roman','標楷體', serif"+char(59)+'">'+CAST(ROW_NUMBER()over(order by gno,makeno) as nvarchar)+'</a>' rr
		,'<a style="font-family:'+ "'Times New Roman','標楷體', serif"+char(59)+'">'+CAST(dime as nvarchar)+'</a>' a01
		,'<a style="font-family:'+ "'Times New Roman','標楷體', serif"+char(59)+'">'+CAST(radius as nvarchar)+'</a>' a02
		,'<a style="font-family:'+ "'Times New Roman','標楷體', serif"+char(59)+'">'+CAST(width as nvarchar)+'</a>' a03
		,'<a style="font-family:'+ "'Times New Roman','標楷體', serif"+char(59)+'">'+CAST(lengthb as nvarchar)+'</a>' a04
		,'<a style="font-family:'+ "'Times New Roman','標楷體', serif"+char(59)+'">'+makeno+'</a>' a05
		,'<a style="font-family:'+ "'Times New Roman','標楷體', serif"+char(59)+'">'+cust+'</a>' a06
		,'<a style="font-family:'+ "'Times New Roman','標楷體', serif"+char(59)+'">'+pvcno+'</a>' a07
		,'<a style="font-family:'+ "'Times New Roman','標楷體', serif"+char(59)+'">'+isnull(cspec,'')+'</a>' a08
		,'<a style="font-family:'+ "'Times New Roman','標楷體', serif"+char(59)+'">'+peno+'</a>' a09
		,'<a style="font-family:'+ "'Times New Roman','標楷體', serif"+char(59)+'">'+pe+'</a>' a10
		,'<a style="font-family:'+ "'Times New Roman','標楷體', serif"+char(59)+'">'+CAST(timea as nvarchar)+'</a>' a11
		,'<a style="font-family:'+ "'Times New Roman','標楷體', serif"+char(59)+'">'+dbo.getComma(weight01,-1)+'</a>' a12
		,'<a style="font-family:'+ "'Times New Roman','標楷體', serif"+char(59)+'">'+dbo.getComma(weight02,-1)+'</a>' a13
		,'<a style="font-family:'+ "'Times New Roman','標楷體', serif"+char(59)+'">'+dbo.getComma(money01,0)+'</a>' a14
		,'<a style="font-family:'+ "'Times New Roman','標楷體', serif"+char(59)+'">'+dbo.getComma(rate01,-1)+'</a>' a15
		,'<a style="font-family:'+ "'Times New Roman','標楷體', serif"+char(59)+'">'+dbo.getComma(money02,0)+'</a>' a16
		,'<a style="font-family:'+ "'Times New Roman','標楷體', serif"+char(59)+'">'+dbo.getComma(rate02,-1)+'</a>' a17
		,'<a style="font-family:'+ "'Times New Roman','標楷體', serif"+char(59)+'">'+dbo.getComma(money03,0)+'</a>' a18
		,'<a style="font-family:'+ "'Times New Roman','標楷體', serif"+char(59)+'">'+dbo.getComma(rate03,-1)+'</a>' a19
		,'<a style="font-family:'+ "'Times New Roman','標楷體', serif"+char(59)+'">'+dbo.getComma(money04,0)+'</a>' a20
		,'<a style="font-family:'+ "'Times New Roman','標楷體', serif"+char(59)+'">'+dbo.getComma(rate04,-1)+'</a>' a21
		,'<a style="font-family:'+ "'Times New Roman','標楷體', serif"+char(59)+'">'+dbo.getComma(money05,0)+'</a>' a22
		,'<a style="font-family:'+ "'Times New Roman','標楷體', serif"+char(59)+'">'+dbo.getComma(rate05,-1)+'</a>' a23
		,'<a style="font-family:'+ "'Times New Roman','標楷體', serif"+char(59)+'">'+dbo.getComma(money06,0)+'</a>' a24
		,'<a style="font-family:'+ "'Times New Roman','標楷體', serif"+char(59)+'">'+dbo.getComma(price01,-1)+'</a>' a25
		,'<a style="font-family:'+ "'Times New Roman','標楷體', serif"+char(59)+'">'+dbo.getComma(price02,-1)+'</a>' a26
		,'<a style="font-family:'+ "'Times New Roman','標楷體', serif"+char(59)+'">'+mon+'</a>' a27
	from @tmp
	order by gno,makeno;
	
z_cub_rkp09:--z_cub_rkp09	批量管制卡
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_path nvarchar(max) = '[1]'
	declare @t_db nvarchar(max) = '[2]'
	declare @t_bdate nvarchar(20) = case when '#non' = [4] then '' else [4] end
	declare @t_edate nvarchar(20) = case when '#non' = [5] then char(255) else [5] end
	declare @t_makeno nvarchar(max) = case when '#non' = [8] then '' else [8] end
	declare @t_uno nvarchar(max) = case when '#non' = [9] then '' else [9] end
	------------------------------------------------------------------------------------
	declare @tmpa table(
		sel int identity(1,1)
		,makeno nvarchar(30)		
	)
	insert into @tmpa(makeno)
	select a.makeno
	from view_cubs a
	left join view_cub b on a.accy=b.accy and a.noa=b.noa
	where ISNULL(b.datea,'') between @t_bdate and @t_edate
	and (len(@t_makeno)=0 or @t_makeno=a.makeno)
	and (len(@t_uno)=0 or exists(select * from view_cuts where bno=@t_uno and cname=a.makeno))
	---------------------------------------------------------------------------
	declare @tmpb table(
		sel int identity(1,1)
		,gno nvarchar(10)
		,makeno nvarchar(30)
		,pno int
		,typea nvarchar(30)
		,datea nvarchar(20)
		,accy nvarchar(10)
		,noa nvarchar(20)
		,noq nvarchar(10)
		,size nvarchar(max)
		
		,mount float
		,[weight] float
		,[money] float
		,memo nvarchar(max)

		--良品
		,mount1 float--數量	
		,length1 float--米數	
		,weight1 float--重量
		
		--不良品
		,mount2 float--數量	
		,weight2 float--重量
		
		--餘料	
		,weight3 float
		--廢料
		,weight4 float
		--工時
		,mins float
		--客戶
		,custno nvarchar(20)
		,cust nvarchar(max)
		--合約NO         生產日報表
		,contractno nvarchar(30)
		--規格尺寸
		,asize nvarchar(max)
		--保謢膜         生產日報表
		,pveno nvarchar(20)
		,pve nvarchar(50)
		--背漆           生產日報表
		,item1 nvarchar(50)
		--製造批號
		--makeno 
		--鋼捲材質       生產日報表
		,spec nvarchar(50)
		--原鋼捲規格
		,bsize nvarchar(max)
		--鋼捲批號
		,uno nvarchar(30)
		--原鋼捲母號
		,uno2 nvarchar(30)
		--投入重量       生產日報表
		,w01 float
		--完工重量       進倉單
		,w02 float
		--總損耗        (投入重量-完工重量)/投入重量 請以%表達	
		,rate01 float
	)
	declare @makeno nvarchar(20)
	
	declare cursor_table cursor for
	select makeno from @tmpa	
	open cursor_table
	fetch next from cursor_table
	into @makeno
	while(@@FETCH_STATUS <> -1)
	begin	
		--CUB
		insert into @tmpb(makeno,pno,typea,datea,accy,noa,noq,size,memo
			,mount1,length1,weight1
			,mount2,weight2
			,weight3
			,weight4
			,mins)
		select a.makeno,1,'生產',b.datea,a.accy,a.noa,a.noq
		--生產："LENGTHB"固定以" C"表達
			,CAST(a.dime as nvarchar)+'+'+CAST(a.radius as nvarchar)
				+'*'+CAST(a.width as nvarchar)+'*C'
			,a.memo
			,0 mount1
			,ISNULL(a.w09,0) length1
			,isnull(a.hweight,0) weight1
			,0 mount2
			,0 weight2
			,0 weight3
			,ISNULL(a.price,0) weight04
			,ISNULL(a.mins,0) mins
		from view_cubs a
		left join view_cub b on a.accy=b.accy and a.noa=b.noa
		where a.makeno=@makeno
		--CUC
		insert into @tmpb(makeno,pno,typea,datea,accy,noa,noq,size,memo
			,mount1,length1,weight1
			,mount2,weight2
			,weight3
			,weight4
			,mins)
		select a.cubno,2,b.typea,b.datea,a.accy,a.noa,a.noq
			--分條：最後請固定加上"C"
			,a.size2+'*'+CAST(a.width as nvarchar)+'*'+CAST(a.lengthb as nvarchar) + case when CHARINDEX('分條',b.typea)>0 then 'C' else '' end
			,a.memo
			,case when CHARINDEX('分條',b.typea)>0 then a.mount2 when CHARINDEX('裁切',b.typea)>0 then a.mount3 else 0 end
			,case when CHARINDEX('分條',b.typea)>0 then 0 when CHARINDEX('裁切',b.typea)>0 then 0 else 0 end
			,case when CHARINDEX('分條',b.typea)>0 then a.weight2 when CHARINDEX('裁切',b.typea)>0 then a.weight3 else 0 end
			,0 mount2
			,ISNULL(a.weight8,0)+ISNULL(a.weight9,0)+ISNULL(a.weight10,0) weight2
			,ISNULL(a.weight4,0) weight3
			,ISNULL(a.waste,0) weight4
			,isnull(a.mins,0) mins
		from view_cucs a
		left join view_cuc b on a.accy=b.accy and a.noa=b.noa
		where a.cubno = @makeno
		--CUT
		insert into @tmpb(makeno,pno,typea,datea,accy,noa,noq,size,memo
			,mount1,length1,weight1
			,mount2,weight2
			,weight3
			,weight4
			,mins)
		select a.cname,3,'進倉',b.datea,a.accy,a.noa,a.noq
			,CAST(a.dime as nvarchar)+'+'+CAST(a.radius as nvarchar)
				+'*'+CAST(a.width as nvarchar)+'*'+CAST(a.lengthb as nvarchar)
			,a.memo
			,ISNULL(a.mount,0) mount1
			,0 length1
			,ISNULL(a.[weight],0) weight1
			,0 mount2,0 weight2
			,0 weight3,0 weight4,0 mins 
		from view_cuts a
		left join view_cut b on a.accy=b.accy and a.noa=b.noa
		where a.cname = @makeno
		
		fetch next from cursor_table
		into @makeno
	end
	close cursor_table
	deallocate cursor_table
	
	update @tmpb set gno='1'
	
	insert into @tmpb(gno,makeno,typea,mount1,weight1,mount2,weight2,weight3,weight4,mins)
	select '2',makeno,typea,SUM(ISNULL(mount1,0)),SUM(ISNULL(weight1,0)),SUM(ISNULL(mount2,0)),SUM(ISNULL(weight2,0))
		,SUM(ISNULL(weight3,0)),SUM(ISNULL(weight4,0)),SUM(ISNULL(mins,0))
	from @tmpb
	where typea='進倉'
	group by makeno,typea
	
	
	update @tmpb set custno=b.custno,cust=b.comp,contractno=''
		,asize=CAST(b.dime as nvarchar)+'+'+CAST(b.radius as nvarchar)+'*'+CAST(b.width as nvarchar)+'*'+CAST(b.lengthb as nvarchar)
		,pveno=c.productno,pve=c.product,item1=d.product
		,spec=b.size
		,bsize=CAST(b.dime as nvarchar)+'*'+CAST(b.width as nvarchar)
		,uno=b.uno,uno2=e.uno2
		,w01=b.hweight,w02=f.[weight]
		,rate01= case when ISNULL(b.hweight,0)=0 then 0 else  round((ISNULL(b.hweight,0)-ISNULL(f.[weight],0))*100/ISNULL(b.hweight,0),2) end
	from @tmpb a
	left join view_cubs b on a.makeno=b.makeno
	outer apply(select top 1 * from view_cubt where accy=b.accy and noa=b.noa and nor=b.noq and kind='2') c
	outer apply(select top 1 * from view_cubu where accy=b.accy and noa=b.noa) d
	left join view_uccb e on b.uno=e.uno
	outer apply(select SUM(ISNULL([weight],0)) [weight] from view_cuts where cname=a.makeno) f
	
	select gno
		, cust a01
		, pveno+' '+pve a02
		, makeno a03
		, bsize a04
		, dbo.getComma(w01,0) a05
		, contractno a06
		, item1 a07
		, spec a08
		, uno a09
		, dbo.getComma(w02,0) a10
		, asize a11
		, uno2 a12
		, cast(rate01 as nvarchar)+' %' a13
		
		,datea b01
		,typea b02
		,noa b03
		,size b04
		,mount1 b05
		,length1 b06
		,weight1 b07
		,mount2 b08
		,weight2 b09
		,weight3 b10
		,weight4 b11
		,mins b12
		,memo b13
	from @tmpb 
	order by makeno,gno,pno;

z_cub_rkp07:--z_cub_rkp07 包裝費用明細表
	SET QUOTED_IDENTIFIER OFF 
	declare @cmd nvarchar(max)
	declare @t_path nvarchar(max) = '[1]'
	declare @t_db nvarchar(max) = '[2]'

	declare @t_bdate nvarchar(20) = case when '#non' = [4] then '' else [4] end
	declare @t_edate nvarchar(20) = case when '#non' = [5] then char(255) else [5] end
	declare @t_bcustno nvarchar(20) =case when '#non' = [6] then '' else [6] end
	declare @t_ecustno nvarchar(20) = case when '#non' = [7] then char(255) else [7] end
	------------------------------------------------------------------------------------------
	declare @tmp table(
		sel int identity(1,1)
		,gno nvarchar(10)
		,datea nvarchar(10)
		,vccno nvarchar(20)
		,ordeno nvarchar(20)
		,stype nvarchar(20)
		,custtype nvarchar(max)
		,ccusttype nvarchar(max)
		,custno nvarchar(20)
		,cust nvarchar(max)
		,nick nvarchar(max)
		,[weight] float
		,m01 float	--包裝
		,m02 float	--海運費	
		,m03 float	--拖櫃費	
		,m04 float	--報關費	
		,m05 float	--保險費	
		,m06 float	--商建費/推廣費	
		,m07 float	--貨運費
		,m08 float	--裝櫃
		,total float
		,rate float
	)
	insert into @tmp(gno,datea,vccno,custno,[weight],m01,m07)
	select '1',a.datea,a.noa,a.custno
		,case when a.typea='1' then 1 else -1 end * a.[weight]
		,a.cartrips,a.tranmoney
	from view_vcc a
	where isnull(a.datea,'') between @t_bdate and @t_edate
	--and ISNULL(a.typea,'')='1'
	and ISNULL(a.custno,'') between @t_bcustno and @t_ecustno
	
	declare @ordeno nvarchar(20)
	declare @stype nvarchar(20)
	declare @vccno nvarchar(20)
	declare @chgitem nvarchar(50)
	declare @total float
	
	declare @custtype nvarchar(20)
	declare @ccusttype nvarchar(20)
	
	declare cursor_table cursor for
	select a.vccno from @tmp a
	open cursor_table
	fetch next from cursor_table
	into @vccno
	while(@@FETCH_STATUS <> -1)
	begin
	
		select @ordeno='',@stype='',@custtype='',@ccusttype=''
		
		select top 1 @ordeno=a.ordeno
			,@stype=case b.stype when '1' then '內銷' when '3' then '外銷' else b.stype end
			,@custtype=c.custpro
			,@ccusttype=d.product
		from view_vccs a
		left join view_orde b on a.ordeno=b.noa
		outer apply(select top 1 * from view_ordes where noa=a.ordeno and no2=a.no2) c
		left join adpro d on c.custpro=d.noa
		where a.noa=@vccno and len(ISNULL(a.ordeno,''))>0
		order by a.noq
		update @tmp set ordeno=@ordeno,stype=@stype,custtype=@custtype,ccusttype=@ccusttype where vccno=@vccno
	
		fetch next from cursor_table
		into @vccno
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select a.vccno,b.chgitem,isnull(b.total,0)
	from @tmp a
	left join paybs b on a.vccno=b.payno
	where b.noa is not null
	open cursor_table
	fetch next from cursor_table
	into @vccno,@chgitem,@total
	while(@@FETCH_STATUS <> -1)
	begin
		if CHARINDEX('包裝',@chgitem)>0
		begin
			update @tmp set m01=ISNULL(m01,0)+@total where vccno=@vccno
		end
		else if CHARINDEX('海運費',@chgitem)>0
		begin
			update @tmp set m02=ISNULL(m02,0)+@total where vccno=@vccno
		end
		else if CHARINDEX('拖櫃費',@chgitem)>0
		begin
			update @tmp set m03=ISNULL(m03,0)+@total where vccno=@vccno
		end
		else if CHARINDEX('報關費',@chgitem)>0
		begin
			update @tmp set m04=ISNULL(m04,0)+@total where vccno=@vccno
		end
		else if CHARINDEX('保險費',@chgitem)>0
		begin
			update @tmp set m05=ISNULL(m05,0)+@total where vccno=@vccno
		end
		else if CHARINDEX('商建費',@chgitem)>0 or CHARINDEX('推廣費',@chgitem)>0
		begin
			update @tmp set m06=ISNULL(m06,0)+@total where vccno=@vccno
		end
		else if CHARINDEX('貨運費',@chgitem)>0
		begin
			update @tmp set m07=ISNULL(m07,0)+@total where vccno=@vccno
		end
		else if CHARINDEX('裝櫃',@chgitem)>0
		begin
			update @tmp set m08=ISNULL(m08,0)+@total where vccno=@vccno
		end
		
		fetch next from cursor_table
		into @vccno,@chgitem,@total
	end
	close cursor_table
	deallocate cursor_table
	
	----------------------------------------------------------------------------------------
	update @tmp set cust=b.comp,nick=b.nick
		--,custtype=b.typea,ccusttype=c.namea
	from @tmp a
	left join cust b on a.custno=b.noa
--	left join custtype c on b.typea=c.noa
	----------------------------------------------------------------------------------------
	insert into @tmp(gno,[weight],m01,m02,m03,m04,m05,m06,m07,m08)
	select '2',SUM(ISNULL([weight],0))
		,SUM(ISNULL(m01,0)),SUM(ISNULL(m02,0)),SUM(ISNULL(m03,0)),SUM(ISNULL(m04,0))
		,SUM(ISNULL(m05,0)),SUM(ISNULL(m06,0)),SUM(ISNULL(m07,0)),SUM(ISNULL(m08,0))
	from @tmp
	
	
	update @tmp set total=ISNULL(m01,0)+ISNULL(m02,0)+ISNULL(m03,0)+ISNULL(m04,0)
		+ISNULL(m05,0)+ISNULL(m06,0)+ISNULL(m07,0)+ISNULL(m08,0)
	update @tmp set rate = case when ISNULL([weight],0)=0 then 0 else ROUND(total/[weight]*100,2) end

	select gno
		,ROW_NUMBER()over(order by gno,datea,vccno) rr
		,vccno a01
		,datea a02
		,nick a03
		,ccusttype a04
		,dbo.getComma([weight],-1) a05
		,dbo.getComma(m01,-1) a06
		,dbo.getComma(m08,-1) a07
		,dbo.getComma(m02,-1) a08
		,dbo.getComma(m03,-1) a09
		,dbo.getComma(m04,-1) a10
		,dbo.getComma(m05,-1) a11
		,dbo.getComma(m06,-1) a12
		,dbo.getComma(m07,-1) a13
		,dbo.getComma(total,-1) a14	
		,dbo.getComma(rate,-1) a15
		,stype a16
	from @tmp
	order by gno,datea,vccno;
	
z_cub_rkp05:--z_cub_rkp05 分批成本表	
	SET QUOTED_IDENTIFIER OFF 
	declare @cmd nvarchar(max)
	declare @t_path nvarchar(max) = '[1]'
	declare @t_db nvarchar(max) = '[2]'
	
	declare @t_bdate nvarchar(max) = case when '#non' = [4] then '' else [4] end
	declare @t_edate nvarchar(max) = case when '#non' = [5] then char(255) else [5] end
	--------------------------------------------------------------------------------
	declare @tmp table(
		sel int identity(1,1)
		,gno nvarchar(10)
		,pno int
		,recno int
		,accy nvarchar(10)
		,noa nvarchar(20)
		,noq nvarchar(10)
		,makeno nvarchar(20),
		custno nvarchar(20),
		cust nvarchar(50),
		dime float,
		radius float,
		width float,
		lengthb float,
		pvc nvarchar(20),
		--coil
		uno01 nvarchar(30),
		weight01 float,
		price01 float,
		money01 float,
		--pvc
		uno02 nvarchar(30),
		mount02 float,
		weight02 float,
		price02 float,
		money02 float,
		--pe 1
		uno03 nvarchar(30),
		productno03 nvarchar(20),
		dime03 float,
		width03 float,
		lengthb03 float,
		mount03 float,
		weight03 float,
		price03 float,
		money03 float,

		--A01 接著劑	
		weight04 float,
		price04 float,
		money04 float,
		--A02 接著劑稀釋劑
		weight05 float,
		price05 float,
		money05 float,	
		--A03 背漆
		weight06 float,
		price06 float,
		money06 float,
		--A04 背漆稀釋液
		weight07 float,
		price07 float,
		money07 float,	
		--A05 面漆
		weight08 float,
		price08 float,
		money08 float,
		
		weight10 float,--投入重量
		money10 float,--半成品金額
		weight11 float,--完工重量
		
		--半成品
		money11a float,--直接人工
		money12a float,--製造費用
		--成品
		money11b float,--直接人工
		money12b float,--製造費用
		
		weight12 float,--成品重量
		money13 float,--總計
		price10 float,--單位成本
		rate01 float,--損耗率
		mon nvarchar(10),--完工月份
		
		memo nvarchar(max)
	)
	--鋼捲
	insert into @tmp(gno,pno,accy,noa,noq,makeno,custno,cust,dime,radius,width,lengthb
		,uno01,weight01,money01)
	select '1',1,a.accy,a.noa,a.noq,a.makeno,a.custno,a.comp,a.dime,a.radius,a.width,a.lengthb
		,a.uno,a.x01,a.y01
	from view_cubs a
	left join view_cub b on a.noa=b.noa
	where b.datea between @t_bdate and @t_edate
	--皮膜
	update @tmp set mount02=c.[weight],weight02=b.x02,money02=b.y02
		,pvc=c.productno
	from @tmp a
	left join view_cubs b on a.accy=b.accy and a.noa=b.noa and a.noq=b.noq
	outer apply(select top 1 * from view_cubt where a.accy=accy and a.noa=noa and a.noq=nor and kind = '1' order by noq) c
	where b.noa is not null 
	--保護膜
	declare @accy nvarchar(10)
	declare @noa nvarchar(20)
	declare @noq nvarchar(10)
	declare @uno nvarchar(30)
	declare @productno nvarchar(20)
	declare @mount float
	declare @weight float
	declare @money float
	declare @n int 
	declare @sel int

	declare cursor_table cursor for
	select accy,noa,noq from @tmp group by accy,noa,noq
	open cursor_table
	fetch next from cursor_table
	into @accy,@noa,@noq
	while(@@FETCH_STATUS <> -1)
	begin
		declare cursor_table2 cursor for
		select a.uno,a.productno,a.[weight],a.[wweight],a.scost
		from view_cubt a
		where a.accy=@accy and a.noa=@noa and a.nor=@noq and kind='2'
		open cursor_table2
		fetch next from cursor_table2
		into @uno,@productno,@mount,@weight,@money
		while(@@FETCH_STATUS <> -1)
		begin
			set @sel = 0
			select @sel = sel from @tmp where accy=@accy and noa=@noa and noq=@noq and len(isnull(uno03,''))=0
			if @sel>0
			begin
				update @tmp set uno03=@uno,productno03=@productno,mount03=@mount,weight03=@weight,money03=@money
					,dime03=b.dime,width03=b.width,lengthb03=b.lengthb
				from @tmp a
				left join view_uccb b on b.uno=@uno
				where a.sel=@sel
			end
			else
			begin
				insert into @tmp(gno,pno,accy,noa,noq,makeno,uno03,productno03,mount03,weight03,money03,dime03,width03,lengthb03)
				select '2',2,@accy,@noa,@noq,c.makeno,@uno,@productno,@mount,@weight,@money,b.dime,b.width,b.lengthb
				from @tmp a
				left join view_uccb b on b.uno=@uno
				left join view_cubs c on a.accy=c.accy and a.noa=c.noa and a.noq=c.noq
				where a.accy=@accy and a.noa=@noa and a.noq=@noq and gno='1'
			end
	
			fetch next from cursor_table2
			into @uno,@productno,@mount,@weight,@money
		end
		close cursor_table2
		deallocate cursor_table2

		fetch next from cursor_table
		into @accy,@noa,@noq
	end
	close cursor_table
	deallocate cursor_table
	
	update @tmp set 
		weight04=b.x04,money04=b.y04  --A01 接著劑
		,weight05=b.x05,money05=b.y05 --A02 接著劑稀釋劑
		,weight06=b.x06,money06=b.y06 --A03 背漆
		,weight07=b.x07,money07=b.y07 --A04 背漆稀釋液
		,weight08=b.x08,money08=b.y08 --A05 面漆
		,weight10=b.w03               --投入重量
		,money10=b.total              --半成品金額
		,weight11=b.hweight           --完工重量
		,money11a=b.w01               --直接人工
		,money12a=b.w02               --製造費用
	from @tmp a
	left join view_cubs b on a.accy=b.accy and a.noa=b.noa and a.noq=b.noq and pno=1
	where b.noa is not null
	
	update @tmp set 
		money11b = 0   --成品 直接人工
		,money12b = 0  --成品 製造費用
		,weight12 =b.[weight]  --成品重量
		,money13 = ISNULL(money10,0) + ISNULL(money11a,0)+ ISNULL(money12a,0) --總計
	from @tmp a
	left join (select cname,SUM(ISNULL([weight],0)) [weight] from view_cuts group by cname) b on a.makeno=b.cname
	where a.pno=1
	
	update @tmp set price10=case when weight12=0 then 0 else round(money13/weight12,2) end
		,rate01 = case when weight10=0 then 0 else round((isnull(weight10,0)-isnull(weight12,0))/weight10*100,2) end
	
	update @tmp set mon=LEFT(c.datea,6)
	from @tmp a
	left join view_cuts b on a.makeno=b.cname
	left join view_cut c on b.accy=c.accy and b.noa=c.noa
	where pno=1
	
	update @tmp set mon=b.mon
	from @tmp a
	outer apply(select * from @tmp where a.accy=accy and a.noa=noa and a.noq=noq and pno=1) b
	where a.pno=2
	
	delete @tmp where not isnull(mon,'') between left(@t_bdate,6) and left(@t_edate,6)
	
	update @tmp set recno=b.recno
	from @tmp a
	left join (select sel,ROW_NUMBER()over(order by makeno,accy,noa,noq) recno from @tmp where pno=1) b on a.sel=b.sel
	where b.sel is not null
	
	insert into @tmp(gno,pno,makeno,weight01,money01,mount02,weight02,money02
		,mount03,weight03,money03,weight04,money04,weight05,money05,weight06,money06
		,weight07,money07,weight08,money08,weight10,money10,weight11,money11a,money12a,money11b,money12b
		,weight12,money13)
	select '3',3,CHAR(255),sum(isnull(weight01,0)),sum(isnull(money01,0)),sum(isnull(mount02,0))
		,sum(isnull(weight02,0)),sum(isnull(money02,0))
		,sum(isnull(mount03,0)),sum(isnull(weight03,0)),sum(isnull(money03,0)),sum(isnull(weight04,0)),sum(isnull(money04,0))
		,sum(isnull(weight05,0)),sum(isnull(money05,0)),sum(isnull(weight06,0)),sum(isnull(money06,0))
		,sum(isnull(weight07,0)),sum(isnull(money07,0)),sum(isnull(weight08,0)),sum(isnull(money08,0))
		,sum(isnull(weight10,0)),sum(isnull(money10,0)),sum(isnull(weight11,0)),sum(isnull(money11a,0)),sum(isnull(money12a,0))
		,sum(isnull(money11b,0)),sum(isnull(money12b,0)),sum(isnull(weight12,0)),sum(isnull(money13,0))
	from @tmp

	update @tmp set 
		 price01 = case when ISNULL(weight01,0) = 0 then 0 else round(money01/weight01,2) end
		,price02 = case when ISNULL(weight02,0) = 0 then 0 else round(money02/weight02,2) end
		,price03 = case when ISNULL(weight03,0) = 0 then 0 else round(money03/weight03,2) end
		,price04 = case when ISNULL(weight04,0) = 0 then 0 else round(money04/weight04,2) end
		,price05 = case when ISNULL(weight05,0) = 0 then 0 else round(money05/weight05,2) end
		,price06 = case when ISNULL(weight06,0) = 0 then 0 else round(money06/weight06,2) end
		,price07 = case when ISNULL(weight07,0) = 0 then 0 else round(money07/weight07,2) end
		,price08 = case when ISNULL(weight08,0) = 0 then 0 else round(money08/weight08,2) end
		,price10 = case when ISNULL(weight12,0) = 0 then 0 else round(money13/weight12,2) end
		
	select gno
		,recno rr
		,makeno a01
		,cust a02
		,case when isnull(dime,0)=0 then '' else dime end a03
		,case when isnull(radius,0)=0 then '' else radius end a04
		,case when isnull(width,0)=0 then '' else width end a05
		,case when isnull(lengthb,0)=0 then '' else lengthb end a06
		,pvc a07
		,dbo.getComma(weight01,-1) a08
		,price01 a09
		,dbo.getComma(money01,-1) a10
		,dbo.getComma(mount02,-1) a11
		,dbo.getComma(weight02,-1) a12
		,price02 a13
		,dbo.getComma(money02,-1) a14
		,productno03 a15
		,dime03 a16
		,width03 a17
		,lengthb03 a18
		,dbo.getComma(mount03,-1) a19
		,dbo.getComma(weight03,-1) a20
		,price03 a21
		,dbo.getComma(money03,-1) a22
		
		,dbo.getComma(weight04,-1) a23
		,price04 a24
		,dbo.getComma(money04,-1) a25
		,dbo.getComma(weight05,-1) a26
		,price05 a27
		,dbo.getComma(money05,-1) a28
		,dbo.getComma(weight06,-1) a29
		,price06 a30
		,dbo.getComma(money06,-1) a31
		,dbo.getComma(weight07,-1) a32
		,price07 a33
		,dbo.getComma(money07,-1) a34
		,dbo.getComma(weight08,-1) a35
		,price08 a36
		,dbo.getComma(money08,-1) a37
		,dbo.getComma(weight10,-1) a38        --投入重量
		,dbo.getComma(money10,-1) a39         --半成品金額
		,dbo.getComma(weight11,-1) a40        --完工重量
		
		,dbo.getComma(money11a,-1) a41        --半成品 直接人工
		,dbo.getComma(money12a,-1) a42        --半成品 製造費用
		,dbo.getComma(money11b,-1) a43        --成品 直接人工
		,dbo.getComma(money12b,-1) a44        --成品 製造費用
		,dbo.getComma(weight12,-1) a45        --成品重量
		,dbo.getComma(money13,-1) a46         --總計
		,price10 a47                          --單位成本
		,rate01 a48                           --損耗率
		,mon a49                              --完工月份
	from @tmp
	order by makeno,accy,noa,noq,pno;

z_cub_rkp03: -- z_cub_rkp03  成本結轉
	---  要先計算  人工費用、製造費用、電費、瓦斯費
	SET QUOTED_IDENTIFIER OFF 
	declare @cmd nvarchar(max)
	declare @t_path nvarchar(max) = '[1]'
	declare @t_db nvarchar(max) = '[2]'
	
	declare @bdate nvarchar(10) = case when '#non'=[4] then '' else [4] end
	declare @edate nvarchar(10) = case when '#non'=[5] then char(255) else [5] end
	declare @uno nvarchar(30) = ''
	-------------------------------------------------------------------------------------
	-- 計算sprice
	-- 當進貨退回時,成本單價將會變動
	declare @tmp_01 table(
		uno nvarchar(30)
	)
	--先列出會異動到的批號
	insert into @tmp_01(uno)
	select a.uno
	from view_rc2s a
	left join view_rc2 b on a.accy=b.accy and a.noa=b.noa
	where len(isnull(a.uno,''))>0
	and b.datea between @bdate and @edate
	group by a.uno
	---
	declare @tmp_02 table(
		uno nvarchar(30)
		,datea nvarchar(20)
		,[weight] float
		,[total] float
	)
	insert into @tmp_02(uno,datea,[weight],total)
	select a.uno,c.datea
		,sum(case when c.typea='1' then 1 else -1 end * isnull(b.[weight],0))
		,sum(case when c.typea='1' then 1 else -1 end * isnull(b.[total],0))
	from @tmp_01 a
	left join view_rc2s b on a.uno=b.uno
	left join view_rc2 c on b.accy=c.accy and b.noa=c.noa
	group by a.uno,c.datea
	---
	declare @tmp_03 table(
		uno nvarchar(30)
		,datea nvarchar(20)
		,price float
	)
	declare @xuno nvarchar(30)
	declare @xdate nvarchar(20)
	declare @xweight float
	declare @xtotal float
	
	declare @zweight float
	declare @ztotal float
	
	declare cursor_table cursor for 
	select uno from @tmp_01 order by uno
	open cursor_table 
	fetch next from cursor_table 
	into @xuno
	while(@@FETCH_STATUS <> -1) 
	begin 
		select @zweight = 0, @ztotal = 0
		
		declare cursor_table2 cursor for 
		select datea,[weight],total from @tmp_02 where uno=@xuno order by datea
		open cursor_table2 
		fetch next from cursor_table2 
		into @xdate,@xweight,@xtotal
		while(@@FETCH_STATUS <> -1) 
		begin 
			set @zweight = @zweight + @xweight
			set @ztotal = @ztotal + @xtotal 
			
			insert into @tmp_03(uno,datea,price)
			select @xuno,@xdate,case when isnull(@zweight,0) !=0 then round(@ztotal/@zweight,5) else 0 end
		
			fetch next from cursor_table2 
			into @xdate,@xweight,@xtotal
		end 
		close cursor_table2 
		deallocate cursor_table2
		
	
		fetch next from cursor_table 
		into @xuno
	end 
	close cursor_table 
	deallocate cursor_table 
	
	--- 寫入SPRICE
	delete sprice 
	from sprice a
	left join @tmp_01 b on a.uno=b.uno
	where b.uno is not null
	
	insert into sprice(datea,sprice,uno,tablea)
	select datea,price,uno,'rc2s'
	from @tmp_03

	----===================================================================================
	declare @tmp table(
		gno nvarchar(10)
		,uno nvarchar(30)
		,msg nvarchar(max)
	)
	
	-- 找到要計算的單據
	------- VCCS
	declare @tmpa table(uno nvarchar(30))
	insert into @tmpa(uno)
	select a.uno
	from view_vccs a
	left join view_vcc b on a.accy=b.accy and a.noa=b.noa
	left join view_uccb c on a.uno=c.uno
	where len(isnull(a.uno,''))>0
	and case when isnull(gweight,0)!=0 then gweight else isnull(a.[weight],0) end != 0 
	and b.datea between @bdate and @edate
	and (len(@uno)=0 or a.uno=@uno)
	and (c.kind='A1' or c.kind='A4' or c.kind='A5' or c.kind='A8')
	------- GETS
	insert into @tmpa(uno)
	select a.uno
	from view_gets a
	left join view_get b on a.accy=b.accy and a.noa=b.noa
	left join view_uccb c on a.uno=c.uno
	where len(isnull(a.uno,''))>0
	and case when isnull(gweight,0)!=0 then gweight else isnull(a.[weight],0) end != 0 
	and b.datea between @bdate and @edate
	and (len(@uno)=0 or a.uno=@uno)
	and (c.kind='A1' or c.kind='A4' or c.kind='A5' or c.kind='A8')
	------- CUBT
	insert into @tmpa(uno)
	select a.uno
	from view_cubt a
	left join view_cub b on a.accy=b.accy and a.noa=b.noa
	left join view_uccb c on a.uno=c.uno
	where len(isnull(a.uno,''))>0
	and isnull(a.[weight],0) != 0 
	and b.datea between @bdate and @edate
	and (len(@uno)=0 or a.uno=@uno)
	and (c.kind='A1' or c.kind='A4' or c.kind='A5' or c.kind='A8')
	------- CUTS(暫時用不到)
	----===================================================================================
	-- 列出所要計算的批號
	declare @tmpUno table(
		sel int identity(1,1)
		,uno nvarchar(30)
	)
	insert into @tmpUno(uno)
	select uno from @tmpa group by uno
	---------------------------------------------------------------------
	IF OBJECT_ID('tempdb..#z_cub_rkp03')is not null
	BEGIN
		drop table #z_cub_rkp03
	END
	create table #z_cub_rkp03(
		sel int identity(1,1)
		,recno int
		,datea nvarchar(20)
		,tablea nvarchar(20)
		,accy nvarchar(10)
		,noa nvarchar(20)
		,noq nvarchar(10)
		,uno nvarchar(30)
		,typea nvarchar(10)
		,[weight] float
		,scost float
		
		,isUcce int -- 盤點
		,isIna int -- 判斷是否是領料組合後的東西,如果是就要等INAS的金額寫入後才能算出來成本
	)
	--- VCCS
	insert into #z_cub_rkp03(datea,tablea,accy,noa,noq,typea,uno,[weight])
	select b.datea,'vccs',a.accy,a.noa,a.noq,b.typea,a.uno
		,case when ISNULL(a.gweight,0)!=0 then a.gweight else a.[weight] end
	from view_vccs a
	left join view_vcc b on a.accy=b.accy and a.noa=b.noa
	left join @tmpUno c on a.uno=c.uno
	where c.sel is not null
	and case when ISNULL(a.gweight,0)!=0 then a.gweight else ISNULL(a.[weight],0) end!=0
	
	--- GETS
	insert into #z_cub_rkp03(datea,tablea,accy,noa,noq,uno,[weight],isucce,scost)
	select b.datea,'gets',a.accy,a.noa,a.noq,a.uno,case when ISNULL(a.gweight,0)!=0 then a.gweight else a.[weight] end
		,case when charindex('盤點',b.typea)>0 then 1 else 0 end
		,case when charindex('盤點',b.typea)>0 then a.scost else 0 end
	from view_gets a
	left join view_get b on a.accy=b.accy and a.noa=b.noa
	left join @tmpUno c on a.uno=c.uno
	where c.sel is not null
	and case when ISNULL(a.gweight,0)!=0 then a.gweight else ISNULL(a.[weight],0) end!=0
	
	--- CUBT
	insert into #z_cub_rkp03(datea,tablea,accy,noa,noq,uno,[weight])
	select b.datea,'cubt',a.accy,a.noa,a.noq,a.uno,a.[weight]
	from view_cubt a
	left join view_cub b on a.accy=b.accy and a.noa=b.noa
	left join @tmpUno c on a.uno=c.uno
	where c.sel is not null
	and ISNULL(a.[weight],0)!=0
	
	--- CHECK
	update #z_cub_rkp03 set isIna = case when b.noa is null then 0 else 1 end
	from #z_cub_rkp03 a
	left join view_get b on a.uno=b.idno and len(ISNULL(b.idno,''))>0 
	
	update #z_cub_rkp03 set recno=b.recno
	from #z_cub_rkp03 a
	left join(select sel,ROW_NUMBER()over(PARTITION by uno order by datea,noa,noq)recno from #z_cub_rkp03) b on a.sel=b.sel	
	--======================================================================================
	--計算成本  
	----(盤點的由人工輸入,故忽略)
	---- 進貨成本單價要依 TABLE SPRICE的資料來判斷
	update #z_cub_rkp03 set scost = ROUND(a.[weight]* case when c.uno is null then b.sprice else isnull(c.sprice,0) end,0)
	from #z_cub_rkp03 a
	left join view_uccb b on a.uno=b.uno
	outer apply(select top 1 * from sprice where b.tablea=tablea and a.uno=uno and a.datea>=datea order by datea desc) c
	where isnull(a.isucce,0)!=1

	--先計算不是領料組合的
--	declare @xuno nvarchar(30)
	declare @weight float --進貨、入庫重量
	declare @money float --進貨、入庫成本
	
--	declare @xweight float -- 領料重量
	declare @xcost float -- 領料成本
	declare @diff float
	
	declare @sel int
	declare @scost float
	
	declare cursor_table cursor for
	select uno,sum(isnull([weight],0)),sum(isnull(scost,0)) from #z_cub_rkp03 where isnull(isIna,0)!=1 group by uno
	open cursor_table
	fetch next from cursor_table
	into @xuno,@xweight,@xcost
	while(@@FETCH_STATUS <> -1)
	begin
		select @weight=0,@money = 0
		if exists(select top 1 * from view_rc2s where uno=@xuno)
		begin
			select @weight=SUM( case when b.typea='1' then 1 else -1 end * isnull(a.[weight],0)) 
				,@money=SUM( case when b.typea='1' then 1 else -1 end * isnull(a.total,0)) 
			from view_rc2s a 
			left join view_rc2 b on a.accy=b.accy and a.noa=b.noa
			where a.uno=@xuno
		end
		else if exists(select top 1 * from view_inas where uno=@xuno)
		begin
			select @weight=SUM( isnull(a.[weight],0)) ,@money=SUM( isnull(a.total,0)) 
			from view_inas a 
			where a.uno=@xuno
		end
		else if exists(select top 1 * from view_cuts where bno=@xuno)
		begin
			select @weight=SUM( isnull(a.[weight],0)) 
				--,@money=SUM( round(isnull(a.[weight],0)*sprice,0)) 
				,@money=SUM(isnull(a.total,0)) 
			from view_cuts a 
			where a.bno=@xuno
		end
		--假如還有庫存就不需要調整金額
		if @xweight>=@weight
		begin
			--找最後一筆調整金額
			set @diff = @xcost - isnull(@money,0)

			if @diff!=0
			begin
				declare cursor_table2 cursor for
				select sel,scost from #z_cub_rkp03 where uno=@xuno order by recno desc
				open cursor_table2
				fetch next from cursor_table2
				into @sel,@scost
				while(@@FETCH_STATUS <> -1)
				begin
					if @diff<0
					begin
						update #z_cub_rkp03 set scost=@scost-@diff where sel=@sel
						set @diff = 0
						break
					end
					else 
					begin
						if @scost>=@diff
						begin
							update #z_cub_rkp03 set scost=@scost-@diff where sel=@sel
							set @diff = 0
							break
						end
						else
						begin
							update #z_cub_rkp03 set scost=0 where sel=@sel
							set @diff = @diff - @scost
						end
					end
					fetch next from cursor_table2
					into @sel,@scost
				end
				close cursor_table2
				deallocate cursor_table2
				
				if @diff!=0
				begin
					insert into @tmp(uno,msg)values(@xuno,' 尾差 '+ cast(@diff as nvarchar))
					--print @xuno +' 尾差 '+ cast(@diff as nvarchar)
					--select @xuno +' 尾差 '+ cast(@diff as nvarchar)
				end
			end
		end
		
		fetch next from cursor_table
		into @xuno,@xweight,@xcost
	end
	close cursor_table
	deallocate cursor_table

	--計算領料組合的  (之後回寫到入庫單)
	declare @tmpd table(
		sel int identity(1,1)
		,accy nvarchar(10)
		,noa nvarchar(20)
		,noq nvarchar(10)
		,uno nvarchar(30)
		,[money] float
	)
	declare @accy nvarchar(10)
	declare @noa nvarchar(20)
	declare @noq nvarchar(10)
	declare @n int = 10
	
	while @n > 0
	begin
		declare cursor_table cursor for
		select a.uno 
		from #z_cub_rkp03 a
		left join @tmpd b on a.uno=b.uno
		where b.uno is null and a.isIna=1 
		group by a.uno
		open cursor_table
		fetch next from cursor_table
		into @xuno
		while(@@FETCH_STATUS <> -1)
		begin
			select @accy='',@noa = '',@noq='',@money=0
			select @accy=a.accy,@noa = b.noa,@noq=a.noq 
			from view_inas a
			left join view_get b on a.noa=b.noa
			where a.uno=@xuno and b.noa is not null 
			
			select @money=SUM(ISNULL(scost,0)) from #z_cub_rkp03 where tablea='gets' and noa=@noa
			insert into @tmpd(accy,noa,noq,uno,[money])
			select @accy,@noa,@noq,@xuno,@money

			fetch next from cursor_table
			into @xuno
		end
		close cursor_table
		deallocate cursor_table
		set @n = @n - 1
	end
	---- 回寫ina total
	declare cursor_table cursor for
	select accy,noa,noq,[money] from @tmpd
	open cursor_table
	fetch next from cursor_table
	into @accy,@noa,@noq,@money
	while(@@FETCH_STATUS <> -1)
	begin
		set @cmd =  
		"update inas"+@accy+" set total=@money,price=case when isnull([weight],0)=0 then 0 else round(@money/[weight],5) end
		where noa=@noa and noq=@noq"
		execute sp_executesql @cmd,N'@noa nvarchar(20),@noq nvarchar(10),@money float'
			,@noa=@noa,@noq=@noq,@money=@money
		fetch next from cursor_table
		into @accy,@noa,@noq,@money
	end
	close cursor_table
	deallocate cursor_table
	--------------------------------------------------------------------------------------------------------------
	-- 計算領料組合的
	declare cursor_table cursor for
	select uno,sum(isnull([weight],0)),sum(isnull(scost,0)) from #z_cub_rkp03 where isnull(isIna,0)=1 group by uno
	open cursor_table
	fetch next from cursor_table
	into @xuno,@xweight,@xcost
	while(@@FETCH_STATUS <> -1)
	begin
		select @weight=0,@money = 0
		if exists(select top 1 * from view_rc2s where uno=@xuno)
		begin
			select @weight=SUM( case when b.typea='1' then 1 else -1 end * isnull(a.[weight],0)) 
				,@money=SUM( case when b.typea='1' then 1 else -1 end * isnull(a.total,0)) 
			from view_rc2s a 
			left join view_rc2 b on a.accy=b.accy and a.noa=b.noa
			where a.uno=@xuno
		end
		else if exists(select top 1 * from view_inas where uno=@xuno)
		begin
			select @weight=SUM( isnull(a.[weight],0)) ,@money=SUM( isnull(a.total,0)) 
			from view_inas a 
			where a.uno=@xuno
		end
		else if exists(select top 1 * from view_cuts where bno=@xuno)
		begin
			select @weight=SUM( isnull(a.[weight],0)) ,@money=SUM(isnull(a.total,0)) 
			from view_cuts a 
			where a.bno=@xuno
		end
		--假如還有庫存就不需要調整金額
		if @xweight>=@weight
		begin
			--找最後一筆調整金額
			set @diff = @xcost - isnull(@money,0)

			if @diff!=0
			begin
				declare cursor_table2 cursor for
				select sel,scost from #z_cub_rkp03 where uno=@xuno order by recno desc
				open cursor_table2
				fetch next from cursor_table2
				into @sel,@scost
				while(@@FETCH_STATUS <> -1)
				begin
					if @diff<0
					begin
						update #z_cub_rkp03 set scost=@scost-@diff where sel=@sel
						set @diff = 0
						break
					end
					else 
					begin
						if @scost>=@diff
						begin
							update #z_cub_rkp03 set scost=@scost-@diff where sel=@sel
							set @diff = 0
							break
						end
						else
						begin
							update #z_cub_rkp03 set scost=0 where sel=@sel
							set @diff = @diff - @scost
						end
					end
					fetch next from cursor_table2
					into @sel,@scost
				end
				close cursor_table2
				deallocate cursor_table2
				
				if @diff!=0
				begin
					insert into @tmp(uno,msg)values(@xuno,' 尾差 '+ cast(@diff as nvarchar))
					--print @xuno +' 尾差 '+ cast(@diff as nvarchar)
					--select @xuno +' 尾差 '+ cast(@diff as nvarchar)
				end
			end
		end
		
		fetch next from cursor_table
		into @xuno,@xweight,@xcost
	end
	close cursor_table
	deallocate cursor_table
	-----------------------------------------------------------------------
	-- 更新資料  回寫到各TABLE
	-----------------------------------------------------------------------
	declare cursor_table cursor for
	select accy from #z_cub_rkp03 group by accy
	open cursor_table
	fetch next from cursor_table
	into @accy	
	while(@@FETCH_STATUS <> -1)
	begin
		--vccs
		set @cmd =
		"update vccs"+@accy+" set scost=b.scost
		from vccs"+@accy+" a
		left join #z_cub_rkp03 b on b.tablea='vccs' and b.accy=@accy and a.noa=b.noa and a.noq=b.noq
		where b.noa is not null"
		execute sp_executesql @cmd,N'@accy nvarchar(10),@noa nvarchar(20),@noq nvarchar(10)'
			,@accy=@accy,@noa=@noa,@noq=@noq
		--gets
		set @cmd =
		"update gets"+@accy+" set scost=b.scost
		from gets"+@accy+" a
		left join #z_cub_rkp03 b on b.tablea='gets' and b.accy=@accy and a.noa=b.noa and a.noq=b.noq 
		where b.noa is not null"
		execute sp_executesql @cmd,N'@accy nvarchar(10),@noa nvarchar(20),@noq nvarchar(10)'
			,@accy=@accy,@noa=@noa,@noq=@noq
		--cubt
		set @cmd =
		"update cubt"+@accy+" set scost=b.scost
		from cubt"+@accy+" a
		left join #z_cub_rkp03 b on b.tablea='cubt' and b.accy=@accy and a.noa=b.noa and a.noq=b.noq 
		where b.noa is not null"
		execute sp_executesql @cmd,N'@accy nvarchar(10),@noa nvarchar(20),@noq nvarchar(10)'
			,@accy=@accy,@noa=@noa,@noq=@noq
		
		fetch next from cursor_table
		into @accy
	end
	close cursor_table
	deallocate cursor_table
	-----------------------------------------------------------------------------------------------
	--=============================================================================================
	-- 計算在製品成本  CUBS
	IF OBJECT_ID('tempdb..#z_cub_rkp03_cubs')is not null
	BEGIN
		drop table #z_cub_rkp03_cubs
	END
	create table #z_cub_rkp03_cubs(
		sel int identity(1,1)
		,accy nvarchar(10)
		,noa nvarchar(20)
		,noq nvarchar(10)
		,makeno nvarchar(20)		
		
		,cubs float        --鋼捲成本
		,cubs_weight float --鋼捲重量
		,cubs_length float --鋼捲長度
		
		,pvc float         --皮膜成本
		,pvc_weight float  --皮膜重量
		
		,pve float         --保護膜成本
		,pve_weight float  --保護膜重量
		
		,A01 float         --物料成本
		,A01_weight float  --物料重量
		,A02 float         
		,A02_weight float
		,A03 float         
		,A03_weight float
		,A04 float         
		,A04_weight float
		,A05 float         
		,A05_weight float  
		
		,w01 float --直接人工
		,w02 float --製造費用
		,w04 float --電費
		,w05 float --瓦斯費
		
		,tweight float
		,total float
	)
	--鋼捲
	insert into #z_cub_rkp03_cubs(accy,noa,noq,makeno,cubs,cubs_weight,cubs_length,w01,w02,w04,w05)
	select a.accy,a.noa,a.noq,a.makeno,c.scost,a.[weight],a.w09,a.w01,a.w02,a.w04,a.w05
	from view_cubs a 
	left join view_cub b on a.accy=b.accy and a.noa=b.noa
	left join view_gets c on a.accy=c.accy and a.noa=c.noa and a.noq=c.noq
	where b.datea between @bdate and @edate
	--皮膜
	update #z_cub_rkp03_cubs set pvc=b.scost
		,pvc_weight = b.[weight]
	from #z_cub_rkp03_cubs a
	outer apply(select SUM(isnull([wweight],0)) [weight],SUM(isnull([scost],0)) scost 
		from view_cubt where accy=a.accy and noa=a.noa and nor=a.noq and kind='1') b
	--保護膜
	update #z_cub_rkp03_cubs set pve= b.scost
		,pve_weight = b.[weight]
	from #z_cub_rkp03_cubs a
	outer apply(select SUM(isnull([wweight],0)) [weight],SUM(isnull([scost],0)) scost 
		from view_cubt where accy=a.accy and noa=a.noa and nor=a.noq and kind='2') b
	--物料	
	declare @tmp_cubu table(
		sel int identity(1,1)
		,accy nvarchar(10)
		,noa nvarchar(20)
		,groupano nvarchar(20)
		,uno nvarchar(30)
		,[weight] float
		,scost float
	)
	declare @tmp_cubs_cubu table(
		sel int identity(1,1)
		,accy nvarchar(10)
		,noa nvarchar(20)
		,noq nvarchar(10)
		,[length] float 
		,cubu_sel int
		,groupano nvarchar(20)
		,[weight] float
		,scost float
	)
	declare @length float
	declare @tlength float
	
	declare cursor_table cursor for
	select accy,noa,sum(isnull([cubs_length],0))
	from #z_cub_rkp03_cubs
	group by accy,noa
	open cursor_table
	fetch next from cursor_table
	into @accy,@noa,@tlength
	while(@@FETCH_STATUS <> -1)
	begin
		insert into @tmp_cubu(accy,noa,groupano,uno,[weight],scost)
		select a.accy,a.noa,c.groupano,a.ucolor,a.[weight],b.scost
		from view_cubu a
		left join view_gets b on a.accy=b.accy and a.noa=b.noa and a.ucolor=b.uno
		left join ucc c on a.productno=c.noa
		where a.accy=@accy and a.noa=@noa
		
		insert into @tmp_cubs_cubu(accy,noa,noq,[length],cubu_sel,groupano,[weight],scost)
		select a.accy,a.noa,a.noq,a.cubs_length,b.sel,b.groupano
			,case when ISNULL(@tlength,0)!=0 then round(b.[weight]*a.cubs_length/@tlength,2) else 0 end
			,case when ISNULL(@tlength,0)!=0 then round(b.[scost]*a.cubs_length/@tlength,0) else 0 end
		from #z_cub_rkp03_cubs a
		left join @tmp_cubu b on a.accy=b.accy and a.noa=b.noa 
		where a.accy=@accy and a.noa=@noa
		order by a.accy,a.noa,a.noq

		fetch next from cursor_table
		into @accy,@noa,@tlength
	end
	close cursor_table
	deallocate cursor_table	
	--物料 尾差修正
	declare @sel2 int
	declare @weight2 float
	declare @scost2 float
	
	declare cursor_table cursor for
	select sel,[weight],scost from @tmp_cubu
	open cursor_table
	fetch next from cursor_table
	into @sel,@weight,@scost
	while(@@FETCH_STATUS <> -1)
	begin
		select @weight2=0,@scost2=0
		select @weight2=SUM(ISNULL([weight],0)),@scost2=SUM(ISNULL([scost],0))
		from @tmp_cubs_cubu where cubu_sel=@sel
		
		--尾差都由最後一筆修正
		update @tmp_cubs_cubu set [weight]=round(b.[weight] + @weight - @weight2,2)
			,scost = b.scost + @scost - @scost2
		from @tmp_cubs_cubu a
		outer apply(select top 1 * from @tmp_cubs_cubu where cubu_sel=@sel order by sel desc) b
		where a.sel=b.sel

		fetch next from cursor_table
		into @sel,@weight,@scost
	end
	close cursor_table
	deallocate cursor_table	
	
	 update #z_cub_rkp03_cubs set A01 = b.A01,A01_weight=b.A01_weight
		,A02 = b.A02,A02_weight=b.A02_weight
		,A03 = b.A03,A03_weight=b.A03_weight
		,A04 = b.A04,A04_weight=b.A04_weight
		,A05 = b.A05,A05_weight=b.A05_weight
	 from #z_cub_rkp03_cubs a
	 left join (select accy,noa,noq
		,SUM(case when groupano='A01' then isnull([scost],0) else 0 end) A01
		,SUM(case when groupano='A01' then isnull([weight],0) else 0 end) A01_weight
		,SUM(case when groupano='A02' then isnull([scost],0) else 0 end) A02
		,SUM(case when groupano='A02' then isnull([weight],0) else 0 end) A02_weight
		,SUM(case when groupano='A03' then isnull([scost],0) else 0 end) A03
		,SUM(case when groupano='A03' then isnull([weight],0) else 0 end) A03_weight
		,SUM(case when groupano='A04' then isnull([scost],0) else 0 end) A04
		,SUM(case when groupano='A04' then isnull([weight],0) else 0 end) A04_weight
		,SUM(case when groupano='A05' then isnull([scost],0) else 0 end) A05
		,SUM(case when groupano='A05' then isnull([weight],0) else 0 end) A05_weight
		from @tmp_cubs_cubu group by accy,noa,noq) b on a.accy=b.accy and a.noa=b.noa and a.noq=b.noq
	where b.noa is not null
	
	update #z_cub_rkp03_cubs set tweight = round(ISNULL(cubs_weight,0) + ISNULL(pvc_weight,0) + ISNULL(pve_weight,0) 
		+ ISNULL(A01_weight,0) + ISNULL(A02_weight,0) + ISNULL(A03_weight,0) + ISNULL(A04_weight,0) + ISNULL(A05_weight,0),2)
		,total = ISNULL(cubs,0) + ISNULL(pvc,0) + ISNULL(pve,0) 
		+ ISNULL(A01,0) + ISNULL(A02,0) + ISNULL(A03,0) + ISNULL(A04,0) + ISNULL(A05,0)
		+ ISNULL(w01,0) + ISNULL(w02,0) + ISNULL(w04,0) + ISNULL(w05,0)
	-----------------------------------------------------------------------
	-- 更新資料  回寫到CUBS
	-----------------------------------------------------------------------	
	declare cursor_table cursor for
	select accy from #z_cub_rkp03_cubs group by accy
	open cursor_table
	fetch next from cursor_table
	into @accy	
	while(@@FETCH_STATUS <> -1)
	begin
		set @cmd =
		"update cubs"+@accy+" set [total] = b.total,w03=b.tweight
			,x01 = b.cubs_weight
			,x02 = b.pvc_weight
			,x03 = b.pve_weight
			,x04 = b.A01_weight
			,x05 = b.A02_weight
			,x06 = b.A03_weight
			,x07 = b.A04_weight
			,x08 = b.A05_weight
			,y01 = b.cubs
			,y02 = b.pvc
			,y03 = b.pve
			,y04 = b.A01
			,y05 = b.A02
			,y06 = b.A03
			,y07 = b.A04
			,y08 = b.A05
		from cubs"+@accy+" a
		left join #z_cub_rkp03_cubs b on @accy=b.accy and a.noa=b.noa and a.noq=b.noq
		where b.noa is not null"
		execute sp_executesql @cmd,N'@accy nvarchar(10)',@accy=@accy
		
		fetch next from cursor_table
		into @accy
	end
	close cursor_table
	deallocate cursor_table
	-----------------------------------------------------------------------
	-- 計算 樣品、報廢
	-----------------------------------------------------------------------	
	-- 計算在製品成本  CUCS
	IF OBJECT_ID('tempdb..#z_cub_rkp03_cucs')is not null
	BEGIN
		drop table #z_cub_rkp03_cucs
	END
	create table #z_cub_rkp03_cucs(
		sel int identity(1,1)
		
		,accy nvarchar(10) 
		,noa nvarchar(20)
		,noq nvarchar(10)
		,makeno nvarchar(20)
		,price float   		
		
		,weight6 float  -- 樣品重
		,weight7 float  -- 報廢重
		,weight11 float -- 盤盈
		,template_money float
		,waste_money float
		,surplus_money float
	)
	
	insert into #z_cub_rkp03_cucs(accy,noa,noq,makeno,weight6,weight7,weight11)
	select a.accy,a.noa,a.noq,a.cubno,a.weight6,a.weight7,a.weight11
	from view_cucs a
	left join view_cuc b on a.accy=b.accy and a.noa=b.noa
	where 1=1
	and b.datea between @bdate and @edate	
	and not(ISNULL(a.weight6,0)=0 and ISNULL(a.weight7,0)=0 and ISNULL(a.weight11,0)=0)
	
	declare @tmpCubs table(
		sel int identity(1,1)
		,makeno nvarchar(20)
		,[weight] float  --用完工重量計算
		,total float
		,price float
	)
	--計算原物料單位成本
	insert into @tmpCubs(makeno,[weight],total,price)
	select a.makeno ,a.hweight,a.total,case when ISNULL(a.hweight,0)=0 then 0 else ROUND(ISNULL(a.total,0)/a.hweight,2) end
	from view_cubs a
	left join (select makeno from #z_cub_rkp03_cucs group by makeno) b on a.makeno=b.makeno
	where b.makeno is not null
	--推算出樣品、報廢成本,        **成品成本= 原物料成本 - 樣品成本 - 報廢成本
	update #z_cub_rkp03_cucs set template_money = round(a.weight6 * b.price,0)
		,waste_money = ROUND(a.weight7*b.price,0)
		,surplus_money = ROUND(a.weight11*b.price,0)
	from #z_cub_rkp03_cucs a
	left join @tmpCubs b on a.makeno=b.makeno
	-----資料回寫
	declare cursor_table cursor for
	select accy from #z_cub_rkp03_cucs group by accy
	open cursor_table
	fetch next from cursor_table
	into @accy	
	while(@@FETCH_STATUS <> -1)
	begin
		set @cmd =
		"update cucs"+@accy+" set m02=b.template_money,m03=b.waste_money,m04=b.surplus_money
		from cucs"+@accy+" a
		left join #z_cub_rkp03_cucs b on b.accy=@accy and a.noa=b.noa and a.noq=b.noq
		where b.noa is not null"
		execute sp_executesql @cmd,N'@accy nvarchar(20)',@accy=@accy
		
		fetch next from cursor_table
		into @accy
	end
	close cursor_table
	deallocate cursor_table
	
	-------------------------------------------------------------------------------------
	---- 計算成品的金額
	declare @tmpCuts table(
		sel int identity(1,1)
		,accy nvarchar(10)
		,noa nvarchar(20)
		,noq nvarchar(10)
		,makeno nvarchar(20)
		,[weight] float --入庫重量 
		,cost float 
	)
	insert into @tmpCuts(accy,noa,noq,makeno,[weight])
	select a.accy,a.noa,a.noq,a.cname,a.[weight]
	from view_cuts a
	left join view_cut b on a.accy=b.accy and a.noa=b.noa
	where b.datea between @bdate and @edate
	and len(ISNULL(a.cname,'')) > 0
	
	-------------------------------------------------------------------------------------------------------
	set @n=0
	select @n=count(1) from #z_cub_rkp03
	drop table #z_cub_rkp03
	insert into @tmp(uno,msg)values('','共計算 '+CAST(ISNULL(@n,0) as nvarchar)+' 筆資料')
	select * from @tmp;
	
z_cub_rkp01:--z_cub_rkp01  費用攤提
	SET QUOTED_IDENTIFIER OFF 
	declare @cmd nvarchar(max)
	declare @t_path nvarchar(max) = '[1]'
	declare @t_db nvarchar(max) = '[2]'
	
	declare @t_mon nvarchar(max) = case when '#non' = [3] then '' else [3] end
	--------------------------------------------------------------------------------------------------
	declare @money01 float = 0 --人工費用
	declare @money02 float = 0 --製造費用
	declare @money03 float = 0 --電費
	declare @money04 float = 0 --瓦斯費
	
	declare @tmins float = 0
	declare @tmoney01 float=0
	declare @tmoney02 float=0
	declare @tmoney03 float=0
	declare @tmoney04 float=0
	
	declare @sel int
	declare @m01 float
	declare @m02 float
	declare @m03 float
	declare @m04 float
	--生產  CUB
	select @money01=0,@money02=0,@money03=0,@money04=0
	select @money01=price1,@money02=price2,@money03=price3,@money04=price4 from costa where mon=@t_mon
	
	IF OBJECT_ID('tempdb..#z_cub_rkp04a')is not null
	BEGIN
		drop table #z_cub_rkp04a
	END
	create table #z_cub_rkp04a (
		sel int identity(1,1)
		,tablea nvarchar(20)
		,datea nvarchar(20)
		,accy nvarchar(10)
		,noa nvarchar(20)
		,noq nvarchar(10)
		,mins float
		,money01 float
		,money02 float
		,money03 float
		,money04 float
	)
	insert into #z_cub_rkp04a(tablea,datea,accy,noa,noq,mins)
	select 'cubs',b.datea,a.accy,a.noa,a.noq,isnull(a.mins,0)
	from view_cubs a
	left join view_cub b on a.noa=b.noa
	where left(b.datea,6)=@t_mon
	and isnull(a.mins,0)!=0
	order by a.accy,a.noa,a.noq
	
	set @tmins = 0
	select @tmins = sum(mins) from #z_cub_rkp04a
	
	if ISNULL(@tmins,0)>0
	begin
		update #z_cub_rkp04a set money01 = round(@money01*mins/@tmins,0)
			,money02 = round(@money02*mins/@tmins,0)
			,money03 = round(@money03*mins/@tmins,0)
			,money04 = round(@money04*mins/@tmins,0)
	end
	
	--尾差由最後一筆攤提,但金額最多扣到0
	select @tmoney01=0,@tmoney02=0,@tmoney03=0,@tmoney04=0
	select @tmoney01=SUM(money01),@tmoney02=SUM(money02),@tmoney03=SUM(money03),@tmoney04=SUM(money04) from #z_cub_rkp04a

	set @tmoney01 = ISNULL(@tmoney01,0) - @money01
	set @tmoney02 = ISNULL(@tmoney02,0) - @money02
	set @tmoney03 = ISNULL(@tmoney03,0) - @money03
	set @tmoney04 = ISNULL(@tmoney04,0) - @money04
		
	declare cursor_table cursor for
	select sel,money01,money02,money03,money04 from #z_cub_rkp04a order by datea,noa,noq
	open cursor_table
	fetch next from cursor_table
	into @sel,@m01,@m02,@m03,@m04
	while(@@FETCH_STATUS <> -1)
	begin	
		if @m01 > 0 and @m01 >= @tmoney01
		begin
			update #z_cub_rkp04a set money01 = money01 - @tmoney01 where sel = @sel
			set @tmoney01 = 0
		end 
		else if @m01 > 0 and @m01 < @tmoney01
		begin
			update #z_cub_rkp04a set money01 = 0 where sel = @sel
			set @tmoney01 = @tmoney01 - @m01
		end
		
		if @m02 > 0 and @m02 >= @tmoney02
		begin
			update #z_cub_rkp04a set money02 = money02 - @tmoney02 where sel = @sel
			set @tmoney02 = 0
		end 
		else if @m02 > 0 and @m02 < @tmoney02
		begin
			update #z_cub_rkp04a set money02 = 0 where sel = @sel
			set @tmoney02 = @tmoney02 - @m02
		end
		
		if @m03 > 0 and @m03 >= @tmoney03
		begin
			update #z_cub_rkp04a set money03 = money03 - @tmoney03 where sel = @sel
			set @tmoney02 = 0
		end 
		else if @m03 > 0 and @m03 < @tmoney03
		begin
			update #z_cub_rkp04a set money03 = 0 where sel = @sel
			set @tmoney03 = @tmoney03 - @m03
		end
		
		if @m04 > 0 and @m04 >= @tmoney04
		begin
			update #z_cub_rkp04a set money04 = money04 - @tmoney04 where sel = @sel
			set @tmoney04 = 0
		end 
		else if @m04 > 0 and @m04 < @tmoney04
		begin
			update #z_cub_rkp04a set money04 = 0 where sel = @sel
			set @tmoney04 = @tmoney04 - @m04
		end
		
		if @tmoney01=0 and @tmoney02=0 and @tmoney03=0 and @tmoney04=0
		begin
			break
		end
		
		fetch next from cursor_table
		into @sel,@m01,@m02,@m03,@m04
	end
	close cursor_table
	deallocate cursor_table
	-----------------------------------------------------------------------
	--裁切  CUC
	select @money01=0,@money02=0,@money03=0,@money04=0
	select @money01=price5,@money02=price6,@money03=price7,@money04=price8 from costa where mon=@t_mon
	
	IF OBJECT_ID('tempdb..#z_cub_rkp04b')is not null
	BEGIN
		drop table #z_cub_rkp04b
	END
	create table #z_cub_rkp04b(
		sel int identity(1,1)
		,tablea nvarchar(20)
		,datea nvarchar(20)
		,accy nvarchar(10)
		,noa nvarchar(20)
		,noq nvarchar(10)
		,mins float
		,money01 float
		,money02 float
		,money03 float
		,money04 float
	)
	insert into #z_cub_rkp04b(tablea,datea,accy,noa,noq,mins)
	select 'cucs',b.datea,a.accy,a.noa,a.noq,isnull(a.mins,0)
	from view_cucs a
	left join view_cuc b on a.noa=b.noa
	where left(b.datea,6)=@t_mon
	and isnull(a.mins,0)!=0
	order by a.accy,a.noa,a.noq
	
	set @tmins = 0
	select @tmins = sum(mins) from #z_cub_rkp04b
	
	if ISNULL(@tmins,0)>0
	begin
		update #z_cub_rkp04b set money01 = round(@money01*mins/@tmins,0)
			,money02 = round(@money02*mins/@tmins,0)
			,money03 = round(@money03*mins/@tmins,0)
			,money04 = round(@money04*mins/@tmins,0)
	end
	
	--尾差由最後一筆攤提,但金額最多扣到0
	select @tmoney01=0,@tmoney02=0,@tmoney03=0,@tmoney04=0
	select @tmoney01=SUM(money01),@tmoney02=SUM(money02),@tmoney03=SUM(money03),@tmoney04=SUM(money04) from #z_cub_rkp04b

	set @tmoney01 = ISNULL(@tmoney01,0) - @money01
	set @tmoney02 = ISNULL(@tmoney02,0) - @money02
	set @tmoney03 = ISNULL(@tmoney03,0) - @money03
	set @tmoney04 = ISNULL(@tmoney04,0) - @money04
		
	declare cursor_table cursor for
	select sel,money01,money02,money03,money04 from #z_cub_rkp04b order by datea,noa,noq
	open cursor_table
	fetch next from cursor_table
	into @sel,@m01,@m02,@m03,@m04
	while(@@FETCH_STATUS <> -1)
	begin	
		if @m01 > 0 and @m01 >= @tmoney01
		begin
			update #z_cub_rkp04b set money01 = money01 - @tmoney01 where sel = @sel
			set @tmoney01 = 0
		end 
		else if @m01 > 0 and @m01 < @tmoney01
		begin
			update #z_cub_rkp04b set money01 = 0 where sel = @sel
			set @tmoney01 = @tmoney01 - @m01
		end
		
		if @m02 > 0 and @m02 >= @tmoney02
		begin
			update #z_cub_rkp04b set money02 = money02 - @tmoney02 where sel = @sel
			set @tmoney02 = 0
		end 
		else if @m02 > 0 and @m02 < @tmoney02
		begin
			update #z_cub_rkp04b set money02 = 0 where sel = @sel
			set @tmoney02 = @tmoney02 - @m02
		end
		
		if @m03 > 0 and @m03 >= @tmoney03
		begin
			update #z_cub_rkp04b set money03 = money03 - @tmoney03 where sel = @sel
			set @tmoney02 = 0
		end 
		else if @m03 > 0 and @m03 < @tmoney03
		begin
			update #z_cub_rkp04b set money03 = 0 where sel = @sel
			set @tmoney03 = @tmoney03 - @m03
		end
		
		if @m04 > 0 and @m04 >= @tmoney04
		begin
			update #z_cub_rkp04b set money04 = money04 - @tmoney04 where sel = @sel
			set @tmoney04 = 0
		end 
		else if @m04 > 0 and @m04 < @tmoney04
		begin
			update #z_cub_rkp04b set money04 = 0 where sel = @sel
			set @tmoney04 = @tmoney04 - @m04
		end
		
		if @tmoney01=0 and @tmoney02=0 and @tmoney03=0 and @tmoney04=0
		begin
			break
		end
		
		fetch next from cursor_table
		into @sel,@m01,@m02,@m03,@m04
	end
	close cursor_table
	deallocate cursor_table
	
	-- UPDATE DATA
	declare @table nvarchar(20)
	declare @accy nvarchar(20)
	declare cursor_table cursor for
	select tablea,accy from #z_cub_rkp04a group by tablea,accy
	open cursor_table
	fetch next from cursor_table
	into @table,@accy
	while(@@FETCH_STATUS <> -1)
	begin
		set @cmd=
		"update "+@table+@accy+" set w01=b.money01,w02=b.money02,w04=b.money03,w05=b.money04
		from "+@table+@accy+" a
		left join #z_cub_rkp04a b on b.tablea=@table and b.accy=@accy and a.noa=b.noa and a.noq=b.noq
		where b.noa is not null"
		execute sp_executesql @cmd,N'@table nvarchar(20),@accy nvarchar(10)',@table=@table,@accy=@accy

		fetch next from cursor_table
		into @table,@accy
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select tablea,accy from #z_cub_rkp04b group by tablea,accy
	open cursor_table
	fetch next from cursor_table
	into @table,@accy
	while(@@FETCH_STATUS <> -1)
	begin
		set @cmd=
		"update "+@table+@accy+" set w01=b.money01,w02=b.money02,w04=b.money03,w05=b.money04
		from "+@table+@accy+" a
		left join #z_cub_rkp04b b on b.tablea=@table and b.accy=@accy and a.noa=b.noa and a.noq=b.noq
		where b.noa is not null"
		execute sp_executesql @cmd,N'@table nvarchar(20),@accy nvarchar(10)',@table=@table,@accy=@accy

		fetch next from cursor_table
		into @table,@accy
	end
	close cursor_table
	deallocate cursor_table
	
	drop table #z_cub_rkp04a
	drop table #z_cub_rkp04b
	select '0' gno, '結轉完成!' msg;